{% extends "base.html" %}
{% block content %}
<div class="container py-4">
    <!-- Modal de selección de sucursal -->
    <div class="modal fade" id="modalSucursal" tabindex="-1" aria-labelledby="modalSucursalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalSucursalLabel">Escoge la sucursal</h5>
          </div>
          <div class="modal-body">
            <form id="form-sucursal-modal">
                <label class="form-label">Selecciona tu sucursal:</label>
                <select class="form-select" id="select-sucursal-modal" required>
                    <option value="">Selecciona una sucursal</option>
                    {% for s in sucursales %}
                        <option value="{{ s.id }}">{{ s.nombre }}</option>
                    {% endfor %}
                </select>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-success" id="btnElegirSucursal">Continuar</button>
          </div>
        </div>
      </div>
    </div>
    <h2 class="mb-4" style="color:var(--pozoleria-orange);">Menú</h2>
    <form id="form-sucursal" class="mb-4" style="display:none;">
        <label class="form-label">Escoge tu sucursal:</label>
        <select class="form-select w-auto d-inline-block" id="select-sucursal" name="sucursal_id" required onchange="filtrarPorSucursal()">
            <option value="">Selecciona una sucursal</option>
            {% for s in sucursales %}
                <option value="{{ s.id }}">{{ s.nombre }}</option>
            {% endfor %}
        </select>
    </form>
    <div class="row" id="productos-lista">
        {% for p in productos %}
        <div class="col-md-4 mb-4 producto-item" data-sucursales="{{ p.sucursales|join(',') }}">
            <div class="card h-100 shadow-sm producto-card" data-producto-id="{{ p.id }}" style="cursor:pointer;">
                {% if p.imagen %}
                <img src="{{ p.imagen }}" class="card-img-top" alt="{{ p.nombre }}">
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ p.nombre }}</h5>
                    <p class="card-text">{{ p.descripcion }}</p>
                    <div class="mb-2">
                        <span class="fw-bold text-success" style="font-size:1.2em;">
                            {% if p.precio is defined and p.precio is not none and p.precio != '' %}
                                ${{ "%.2f"|format(p.precio|float) }}
                            {% else %}
                                <span class="text-muted">Sin precio</span>
                            {% endif %}
                        </span>
                    </div>
                    <button class="btn btn-agregar-menu w-100 mt-auto agregar-btn" onclick="mostrarModal({{ p.id }});event.stopPropagation();">
                        <span class="agregar-text">Agregar</span>
                        <span class="agregar-icon"><i class="bi bi-cart-plus-fill"></i></span>
                        <span class="agregar-ripple"></span>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <!-- Modal para personalizar producto -->
    <div class="modal fade" id="modalProducto" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-body p-0">
            <div class="row g-0">
              <div class="col-md-5 d-flex align-items-center justify-content-center" id="modal-img-container">
                <!-- Imagen del producto -->
              </div>
              <div class="col-md-7 p-4">
                <h3 id="modal-nombre"></h3>
                <form id="form-personalizar" method="post" action="{{ url_for('agregar_carrito') }}">
                  <input type="hidden" name="producto_id" id="modal-producto-id">
                  <div id="modal-opciones"></div>
                  <div class="mt-3">
                    <label class="form-label">Cantidad:</label>
                    <div class="input-group mb-2" style="max-width:160px;">
                        <button type="button" class="btn btn-outline-success" id="btn-restar-cantidad">
                            <i class="bi bi-dash-circle"></i>
                        </button>
                        <input class="form-control text-center fw-bold" type="number" name="cantidad" id="input-cantidad" value="1" min="1" style="font-size:1.3em;">
                        <button type="button" class="btn btn-outline-success" id="btn-sumar-cantidad">
                            <i class="bi bi-plus-circle"></i>
                        </button>
                    </div>
                  </div>
                  <div id="mensaje-obligatorio" class="alert alert-danger mt-2 text-center" style="display:none;font-size:1.1em;">
                    <i class="bi bi-exclamation-triangle-fill"></i> <strong>Debes seleccionar todas las opciones obligatorias.</strong>
                  </div>
                  <div class="mt-3 text-end d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-cancelar me-2" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-agregar" id="btn-agregar-carrito">
                        <span class="agregar-text">Agregar al carrito</span>
                        <span class="agregar-icon"><i class="bi bi-cart-plus-fill"></i></span>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Toast flotante para "Agregado al carrito" -->
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 2000;">
        <div id="toastCarrito" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi bi-cart-check-fill"></i> <strong>¡Agregado al carrito!</strong>
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
        </div>
    </div>
</div>
<style>
.btn-cancelar {
    background: linear-gradient(90deg, #ff5858 0%, #f09819 100%);
    color: #fff;
    font-weight: bold;
    border: none;
    box-shadow: 0 2px 8px rgba(255,88,88,0.15);
    transition: box-shadow 0.2s, background 0.2s;
}
.btn-cancelar:hover, .btn-cancelar:focus {
    background: linear-gradient(90deg, #f09819 0%, #ff5858 100%);
    box-shadow: 0 4px 16px rgba(255,88,88,0.25);
    color: #fff;
}
.btn-agregar {
    background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
    color: #fff;
    font-weight: bold;
    border: none;
    box-shadow: 0 2px 8px rgba(67,233,123,0.15);
    position: relative;
    overflow: hidden;
    transition: box-shadow 0.2s, background 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}
.btn-agregar:hover, .btn-agregar:focus {
    background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
    box-shadow: 0 4px 16px rgba(67,233,123,0.25);
    color: #fff;
}
.btn-agregar-menu {
    background: linear-gradient(90deg, #ffb347 0%, #ffcc33 100%);
    color: #fff;
    font-weight: bold;
    border: none;
    position: relative;
    overflow: hidden;
    transition: box-shadow 0.2s, transform 0.2s;
    box-shadow: 0 2px 8px rgba(255,204,51,0.15);
    font-size: 1.2em;
    letter-spacing: 0.5px;
    border-radius: 30px;
    padding: 0.7em 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.btn-agregar-menu:hover, .btn-agregar-menu:focus {
    background: linear-gradient(90deg, #ffcc33 0%, #ffb347 100%);
    box-shadow: 0 4px 16px rgba(255,204,51,0.25);
    color: #fff;
    transform: scale(1.04);
}
.btn-agregar .agregar-icon, .btn-agregar-menu .agregar-icon {
    font-size: 1.3em;
    vertical-align: middle;
    transition: transform 0.2s;
}
.btn-agregar:active .agregar-icon, .btn-agregar-menu:active .agregar-icon {
    transform: scale(1.2) rotate(-10deg);
}
.agregar-btn .agregar-icon {
    margin-left: 8px;
    font-size: 1.3em;
    vertical-align: middle;
    transition: transform 0.2s;
}
.agregar-btn:active .agregar-icon {
    transform: scale(1.2) rotate(-10deg);
}
.agregar-btn .agregar-ripple {
    position: absolute;
    border-radius: 50%;
    transform: scale(0);
    animation: ripple 0.6s linear;
    background: rgba(56,249,215,0.3);
    pointer-events: none;
    width: 100px;
    height: 100px;
    left: 50%;
    top: 50%;
    z-index: 1;
}
.btn-agregar-menu .agregar-ripple {
    position: absolute;
    border-radius: 50%;
    transform: scale(0);
    animation: ripple 0.6s linear;
    background: rgba(255,204,51,0.3);
    pointer-events: none;
    width: 100px;
    height: 100px;
    left: 50%;
    top: 50%;
    z-index: 1;
}
@keyframes ripple {
    to {
        transform: scale(2.5);
        opacity: 0;
    }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.js"></script>
<script>
    // Opciones por producto cargadas desde backend
    var opcionesPorProducto = {
        {% for p in productos %}
        {{ p.id }}: {
            imagen: "{{ p.imagen }}",
            nombre: `{{ p.nombre|e }}`,
            precio: {{ p.precio|default(0)|float }},
            opciones: {{ p.opciones|tojson }}
        },
        {% endfor %}
    };

    function mostrarModal(id) {
        var producto = opcionesPorProducto[id];
        if (!producto) return;
        document.getElementById('modal-nombre').textContent = producto.nombre;
        document.getElementById('modal-producto-id').value = id;
        document.getElementById('modal-img-container').innerHTML = producto.imagen ? '<img src="' + producto.imagen + '" class="img-fluid rounded" style="max-height:300px;">' : '';
        var opcionesHtml = '';
        producto.opciones.forEach(function(op) {
            opcionesHtml += '<div class="mb-3">';
            opcionesHtml += '<div class="d-flex justify-content-between align-items-center">';
            opcionesHtml += '<label class="form-label"><strong>' + op.titulo + '</strong></label>';
            if (op.obligatorio) {
                opcionesHtml += '<span class="badge bg-success">Obligatorio</span>';
            } else {
                opcionesHtml += '<span class="badge bg-secondary">Opcional</span>';
            }
            opcionesHtml += '</div>';
            opcionesHtml += '<div class="text-muted mb-1" style="font-size:0.95em;">' + (op.tipo == "radio" ? "Seleccione 1" : "Seleccione al menos 1") + '</div>';
            op.opciones.forEach(function(opt, idx) {
                var inputType = op.tipo;
                var inputName = op.nombre + (inputType == "checkbox" ? "[]" : "");
                var inputId = op.nombre + "_" + idx;
                opcionesHtml += '<div class="form-check">';
                opcionesHtml += '<input class="form-check-input" type="' + inputType + '" name="' + inputName + '" id="' + inputId + '" value="' + opt + '">';
                opcionesHtml += '<label class="form-check-label" for="' + inputId + '">' + opt + '</label>';
                opcionesHtml += '</div>';
            });
            opcionesHtml += '</div>';
        });
        document.getElementById('modal-opciones').innerHTML = opcionesHtml;
        var modal = new bootstrap.Modal(document.getElementById('modalProducto'));
        modal.show();
    }

    function filtrarPorSucursal() {
        var sucursalId = document.getElementById('select-sucursal').value;
        var items = document.querySelectorAll('.producto-item');
        items.forEach(function(item) {
            var sucursales = item.getAttribute('data-sucursales').split(',');
            if (!sucursalId || sucursales.includes(sucursalId)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
        // Guarda la sucursal en localStorage para futuras visitas
        localStorage.setItem('sucursal_id', sucursalId);
    }
    // Helper para obtener el carrito de la sucursal actual
    function getSucursalId() {
        return localStorage.getItem('sucursal_id') || '';
    }
    function getCarritoSucursal() {
        var sucursalId = getSucursalId();
        var carritos = JSON.parse(localStorage.getItem('carritos_por_sucursal') || '{}');
        return carritos[sucursalId] || [];
    }
    function setCarritoSucursal(carrito) {
        var sucursalId = getSucursalId();
        var carritos = JSON.parse(localStorage.getItem('carritos_por_sucursal') || '{}');
        carritos[sucursalId] = carrito;
        localStorage.setItem('carritos_por_sucursal', JSON.stringify(carritos));
    }

    // Actualiza el header del carrito para la sucursal actual
    function actualizarCarritoHeader() {
        var carrito = getCarritoSucursal();
        var total = 0;
        var cantidad = 0;
        carrito.forEach(function(item) {
            cantidad += item.cantidad || 1;
            total += (item.precio || 0) * (item.cantidad || 1);
        });
        var cartCount = document.getElementById('cart-count');
        var cartTotal = document.getElementById('cart-total');
        if (cartCount) cartCount.textContent = cantidad;
        if (cartTotal) cartTotal.textContent = '$' + total.toFixed(2);
    }
    document.addEventListener('DOMContentLoaded', function() {
        var sucursalId = localStorage.getItem('sucursal_id');
        var selectSucursal = document.getElementById('select-sucursal');
        var formSucursal = document.getElementById('form-sucursal');
        if (!sucursalId) {
            var modal = new bootstrap.Modal(document.getElementById('modalSucursal'));
            modal.show();
            document.getElementById('btnElegirSucursal').onclick = function() {
                var sel = document.getElementById('select-sucursal-modal');
                if (sel.value) {
                    localStorage.setItem('sucursal_id', sel.value);
                    selectSucursal.value = sel.value;
                    formSucursal.style.display = '';
                    filtrarPorSucursal();
                    modal.hide();
                } else {
                    sel.classList.add('is-invalid');
                }
            };
        } else {
            selectSucursal.value = sucursalId;
            formSucursal.style.display = '';
            filtrarPorSucursal();
        }
        selectSucursal.onchange = function() {
            filtrarPorSucursal();
            actualizarCarritoHeader();
        };

        // Abrir modal al hacer click en cualquier parte del card
        document.querySelectorAll('.producto-card').forEach(function(card) {
            card.addEventListener('click', function(e) {
                // Evita abrir dos veces si el botón fue clickeado
                if (e.target.closest('.agregar-btn')) return;
                var id = card.getAttribute('data-producto-id');
                mostrarModal(id);
            });
        });

        // Ripple effect for "Agregar" button
        document.querySelectorAll('.agregar-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                var ripple = btn.querySelector('.agregar-ripple');
                if (ripple) {
                    ripple.style.left = (e.offsetX - 50) + 'px';
                    ripple.style.top = (e.offsetY - 50) + 'px';
                    ripple.classList.remove('show');
                    void ripple.offsetWidth;
                    ripple.classList.add('show');
                    setTimeout(function() {
                        ripple.classList.remove('show');
                    }, 600);
                }
            });
        });

        // Toast flotante "Agregado al carrito"
        var form = document.getElementById('form-personalizar');
        if (form) {
            form.onsubmit = function(e) {
                e.preventDefault();
                var valido = true;
                var opcionesObligatorias = document.querySelectorAll('#modal-opciones .badge.bg-success');
                opcionesObligatorias.forEach(function(badge) {
                    var group = badge.closest('.mb-3');
                    if (group) {
                        var inputs = group.querySelectorAll('input[type="checkbox"],input[type="radio"]');
                        var checked = Array.from(inputs).some(function(inp) { return inp.checked; });
                        if (!checked) {
                            valido = false;
                        }
                    }
                });
                var mensajeObligatorio = document.getElementById('mensaje-obligatorio');
                if (!valido) {
                    mensajeObligatorio.style.display = 'block';
                    setTimeout(function() {
                        mensajeObligatorio.style.display = 'none';
                    }, 2500);
                    return;
                } else {
                    mensajeObligatorio.style.display = 'none';
                }
                // Obtener datos del producto y cantidad
                var productoId = document.getElementById('modal-producto-id').value;
                var cantidad = parseInt(form.querySelector('[name="cantidad"]').value) || 1;
                var producto = opcionesPorProducto[productoId];
                var precio = producto && producto.precio ? parseFloat(producto.precio) : 0;
                var carrito = getCarritoSucursal();
                var existente = carrito.find(function(item) { return item.id == productoId; });
                if (existente) {
                    existente.cantidad += cantidad;
                } else {
                    carrito.push({
                        id: productoId,
                        cantidad: cantidad,
                        precio: precio,
                        nombre: producto.nombre // <-- nombre correcto
                    });
                }
                setCarritoSucursal(carrito);
                actualizarCarritoHeader();

                var toastEl = document.getElementById('toastCarrito');
                var toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                toast.show();
                var modal = bootstrap.Modal.getInstance(document.getElementById('modalProducto'));
                if (modal) modal.hide();
            };
        }
        // Mejorar cantidad con botones +/-
        var inputCantidad = document.getElementById('input-cantidad');
        var btnSumar = document.getElementById('btn-sumar-cantidad');
        var btnRestar = document.getElementById('btn-restar-cantidad');
        if (inputCantidad && btnSumar && btnRestar) {
            btnSumar.onclick = function() {
                inputCantidad.value = Math.max(1, parseInt(inputCantidad.value) + 1);
            };
            btnRestar.onclick = function() {
                inputCantidad.value = Math.max(1, parseInt(inputCantidad.value) - 1);
            };
        }
        actualizarCarritoHeader();
    });
</script>
{% endblock %}