{% extends "base.html" %}
{% block content %}
<style>
/* Estilos específicos para el catálogo responsive */
.catalog-header {
    padding: 20px 0;
}

.decorative-line {
    height: 3px;
    width: 80px;
    background: linear-gradient(90deg, var(--pozoleria-orange), #d86b1a);
    border-radius: 2px;
}

.categories-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    padding: 0 10px;
}

.category-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.category-btn {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 20px;
    padding: 12px 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    min-width: 120px;
    text-align: center;
}

.category-btn:hover {
    border-color: var(--pozoleria-orange);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(233, 124, 26, 0.15);
}

.category-btn.active {
    background: linear-gradient(135deg, var(--pozoleria-orange), #d86b1a);
    border-color: var(--pozoleria-orange);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(233, 124, 26, 0.3);
}

.category-icon {
    font-size: 1.5rem;
    margin-bottom: 5px;
    color: var(--pozoleria-orange);
}

.category-btn.active .category-icon {
    color: white;
}

.category-name {
    display: block;
    font-weight: 600;
    font-size: 0.9rem;
}

.category-label-mobile {
    display: none;
    font-size: 0.8rem;
    font-weight: 600;
    color: #2c3e50;
    text-align: center;
    line-height: 1.2;
    transition: color 0.3s ease;
}

.category-item.active .category-label-mobile {
    color: var(--pozoleria-orange);
    font-weight: 700;
}

.category-count {
    background: var(--pozoleria-orange);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 0.7rem;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: -5px;
    right: -5px;
}

.category-btn.active .category-count {
    background: white;
    color: var(--pozoleria-orange);
}

.producto-card {
    border: none;
    border-radius: 20px;
    overflow: hidden;
    transition: all 0.3s ease;
    background: white;
}

.producto-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0,0,0,0.1);
}

.card-img-container {
    position: relative;
    overflow: hidden;
}

.card-img-top {
    height: 250px;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.producto-card:hover .card-img-top {
    transform: scale(1.05);
}

.category-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
}

.btn-agregar-menu {
    background: linear-gradient(135deg, var(--pozoleria-orange), #d86b1a);
    border: none;
    color: white;
    border-radius: 15px;
    padding: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.btn-agregar-menu:hover {
    background: linear-gradient(135deg, #d86b1a, #c96a14);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(233, 124, 26, 0.3);
    color: white;
}

/* Responsive design para catálogo */
@media (max-width: 768px) {
    .catalog-header h1 {
        font-size: 2.5rem;
    }
    
    .categories-container {
        gap: 8px;
        padding: 0 5px;
    }
    
    .category-item {
        gap: 6px;
    }
    
    .category-btn {
        min-width: 100px;
        padding: 10px 15px;
        font-size: 0.85rem;
    }
    
    .category-icon {
        font-size: 1.3rem;
    }
    
    .card-img-top {
        height: 200px;
    }
}

@media (max-width: 576px) {
    .catalog-header h1 {
        font-size: 2rem;
    }
    
    .catalog-header p {
        font-size: 0.95rem;
    }
    
    .categories-container {
        gap: 5px;
        justify-content: space-around;
    }
    
    .category-item {
        gap: 5px;
        flex: 1;
        max-width: 80px;
    }
    
    .category-btn {
        min-width: 60px;
        width: 60px;
        height: 60px;
        padding: 8px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
    }
    
    .category-name {
        display: none;
    }
    
    .category-label-mobile {
        display: block;
        text-align: center;
        word-wrap: break-word;
        max-width: 70px;
    }
    
    .category-icon {
        font-size: 1.2rem;
        margin-bottom: 0;
    }
    
    .category-count {
        top: -3px;
        right: -3px;
        width: 18px;
        height: 18px;
        font-size: 0.6rem;
    }
    
    .card-img-top {
        height: 180px;
    }
    
    .card-body {
        padding: 15px;
    }
    
    .card-title {
        font-size: 1.1rem;
    }
    
    .btn-agregar-menu {
        padding: 10px;
        font-size: 0.9rem;
    }
}

@media (max-width: 400px) {
    .category-item {
        max-width: 70px;
    }
    
    .category-btn {
        min-width: 50px;
        width: 50px;
        height: 50px;
        padding: 6px;
    }
    
    .category-label-mobile {
        font-size: 0.7rem;
        max-width: 60px;
    }
    
    .category-icon {
        font-size: 1rem;
    }
    
    .category-count {
        width: 16px;
        height: 16px;
        font-size: 0.55rem;
    }
    
    .card-img-top {
        height: 160px;
    }
}

/* Estilos específicos para el modal de opciones */
.modal-dialog {
    margin: 0;
}

.modal-content {
    border-radius: 20px;
    overflow: hidden;
}

.product-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 20px;
    margin: -20px -20px 20px -20px;
    border-radius: 0;
}

.opciones-container {
    padding: 0 5px;
    min-height: 200px;
    max-height: 400px;
    overflow-y: auto;
    background: #fff !important;
    border: 1px solid #e9ecef !important;
}

#modal-opciones {
    display: block !important;
    visibility: visible !important;
    background: #fff !important;
    min-height: 200px !important;
}

/* Forzar visibilidad de las opciones en todos los dispositivos */
.opcion-grupo {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    margin-bottom: 20px !important;
    padding: 20px !important;
    background: white !important;
    border: 2px solid #e9ecef !important;
    border-radius: 15px !important;
}

.opcion-grupo {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.opcion-grupo:hover {
    border-color: var(--pozoleria-orange);
    box-shadow: 0 5px 15px rgba(233, 124, 26, 0.1);
}

.opcion-titulo {
    color: var(--pozoleria-orange);
    font-weight: 700;
    font-size: 1.1rem;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.opcion-obligatorio {
    background: #28a745; /* Cambiar de rojo a verde */
    color: white;
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
}

.opcion-opcional {
    background: #6c757d; /* Cambiar de verde a gris */
    color: white;
    font-size: 0.7rem;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
}

.opcion-item {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
    cursor: pointer;
}

.opcion-item:hover {
    background: #fff;
    border-color: var(--pozoleria-orange);
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(233, 124, 26, 0.1);
}

.opcion-item.selected {
    background: rgba(233, 124, 26, 0.1);
    border-color: var(--pozoleria-orange);
    box-shadow: 0 0 0 3px rgba(233, 124, 26, 0.2);
}

.opcion-texto {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
}

.opcion-precio {
    color: var(--pozoleria-orange);
    font-weight: 700;
    font-size: 0.9rem;
}

.cantidad-controls {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 10px;
}

.btn-cantidad {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid;
    transition: all 0.3s ease;
}

.cantidad-input {
    max-width: 80px;
    border: none;
    background: transparent;
    font-size: 1.2rem;
    font-weight: 700;
}

.opcion-grupo.error {
    border-color: #dc3545 !important;
    background: rgba(220, 53, 69, 0.1);
    animation: shake 0.5s ease-in-out;
}

.opcion-grupo.error .opcion-titulo {
    color: #dc3545;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.precio-total {
    background: linear-gradient(135deg, var(--pozoleria-orange), #d86b1a);
    color: white;
    padding: 15px;
    border-radius: 15px;
    text-align: center;
}

.bottom-controls {
    background: white;
    border-top: 1px solid #e9ecef;
    padding: 20px;
    margin: 0 -20px -20px -20px;
}

/* Responsive específico para modal */
@media (max-width: 768px) {
    .modal-dialog {
        margin: 0 !important;
        width: 100% !important;
        height: 100% !important;
        max-width: none !important;
    }
    
    .modal-content {
        height: 100vh !important;
        border-radius: 0 !important;
        display: flex !important;
        flex-direction: column !important;
    }
    
    .modal-content .row {
        flex: 1 !important;
        min-height: 0 !important;
    }
    
    .modal-content .col-lg-7 {
        display: flex !important;
        flex-direction: column !important;
        min-height: 0 !important;
    }
    
    .modal-content .col-lg-7 > div {
        display: flex !important;
        flex-direction: column !important;
        height: 100% !important;
        min-height: 0 !important;
    }
    
    .opciones-container {
        flex: 1 !important;
        min-height: 300px !important;
        max-height: calc(100vh - 350px) !important;
        overflow-y: auto !important;
        margin-bottom: 10px !important;
        /* FORZAR VISIBILIDAD EN MÓVIL */
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: #fff !important;
        padding: 10px !important;
    }
    
    /* FORZAR VISIBILIDAD DE GRUPOS DE OPCIONES EN MÓVIL */
    .opciones-container .opcion-grupo {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: white !important;
        border: 1px solid #dee2e6 !important;
        margin-bottom: 15px !important;
        padding: 15px !important;
        border-radius: 8px !important;
    }
    
    /* FORZAR VISIBILIDAD DE ITEMS DE OPCIONES EN MÓVIL */
    .opciones-container .opcion-item {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: #f8f9fa !important;
        border: 1px solid #dee2e6 !important;
        margin-bottom: 8px !important;
        padding: 12px !important;
        border-radius: 6px !important;
    }
    
    /* FORZAR VISIBILIDAD DE CONTROLES DE FORM EN MÓVIL */
    .opciones-container .form-check {
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
        padding: 15px !important;
        background: white !important;
        border: 2px solid #e9ecef !important;
        border-radius: 12px !important;
        margin-bottom: 10px !important;
        cursor: pointer !important;
    }
    
    .opciones-container .form-check-input {
        display: block !important;
        width: 20px !important;
        height: 20px !important;
        flex-shrink: 0 !important;
        margin: 0 !important;
    }
    
    .opciones-container .form-check-label {
        display: flex !important;
        flex: 1 !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin: 0 !important;
        font-weight: 500 !important;
        color: #2c3e50 !important;
        cursor: pointer !important;
        text-align: left !important;
        width: 100% !important;
    }
    
    .opciones-container .opcion-titulo {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        font-size: 1rem !important;
        font-weight: 600 !important;
        margin-bottom: 10px !important;
        color: #495057 !important;
    }
    
    .opciones-container .opcion-precio {
        display: block !important;
        color: var(--pozoleria-orange) !important;
        font-weight: 600 !important;
        font-size: 0.9rem !important;
    }
        padding: 15px 10px !important;
        background: white !important;
        border: 1px solid #e9ecef !important;
    }
    
    .opcion-grupo {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: #f8f9fa !important;
        margin-bottom: 15px !important;
        padding: 15px !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 10px !important;
    }
    
    .product-header {
        padding: 15px;
        margin: -15px -15px 15px -15px;
        flex-shrink: 0;
    }
    
    .product-header h2 {
        font-size: 1.5rem;
    }
    
    .badge {
        font-size: 0.8rem;
        padding: 5px 10px;
    }
    
    .opcion-titulo {
        font-size: 1rem;
    }
    
    .opcion-item {
        padding: 12px;
    }
    
    .cantidad-controls {
        padding: 8px;
        justify-content: center;
    }
    
    .btn-cantidad {
        width: 35px;
        height: 35px;
    }
    
    .precio-total {
        padding: 12px;
        margin-top: 15px;
    }
    
    .precio-total span:last-child {
        font-size: 1.8rem;
    }
    
    .bottom-controls {
        padding: 15px !important;
        margin: 0 -15px -15px -15px !important;
        flex-shrink: 0 !important;
        position: sticky !important;
        bottom: 0 !important;
        background: white !important;
        border-top: 1px solid #e9ecef !important;
        z-index: 10 !important;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1) !important;
    }
    
    .btn {
        padding: 12px 20px;
        font-size: 0.95rem;
    }
}

@media (max-width: 576px) {
    .modal-content .col-lg-5 {
        display: none; /* Ocultar imagen en pantallas muy pequeñas para dar más espacio */
    }
    
    .modal-content .col-lg-7 {
        flex: 1;
    }
    
    .product-header {
        padding: 12px;
        margin: -12px -12px 12px -12px;
    }
    
    .product-header h2 {
        font-size: 1.1rem; /* Reducir de 1.3rem a 1.1rem */
        margin-bottom: 5px; /* Reducir margen inferior */
    }
    
    .opcion-grupo {
        padding: 8px; /* Reducir de 12px a 8px */
        margin-bottom: 8px; /* Reducir de 12px a 8px */
    }
    
    .opcion-titulo {
        font-size: 0.9rem; /* Reducir de 0.95rem a 0.9rem */
        margin-bottom: 8px; /* Reducir de 10px a 8px */
    }
    
    .opcion-item {
        padding: 8px; /* Reducir de 10px a 8px */
        margin-bottom: 6px; /* Reducir de 8px a 6px */
    }
    
    .opcion-texto {
        font-size: 0.9rem;
        flex: 1;
        text-align: left;
        margin-right: 10px;
        line-height: 1.3;
    }
    
    .opcion-precio {
        font-size: 0.85rem;
        color: #e97c1a;
        font-weight: 600;
        text-align: right;
        flex-shrink: 0;
    }
    
    .cantidad-controls {
        padding: 6px;
    }
    
    .btn-cantidad {
        width: 30px;
        height: 30px;
        font-size: 0.8rem;
    }
    
    .cantidad-input {
        max-width: 60px;
        font-size: 1rem;
    }
    
    .precio-total {
        padding: 10px;
    }
    
    .precio-total span:last-child {
        font-size: 1.5rem;
    }
    
    .bottom-controls {
        padding: 12px;
        margin: 0 -12px -12px -12px;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 2px solid #e9ecef;
        z-index: 1050;
        box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    }
    
    .opciones-container {
        padding-bottom: 120px; /* Espacio para el bottom-controls fijo */
        max-height: calc(100vh - 200px);
        overflow-y: auto;
        padding: 10px 5px 120px 5px;
    }
    
    .btn {
        padding: 12px 15px;
        font-size: 0.9rem;
        font-weight: 600;
    }
    
    .d-flex.flex-column.flex-sm-row.gap-3 {
        flex-direction: column !important;
        gap: 8px !important;
    }
    
    #btn-agregar-carrito {
        padding: 14px 20px;
        font-size: 1rem;
        font-weight: 700;
    }
}

/* Para pantallas extremadamente pequeñas */
@media (max-width: 400px) {
    .bottom-controls {
        padding: 10px;
        margin: 0;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 2px solid var(--pozoleria-orange);
        z-index: 1060;
        box-shadow: 0 -6px 30px rgba(0,0,0,0.2);
    }
    
    .opciones-container {
        padding-bottom: 140px !important; /* Más espacio para el bottom-controls fijo */
        margin-bottom: 0 !important;
        max-height: calc(100vh - 180px);
        overflow-y: auto;
        padding: 10px 5px 140px 5px !important;
    }
    
    .modal-content .col-lg-7 > div {
        padding: 10px !important;
    }
    
    #btn-agregar-carrito {
        padding: 16px 20px;
        font-size: 1.1rem;
        font-weight: 700;
        border-radius: 12px;
    }
    
    .btn[data-bs-dismiss="modal"] {
        padding: 12px 16px;
        font-size: 0.95rem;
        border-radius: 12px;
    }
    
    .cantidad-controls {
        padding: 4px;
        border-radius: 12px;
    }
    
    .precio-total {
        padding: 8px;
        border-radius: 12px;
        margin-top: 10px;
    }
    
    .precio-total span:last-child {
        font-size: 1.4rem;
    }
}

/* Animación de ondas para feedback táctil */
@keyframes ripple {
    to {
        transform: scale(4);
        opacity: 0;
    }
}

/* ESTILOS ESPECÍFICOS PARA ESCRITORIO */
@media (min-width: 992px) {
    /* ===== MEJORAS PARA EL CATÁLOGO EN DESKTOP ===== */
    
    /* Header más elegante en desktop */
    .catalog-header {
        padding: 40px 0 60px 0;
    }
    
    .catalog-header h1 {
        font-size: 3.5rem;
        margin-bottom: 20px;
    }
    
    .catalog-header p {
        font-size: 1.25rem;
        max-width: 600px;
        margin: 0 auto;
    }
    
    /* Categorías en desktop - layout horizontal mejorado */
    .categories-container {
        justify-content: center;
        gap: 20px;
        padding: 0 20px;
    }
    
    .category-btn {
        min-width: 140px;
        padding: 16px 24px;
        font-size: 1rem;
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .category-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 35px rgba(233, 124, 26, 0.2);
    }
    
    .category-icon {
        font-size: 1.8rem;
        margin-bottom: 8px;
    }
    
    /* Grid de productos optimizado para desktop */
    .products-section .row {
        margin: 0 -15px;
    }
    
    .producto-item {
        padding: 0 15px;
        margin-bottom: 40px;
    }
    
    .producto-card {
        transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .producto-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 50px rgba(0,0,0,0.15);
    }
    
    .card-img-top {
        height: 280px;
        transition: transform 0.4s ease;
    }
    
    .producto-card:hover .card-img-top {
        transform: scale(1.08);
    }
    
    /* ===== MODAL DE PRODUCTO PROFESIONAL PARA DESKTOP ===== */
    .modal-dialog {
        max-width: 1100px;
        margin: 3vh auto;
    }
    
    .modal-content {
        border: none;
        border-radius: 20px;
        box-shadow: 0 25px 80px rgba(0,0,0,0.15);
        overflow: hidden;
    }
    
    /* Layout de dos columnas mejorado */
    .modal-body .row {
        min-height: 600px;
    }
    
    /* Sección de imagen del producto */
    .modal-body .col-lg-5 {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        position: relative;
        overflow: hidden;
    }
    
    #modal-img-container {
        height: 100%;
        padding: 40px;
    }
    
    #modal-img-container img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        border-radius: 15px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.3);
        transition: transform 0.3s ease;
    }
    
    #modal-img-container img:hover {
        transform: scale(1.05);
    }
    
    /* Sección de opciones */
    .modal-body .col-lg-7 {
        padding: 40px;
        background: #ffffff;
    }
    
    /* Header del producto mejorado */
    .product-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        margin: -40px -40px 30px -40px;
        padding: 30px 40px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .product-header h2 {
        font-size: 2.2rem;
        margin-bottom: 15px;
        color: var(--pozoleria-orange);
    }
    
    .product-header .badge {
        font-size: 0.9rem;
        padding: 8px 16px;
    }
    
    /* Contenedor de opciones optimizado */
    .opciones-container {
        max-height: 400px;
        overflow-y: auto;
        padding: 0 5px;
        margin-bottom: 30px;
    }
    
    /* Grupos de opciones más elegantes */
    .opcion-grupo {
        background: #ffffff;
        border: 2px solid #f1f3f4;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        transition: all 0.3s ease;
    }
    
    .opcion-grupo:hover {
        border-color: var(--pozoleria-orange);
        box-shadow: 0 8px 25px rgba(233, 124, 26, 0.12);
        transform: translateY(-2px);
    }
    
    .opcion-titulo {
        font-size: 1.2rem;
        margin-bottom: 20px;
        color: var(--pozoleria-orange);
        font-weight: 700;
    }
    
    /* Items de opciones mejorados */
    .opcion-item {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 12px;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .opcion-item:hover {
        background: #ffffff;
        border-color: var(--pozoleria-orange);
        transform: translateX(5px);
        box-shadow: 0 6px 20px rgba(233, 124, 26, 0.1);
    }
    
    .opcion-item.selected {
        background: linear-gradient(135deg, rgba(233, 124, 26, 0.1), rgba(233, 124, 26, 0.05));
        border-color: var(--pozoleria-orange);
        box-shadow: 0 0 0 3px rgba(233, 124, 26, 0.2);
    }
    
    .form-check-input {
        width: 1.2rem;
        height: 1.2rem;
        margin-top: 0.1rem;
    }
    
    .form-check-label {
        font-size: 1rem;
        line-height: 1.5;
        cursor: pointer;
    }
    
    .opcion-precio {
        font-size: 1rem;
        font-weight: 600;
        color: var(--pozoleria-orange);
    }
    
    /* Controles de cantidad mejorados */
    .cantidad-controls {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 15px;
        justify-content: center;
    }
    
    .btn-cantidad {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }
    
    .btn-cantidad:hover {
        transform: scale(1.1);
    }
    
    .cantidad-input {
        width: 80px;
        font-size: 1.3rem;
        font-weight: 700;
        text-align: center;
        border: none;
        background: transparent;
    }
    
    /* Precio total destacado */
    .precio-total {
        background: linear-gradient(135deg, var(--pozoleria-orange), #d86b1a);
        color: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        margin-bottom: 25px;
    }
    
    .precio-total span:last-child {
        font-size: 2.2rem;
        font-weight: 700;
    }
    
    /* Botones de acción mejorados */
    .bottom-controls {
        background: #f8f9fa;
        margin: 0 -40px -40px -40px;
        padding: 25px 40px;
        border-top: 1px solid #e9ecef;
    }
    
    .bottom-controls .btn {
        padding: 15px 30px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    
    .bottom-controls .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    #btn-agregar-carrito {
        background: linear-gradient(45deg, var(--pozoleria-orange), #d86b1a);
        border: none;
        color: white;
    }
    
    #btn-agregar-carrito:hover {
        background: linear-gradient(45deg, #d86b1a, #c96a14);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(233, 124, 26, 0.3);
    }
    
    /* Cerrar modal mejorado */
    .btn-close {
        font-size: 1.5rem;
        opacity: 0.8;
        transition: all 0.3s ease;
    }
    
    .btn-close:hover {
        opacity: 1;
        transform: scale(1.1);
    }
    
    /* Scrollbar personalizado para opciones */
    .opciones-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .opciones-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .opciones-container::-webkit-scrollbar-thumb {
        background: var(--pozoleria-orange);
        border-radius: 10px;
    }
    
    .opciones-container::-webkit-scrollbar-thumb:hover {
        background: #d86b1a;
    }
    
    /* Scrollbar personalizado para el formulario principal en desktop */
    #form-personalizar::-webkit-scrollbar {
        width: 8px !important;
    }
    
    #form-personalizar::-webkit-scrollbar-track {
        background: #f1f1f1 !important;
        border-radius: 10px !important;
    }
    
    #form-personalizar::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #e97c1a, #ff9500) !important;
        border-radius: 10px !important;
    }
    
    #form-personalizar::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #d86b1a, #e6850e) !important;
    }
    
    /* Animaciones suaves */
    .modal.fade .modal-dialog {
        transition: transform 0.4s ease-out;
        transform: scale(0.9);
    }
    
    .modal.show .modal-dialog {
        transform: scale(1);
    }
    
    /* Eliminar estilos móviles en desktop */
    .mobile-modal-footer,
    .mobile-buttons-container,
    .mobile-cancel-btn,
    .mobile-next-btn,
    .mobile-prev-btn,
    .mobile-add-btn,
    .mobile-navigation,
    .wizard-container,
    .wizard-step,
    .wizard-progress {
        display: none !important;
    }
    
    /* Asegurar que el modal no sea fullscreen en desktop */
    .modal-fullscreen-md-down {
        max-width: 1100px;
        margin: 3vh auto;
    }
}

/* ===== ESTILOS PARA ESTABLECIMIENTOS CON HORARIOS ===== */
.establecimiento-option {
    border: 2px solid #e9ecef;
    border-radius: 15px;
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.establecimiento-option:hover {
    border-color: var(--pozoleria-orange);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(233, 124, 26, 0.15);
}

.establecimiento-option.selected {
    border-color: var(--pozoleria-orange);
    background: linear-gradient(135deg, rgba(233, 124, 26, 0.05), rgba(233, 124, 26, 0.02));
    box-shadow: 0 6px 20px rgba(233, 124, 26, 0.2);
}

.establecimiento-option .form-check-input:checked {
    background-color: var(--pozoleria-orange);
    border-color: var(--pozoleria-orange);
}

.establecimiento-info {
    padding: 8px 0;
    border-top: 1px solid #f1f3f4;
    margin-top: 8px;
}

.horarios-info {
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #f1f3f4;
}

.horarios-info .btn-link {
    color: var(--pozoleria-orange);
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 500;
}

.horarios-info .btn-link:hover {
    color: #d86b1a;
}

.badge.bg-success {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
}

.badge.bg-warning {
    background: linear-gradient(135deg, #ffc107, #fd7e14) !important;
}

.badge.bg-danger {
    background: linear-gradient(135deg, #dc3545, #e74c3c) !important;
}

/* Animaciones para el collapse de horarios */
.collapse {
    transition: height 0.3s ease;
}

/* Estados de establecimiento */
.establecimiento-option[data-estado="abierta"] {
    border-left: 4px solid #28a745;
}

.establecimiento-option[data-estado="cerrada"] {
    border-left: 4px solid #ffc107;
}

.establecimiento-option[data-estado="fuera-servicio"] {
    border-left: 4px solid #dc3545;
    opacity: 0.7;
}

/* Estilos para horarios mejorados */
.horario-hoy {
    position: relative;
}

.horario-hoy .alert {
    border: 2px solid #2196f3;
    border-radius: 8px;
    margin: 0;
    animation: pulse-info 2s infinite;
}

.horario-hoy-texto {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
}

.horario-fila[data-dia-actual="true"] {
    background: rgba(33, 150, 243, 0.1);
    border-left: 3px solid #2196f3;
    font-weight: bold;
}

.horario-fila[data-dia-actual="true"] .dia-nombre::before {
    content: "→ ";
    color: #2196f3;
    font-weight: bold;
}

.restriccion-horario {
    border: 1px solid #ffc107;
    border-radius: 8px;
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
}

.restriccion-horario.fuera-servicio {
    border-color: #dc3545;
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
}

/* Indicador de tiempo real */
.tiempo-real {
    position: relative;
}

.tiempo-real::after {
    content: "";
    position: absolute;
    right: -8px;
    top: 50%;
    transform: translateY(-50%);
    width: 6px;
    height: 6px;
    background: #28a745;
    border-radius: 50%;
    animation: pulse-dot 1.5s infinite;
}

/* Tabla de horarios mejorada */
.table-borderless td {
    border: none;
    padding: 0.25rem 0.5rem;
}

.table-borderless tr:hover {
    background: rgba(0, 123, 255, 0.05);
}

/* Estados de establecimiento en el modal */
.establecimiento-option.disabled {
    opacity: 0.6;
    pointer-events: none;
    background: #f8f9fa;
}

.establecimiento-option.disabled .form-check-input {
    opacity: 0.5;
}

/* Animaciones mejoradas */
@keyframes pulse-info {
    0% {
        box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.4);
    }
    70% {
        box-shadow: 0 0 0 8px rgba(33, 150, 243, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(33, 150, 243, 0);
    }
}

@keyframes pulse-dot {
    0%, 100% {
        opacity: 1;
        transform: translateY(-50%) scale(1);
    }
    50% {
        opacity: 0.5;
        transform: translateY(-50%) scale(1.2);
    }
}

/* Responsive para móvil */
@media (max-width: 768px) {
    .establecimiento-option {
        margin-bottom: 1rem;
    }
    
    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    .horarios-info .small {
        font-size: 0.75rem;
    }
}

/* Indicador de horario actual */
.horario-actual {
    background: rgba(40, 167, 69, 0.1);
    border-left: 3px solid #28a745;
    padding: 2px 6px;
    border-radius: 4px;
}

/* Efecto de pulso para establecimientos abiertos */
.badge.bg-success {
    animation: pulse-success 2s infinite;
}

@keyframes pulse-success {
    0% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
    }
    70% {
        box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
    }
}

/* Estilos para toast de producto agregado */
.toast-carrito {
    min-width: 350px;
    max-width: 400px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    animation: slideInRight 0.4s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.toast-carrito .toast-header {
    border-bottom: none;
    padding: 1rem 1.25rem 0.5rem;
}

.toast-carrito .toast-body {
    padding: 0.5rem 1.25rem 1.25rem;
}

.toast-carrito .btn-close-white {
    filter: brightness(0) invert(1);
}

.toast-carrito .btn {
    font-size: 0.85rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 600;
}
</style>

<div class="container py-4">
    <!-- Modal de selección de establecimiento -->
    <div class="modal fade" id="modalSucursal" tabindex="-1" aria-labelledby="modalSucursalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalSucursalLabel">Escoge el establecimiento</h5>
          </div>
          <div class="modal-body">
            <form id="form-sucursal-modal">
                <label class="form-label">Selecciona tu establecimiento:</label>
                <div class="row g-3">
                    {% for s in sucursales %}
                    <div class="col-12">
                        <div class="card establecimiento-option h-100" data-sucursal-id="{{ s.id }}" onclick="seleccionarSucursal({{ s.id }})">
                            <div class="card-body p-3">
                                <div class="d-flex align-items-start justify-content-between">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="form-check me-3">
                                                <input class="form-check-input" type="radio" name="sucursal_radio" 
                                                       value="{{ s.id }}" id="sucursal_{{ s.id }}">
                                            </div>
                                            <div>
                                                <h6 class="card-title mb-1">{{ s.nombre }}</h6>
                                                <div class="d-flex align-items-center gap-2">
                                                    <span class="badge" data-sucursal-id="{{ s.id }}">
                                                        <i class="fas fa-clock me-1"></i>Verificando...
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="sucursal-info">
                                            <div class="mb-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-map-marker-alt me-1"></i>{{ s.direccion }}
                                                </small>
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted">
                                                    <i class="fas fa-phone me-1"></i>{{ s.telefono }}
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <!-- Horarios mejorados -->
                                        {% if s.horarios %}
                                        <div class="horarios-info">
                                            <div class="d-flex align-items-center justify-content-between mb-2">
                                                <small class="text-muted fw-bold">
                                                    <i class="fas fa-clock me-1"></i>Horarios de atención
                                                </small>
                                                <button class="btn btn-link btn-sm p-0" type="button" 
                                                        data-bs-toggle="collapse" data-bs-target="#horarios_{{ s.id }}" 
                                                        aria-expanded="false">
                                                    <i class="fas fa-chevron-down"></i>
                                                </button>
                                            </div>
                                            
                                            <!-- Horario de hoy destacado -->
                                            <div class="horario-hoy mb-2">
                                                <div class="alert alert-info py-2 mb-1" style="background: linear-gradient(135deg, #e3f2fd, #bbdefb);">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span class="small fw-bold">
                                                            <i class="fas fa-calendar-day me-1"></i>HOY
                                                        </span>
                                                        <span class="small fw-bold">
                                                            <span id="horario-hoy-{{ s.id }}" class="horario-hoy-texto">
                                                                <!-- Se llenará con JavaScript -->
                                                            </span>
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div class="collapse" id="horarios_{{ s.id }}">
                                                <div class="table-responsive">
                                                    <table class="table table-sm table-borderless">
                                                        {% for horario in s.horarios %}
                                                            {% set dia_nombre = horario.split(':')[0] %}
                                                            {% set horario_texto = horario.split(': ')[1] if ': ' in horario else 'Cerrado' %}
                                                            <tr class="horario-fila" data-dia="{{ loop.index0 }}">
                                                                <td class="small py-1 dia-nombre">
                                                                    {{ dia_nombre }}
                                                                </td>
                                                                <td class="small text-end py-1">
                                                                    {% if 'Cerrado' in horario_texto %}
                                                                        <span class="text-muted">
                                                                            <i class="fas fa-times me-1"></i>Cerrado
                                                                        </span>
                                                                    {% else %}
                                                                        <span class="text-success">
                                                                            <i class="fas fa-clock me-1"></i>{{ horario_texto }}
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                        
                                        <!-- Restricción de pedidos fuera de horario -->
                                        {% if not s.abierta_ahora or not s.activa %}
                                        <div class="alert alert-warning py-2 mt-2 restriccion-horario">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-exclamation-triangle me-2 text-warning"></i>
                                                <small class="fw-bold">
                                                    {% if not s.activa %}
                                                        Esta sucursal está fuera de servicio
                                                    {% else %}
                                                        Pedidos disponibles solo en horario de atención
                                                    {% endif %}
                                                </small>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-success" id="btnElegirSucursal">Continuar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Header del Catálogo -->
    <div class="catalog-header text-center mb-5">
        <h1 class="display-4 fw-bold mb-3" style="color: var(--pozoleria-orange);">
            <i class="fas fa-utensils me-3"></i>Nuestro Menú
        </h1>
        <p class="lead text-muted mb-4">Descubre los auténticos sabores de nuestra pozolería tradicional</p>
        <div class="decorative-line mx-auto mb-4"></div>
        
        <!-- BOTÓN DE PRUEBA -->
        <button type="button" class="btn btn-warning mb-3" onclick="window.probarModal ? window.probarModal() : alert('Función no disponible aún')">
            🧪 PROBAR MODAL (Debug)
        </button>
        
        <!-- BOTÓN PARA PROBAR ABRIRMODAL DIRECTAMENTE -->
        <button type="button" class="btn btn-info mb-3 ms-2" onclick="window.abrirModal ? window.abrirModal(1) : alert('abrirModal no disponible')">
            🔧 ABRIRMODAL DIRECTO
        </button>
        
        <!-- BOTÓN DE ESTADO DE FUNCIONES -->
        <button type="button" class="btn btn-success mb-3 ms-2" onclick="alert('abrirModal: ' + typeof window.abrirModal + '\\nabrirModalCompleto: ' + typeof window.abrirModalCompleto + '\\nopcionesPorProducto: ' + typeof window.opcionesPorProducto)">
            📊 ESTADO FUNCIONES
        </button>
        
        <!-- BOTÓN PARA FORZAR CARGA DEL SCRIPT -->
        <button type="button" class="btn btn-danger mb-3 ms-2" onclick="console.log('🔄 Forzando recarga...'); location.reload();">
            🔄 RECARGAR PÁGINA
        </button>
        
        <!-- BOTÓN PARA REVISAR SCRIPTS -->
        <button type="button" class="btn btn-secondary mb-3 ms-2" onclick="console.log('Scripts en página:', document.querySelectorAll('script').length); console.log('Lista de scripts:', Array.from(document.querySelectorAll('script')).map(s => s.src || 'inline')); alert('Revisa la consola para ver info de scripts');">
            🔍 INFO SCRIPTS
        </button>
        
        <!-- BOTÓN PARA PROBAR ENVÍO DE FORMULARIO -->
        <button type="button" class="btn btn-dark mb-3 ms-2" onclick="
            var form = document.getElementById('form-personalizar');
            if (!form) { alert('Formulario no encontrado'); return; }
            var formData = new FormData(form);
            console.log('📋 Datos actuales del formulario:');
            for (let [key, value] of formData.entries()) {
                console.log('  ' + key + ': ' + value);
            }
            alert('Revisa la consola para ver los datos del formulario');
        ">
            📋 DEBUG FORMULARIO
        </button>
        
        <!-- BOTÓN PARA SIMULAR ENVÍO AJAX -->
        <button type="button" class="btn btn-warning mb-3 ms-2" onclick="
            var form = document.getElementById('form-personalizar');
            if (!form) { alert('Formulario no encontrado'); return; }
            var formData = new FormData(form);
            
            console.log('📡 Enviando vía AJAX para debug...');
            fetch('/agregar_carrito', {
                method: 'POST',
                body: formData
            }).then(response => {
                console.log('📥 Respuesta del servidor:', response);
                if (response.redirected) {
                    console.log('🔄 Redirección a:', response.url);
                }
                return response.text();
            }).then(data => {
                console.log('📄 Contenido de respuesta:', data.substring(0, 200) + '...');
                alert('Envío completado. Revisa la consola para detalles.');
            }).catch(error => {
                console.error('❌ Error en envío:', error);
                alert('Error: ' + error.message);
            });
        ">
            📡 TEST AJAX
        </button>
        
        <!-- Script inline para definir función inmediatamente -->
        <script>
            // Definir abrirModal inmediatamente como versión simplificada
            window.abrirModal = function(id) {
                console.log('=== ABRIRMODAL SIMPLIFICADA ===');
                console.log('ID del producto:', id);
                console.log('Bootstrap disponible:', typeof bootstrap !== 'undefined');
                
                if (typeof bootstrap === 'undefined') {
                    console.error('❌ Bootstrap no está disponible aún');
                    // Intentar esperar un poco más y volver a intentar
                    setTimeout(function() {
                        if (typeof bootstrap !== 'undefined') {
                            console.log('✅ Bootstrap ahora disponible, reintentando...');
                            window.abrirModal(id);
                        } else {
                            alert('Error: Bootstrap no se ha cargado completamente. Por favor recarga la página.');
                        }
                    }, 500);
                    return;
                }
                
                // Verificar sucursal
                var sucursalActual = localStorage.getItem('sucursal_id');
                if (!sucursalActual) {
                    alert('Por favor selecciona una sucursal primero');
                    return;
                }
                
                // Llenar información básica (si está disponible)
                var modalElement = document.getElementById('modalProducto');
                if (!modalElement) {
                    console.error('❌ Elemento modal no encontrado');
                    alert('Error: Modal no encontrado');
                    return;
                }
                
                // Configurar información básica del modal
                document.getElementById('producto_id').value = id;
                document.getElementById('cantidad').value = 1;
                document.getElementById('sucursal_id').value = sucursalActual;
                
                console.log('🔧 Configuración del modal:');
                console.log('  - producto_id:', id);
                console.log('  - cantidad:', 1);
                console.log('  - sucursal_id:', sucursalActual);
                
                // Buscar información del producto en el DOM
                var productoCard = document.querySelector('[data-producto-id="' + id + '"]');
                if (productoCard) {
                    var nombre = productoCard.querySelector('.card-title').textContent;
                    var precio = productoCard.querySelector('.fw-bold').textContent;
                    var descripcion = productoCard.querySelector('.card-text').textContent;
                    var imagen = productoCard.querySelector('.card-img-top');
                    
                    document.getElementById('modal-nombre').textContent = nombre;
                    document.getElementById('modal-precio').textContent = precio;
                    
                    if (imagen) {
                        document.getElementById('modal-img-container').innerHTML = 
                            '<img src="' + imagen.src + '" class="img-fluid" alt="' + nombre + '">';
                    }
                }
                
                // Agregar mensaje temporal en opciones
                var modalOpciones = document.getElementById('modal-opciones');
                if (modalOpciones) {
                    modalOpciones.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary mb-3" role="status"></div><p>Cargando opciones del producto...</p></div>';
                }
                
                // Mostrar el modal
                try {
                    var modal = new bootstrap.Modal(modalElement);
                    modal.show();
                    console.log('✅ Modal abierto exitosamente (versión simplificada)');
                    
                    // Esperar a que la versión completa esté disponible con más intentos
                    function intentarActualizarModal() {
                        var intentos = 0;
                        var intervalo = setInterval(function() {
                            intentos++;
                            console.log('🔄 Intento', intentos, '- Buscando abrirModalCompleto...');
                            console.log('typeof window.abrirModalCompleto:', typeof window.abrirModalCompleto);
                            
                            if (typeof window.abrirModalCompleto === 'function') {
                                console.log('✅ abrirModalCompleto encontrada, actualizando...');
                                clearInterval(intervalo);
                                window.abrirModalCompleto(id);
                            } else if (intentos >= 15) { // Reducir a 3 segundos
                                console.warn('⚠️ Script principal no cargó, usando modal simplificado');
                                clearInterval(intervalo);
                                // Mostrar modal simplificado pero funcional
                                var modalOpciones = document.getElementById('modal-opciones');
                                if (modalOpciones) {
                                    modalOpciones.innerHTML = '<div class="text-center text-info py-4">' +
                                        '<i class="fas fa-check-circle fa-3x mb-3"></i>' +
                                        '<h5 class="mb-3">Producto listo para agregar</h5>' +
                                        '<p class="mb-3">Este producto no requiere opciones adicionales o las opciones no se pudieron cargar.</p>' +
                                        '<div class="alert alert-info">' +
                                        '<i class="fas fa-info-circle me-2"></i>' +
                                        'Puedes agregar este producto directamente al carrito.' +
                                        '</div>' +
                                        '<div class="d-grid d-lg-none">' +
                                        '<button type="submit" class="btn btn-success btn-lg" form="form-personalizar">' +
                                        '<i class="fas fa-shopping-cart me-2"></i>Agregar al Carrito' +
                                        '</button>' +
                                        '</div>' +
                                        '</div>';
                                }
                            }
                        }, 200);
                    }
                    
                    // Iniciar la búsqueda de la función completa
                    setTimeout(intentarActualizarModal, 100);
                    
                } catch (error) {
                    console.error('❌ Error al abrir modal:', error);
                    alert('Error al abrir modal: ' + error.message);
                }
            };
            
            // Mejorar la función probarModal para usar datos reales
            window.probarModal = function() {
                console.log('=== PRUEBA DE MODAL CON DATOS REALES ===');
                console.log('Bootstrap disponible:', typeof bootstrap !== 'undefined');
                console.log('Elemento modal existe:', document.getElementById('modalProducto') !== null);
                console.log('Datos de productos disponibles:', typeof window.opcionesPorProducto !== 'undefined');
                
                if (typeof bootstrap === 'undefined') {
                    console.error('❌ Bootstrap no está disponible');
                    alert('Error: Bootstrap no está cargado aún');
                    return;
                }
                
                // Buscar el primer producto disponible
                var primerProducto = window.opcionesPorProducto && window.opcionesPorProducto[0];
                if (!primerProducto) {
                    console.error('❌ No hay productos disponibles');
                    alert('Error: No hay productos cargados');
                    return;
                }
                
                console.log('🎯 Probando con producto:', primerProducto.nombre, '(ID:', primerProducto.id, ')');
                console.log('🎛️ Opciones del producto:', primerProducto.opciones);
                
                // Usar abrirModal con un producto real
                window.abrirModal(primerProducto.id);
            };
            
            window.probarAbrirModal = function() {
                console.log('=== PROBANDO FUNCIÓN ABRIRMODAL ===');
                console.log('typeof abrirModal:', typeof abrirModal);
                console.log('typeof window.abrirModal:', typeof window.abrirModal);
                
                if (typeof abrirModal === 'undefined') {
                    console.error('❌ abrirModal no está definida');
                    alert('Error: abrirModal no está definida aún. Probablemente el script principal no se ha cargado.');
                    return;
                }
                
                // Probar con el primer producto disponible
                try {
                    console.log('Intentando abrir modal con ID de prueba (1)...');
                    abrirModal(1);
                    console.log('✅ abrirModal ejecutada exitosamente');
                } catch (error) {
                    console.error('❌ Error al ejecutar abrirModal:', error);
                    alert('❌ Error al ejecutar abrirModal: ' + error.message);
                }
            };
            
            // Función que espera a que abrirModal esté disponible
            window.intentarAbrirModal = function(id) {
                console.log('=== INTENTANDO ABRIR MODAL ===');
                console.log('ID del producto:', id);
                console.log('typeof abrirModal:', typeof abrirModal);
                
                if (typeof abrirModal === 'function') {
                    console.log('✅ abrirModal disponible, ejecutando...');
                    abrirModal(id);
                } else {
                    console.log('⏳ abrirModal no disponible, esperando...');
                    // Intentar hasta 10 veces con intervalos de 200ms
                    var intentos = 0;
                    var intervalo = setInterval(function() {
                        intentos++;
                        console.log('Intento', intentos, '- typeof abrirModal:', typeof abrirModal);
                        
                        if (typeof abrirModal === 'function') {
                            console.log('✅ abrirModal ahora disponible, ejecutando...');
                            clearInterval(intervalo);
                            abrirModal(id);
                        } else if (intentos >= 10) {
                            console.error('❌ Timeout: abrirModal no se cargó después de 10 intentos');
                            clearInterval(intervalo);
                            alert('Error: La función para abrir el modal no se ha cargado. Por favor recarga la página.');
                        }
                    }, 200);
                }
            };
            
            console.log('🧪 Funciones definidas inline - abrirModal ya disponible');
        </script>
    </div>

    <!-- JavaScript principal para opciones de productos -->
    <script>
        // Datos de productos con opciones desde el backend
        window.opcionesPorProducto = {{ productos|tojson }};
        console.log('📦 Datos de productos cargados:', window.opcionesPorProducto);
        
        // Función completa para cargar opciones del producto
        window.abrirModalCompleto = function(productoId) {
            console.log('=== ABRIRMODAL COMPLETO ===');
            console.log('ID del producto:', productoId);
            
            // Buscar el producto en los datos
            var producto = window.opcionesPorProducto.find(p => p.id == productoId);
            if (!producto) {
                console.error('❌ Producto no encontrado:', productoId);
                return;
            }
            
            console.log('✅ Producto encontrado:', producto);
            
            // Actualizar información del modal
            document.getElementById('modal-nombre').textContent = producto.nombre;
            document.getElementById('modal-precio').textContent = '$' + parseFloat(producto.precio).toFixed(2);
            
            var modalDescripcion = document.getElementById('modal-descripcion');
            if (modalDescripcion) {
                modalDescripcion.textContent = producto.descripcion || '';
            }
            
            // Actualizar imagen con estructura moderna
            var modalImgContainer = document.getElementById('modal-img-container');
            if (modalImgContainer) {
                if (producto.imagen) {
                    modalImgContainer.innerHTML = '<img src="' + producto.imagen + '" class="img-fluid" alt="' + producto.nombre + '">';
                } else {
                    modalImgContainer.innerHTML = '<div class="no-image-placeholder"><i class="fas fa-image fa-3x text-muted"></i><p class="mt-2 text-muted">Sin imagen</p></div>';
                }
            }
            
            // Cargar opciones si existen
            var modalOpciones = document.getElementById('modal-opciones');
            if (!modalOpciones) {
                console.error('❌ Contenedor de opciones no encontrado');
                return;
            }
            
            var opcionesHtml = '';
            
            if (producto.opciones && producto.opciones.length > 0) {
                console.log('🎛️ Cargando', producto.opciones.length, 'opciones');
                
                producto.opciones.forEach(function(opcion, index) {
                    var esObligatorio = opcion.obligatorio;
                    var tipoInput = opcion.tipo === 'multiple' ? 'checkbox' : 'radio';
                    var nombreInput = opcion.nombre; // Ya viene como "opcion_{id}" del backend
                    
                    console.log('🎛️ Procesando opción:', opcion.titulo, 'con nombre:', nombreInput);
                    
                    // Estilo inspirado en la página de referencia
                    opcionesHtml += '<div class="opcion-grupo-moderno mb-4" data-obligatorio="' + esObligatorio + '">';
                    
                    // Header de la opción con badge
                    opcionesHtml += '<div class="opcion-header mb-3">';
                    opcionesHtml += '<h5 class="opcion-titulo-moderno mb-1">' + opcion.titulo + '</h5>';
                    
                    if (esObligatorio) {
                        opcionesHtml += '<span class="badge-obligatorio">Obligatorio</span>';
                        opcionesHtml += '<p class="opcion-descripcion">Seleccione 1</p>';
                    } else {
                        opcionesHtml += '<span class="badge-opcional">Opcional</span>';
                    }
                    
                    opcionesHtml += '</div>';
                    
                    // Container de opciones con estilo moderno
                    opcionesHtml += '<div class="opciones-container">';
                    
                    // Generar las opciones individuales con diseño moderno
                    opcion.opciones.forEach(function(valor, valorIndex) {
                        var inputId = nombreInput + '_' + valorIndex;
                        var precioTexto = valor.precio && valor.precio > 0 ? ' (+$' + parseFloat(valor.precio).toFixed(2) + ')' : '';
                        
                        // El backend espera: 
                        // - Para radio: "opcion_{id}" 
                        // - Para checkbox: "opcion_{id}[]" (el backend busca este formato)
                        var nombreCampo = tipoInput === 'checkbox' ? nombreInput + '[]' : nombreInput;
                        
                        console.log('🏷️ Campo generado:', nombreCampo, 'para opción:', valor.texto, '(tipo:', tipoInput + ')');
                        
                        opcionesHtml += '<div class="opcion-item-moderno" onclick="seleccionarOpcion(\'' + inputId + '\', \'' + tipoInput + '\', \'' + nombreInput + '\')">';
                        opcionesHtml += '<div class="opcion-radio-container">';
                        opcionesHtml += '<input class="opcion-radio-input" type="' + tipoInput + '" name="' + nombreCampo + '" id="' + inputId + '" value="' + valor.texto + '" data-precio="' + (valor.precio || 0) + '">';
                        opcionesHtml += '<label class="opcion-radio-label" for="' + inputId + '">';
                        opcionesHtml += '<span class="radio-button"></span>';
                        opcionesHtml += '<div class="opcion-content">';
                        opcionesHtml += '<span class="opcion-nombre">' + valor.texto + '</span>';
                        if (precioTexto) {
                            opcionesHtml += '<span class="opcion-precio-moderno">' + precioTexto + '</span>';
                        }
                        opcionesHtml += '</div>';
                        opcionesHtml += '</label>';
                        opcionesHtml += '</div>';
                        opcionesHtml += '</div>';
                    });
                    
                    opcionesHtml += '</div>'; // cierre opciones-container
                    opcionesHtml += '</div>'; // cierre opcion-grupo-moderno
                });
                
                // Agregar controles móviles al final
                opcionesHtml += '<div class="bottom-controls d-lg-none mt-4">';
                opcionesHtml += '<div class="cantidad-controls mb-3">';
                opcionesHtml += '<div class="d-flex align-items-center justify-content-center gap-3">';
                opcionesHtml += '<button type="button" class="btn btn-outline-danger btn-cantidad" onclick="cambiarCantidad(-1)">';
                opcionesHtml += '<i class="fas fa-minus"></i>';
                opcionesHtml += '</button>';
                opcionesHtml += '<input type="number" class="form-control cantidad-input text-center" id="cantidad-mobile" min="1" value="1" readonly>';
                opcionesHtml += '<button type="button" class="btn btn-outline-success btn-cantidad" onclick="cambiarCantidad(1)">';
                opcionesHtml += '<i class="fas fa-plus"></i>';
                opcionesHtml += '</button>';
                opcionesHtml += '</div>';
                opcionesHtml += '</div>';
                
                opcionesHtml += '<div class="precio-total mb-3">';
                opcionesHtml += '<div class="text-center">';
                opcionesHtml += '<span class="fs-4 fw-bold text-success">Total: </span>';
                opcionesHtml += '<span id="precio-total-mobile" class="fs-4 fw-bold text-success">$' + parseFloat(producto.precio).toFixed(2) + '</span>';
                opcionesHtml += '</div>';
                opcionesHtml += '</div>';
                
                opcionesHtml += '<div class="d-flex flex-column flex-sm-row gap-3">';
                opcionesHtml += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">';
                opcionesHtml += '<i class="fas fa-times me-2"></i>Cancelar';
                opcionesHtml += '</button>';
                opcionesHtml += '<button type="submit" class="btn btn-success" id="btn-agregar-carrito" form="form-personalizar">';
                opcionesHtml += '<i class="fas fa-shopping-cart me-2"></i>Agregar al Carrito';
                opcionesHtml += '</button>';
                opcionesHtml += '</div>';
                
                opcionesHtml += '</div>';
                
            } else {
                console.log('ℹ️ Producto sin opciones adicionales');
                opcionesHtml = '<div class="text-center text-info py-4">' +
                              '<i class="fas fa-check-circle fa-3x mb-3"></i>' +
                              '<h5 class="mb-3">Producto listo para agregar</h5>' +
                              '<p class="mb-3">Este producto no requiere opciones adicionales.</p>' +
                              '<div class="d-grid d-lg-none">' +
                              '<button type="submit" class="btn btn-success btn-lg" form="form-personalizar">' +
                              '<i class="fas fa-shopping-cart me-2"></i>Agregar al Carrito' +
                              '</button>' +
                              '</div>' +
                              '</div>';
            }
            
            modalOpciones.innerHTML = opcionesHtml;
            
            // Actualizar el precio total inicial
            actualizarPrecioTotal();
            
            console.log('✅ Modal completamente cargado con opciones');
            console.log('🔍 Verificando elementos del formulario:');
            console.log('  - producto_id:', document.getElementById('producto_id').value);
            console.log('  - cantidad:', document.getElementById('cantidad').value);
            console.log('  - sucursal_id:', document.getElementById('sucursal_id').value);
            console.log('  - Formulario existe:', document.getElementById('form-personalizar') !== null);
            console.log('  - Opciones generadas:', modalOpciones.children.length);
        };
        
        // Función para seleccionar una opción (actualizada para diseño moderno)
        window.seleccionarOpcion = function(inputId, tipoInput, nombreInput) {
            var input = document.getElementById(inputId);
            if (!input) return;
            
            if (tipoInput === 'radio') {
                // Para radio buttons, deseleccionar otros del mismo grupo
                // El nombre del grupo es nombreInput para radio buttons
                var grupoInputs = document.querySelectorAll('input[name="' + nombreInput + '"]');
                grupoInputs.forEach(function(inp) {
                    inp.checked = false;
                    var container = inp.closest('.opcion-item-moderno');
                    if (container) {
                        container.classList.remove('selected');
                    }
                });
            }
            
            // Alternar selección
            if (tipoInput === 'checkbox') {
                input.checked = !input.checked;
            } else {
                input.checked = true;
            }
            
            // Actualizar estilo visual
            var opcionItem = input.closest('.opcion-item-moderno');
            if (opcionItem) {
                if (input.checked) {
                    opcionItem.classList.add('selected');
                } else {
                    opcionItem.classList.remove('selected');
                }
            }
            
            // Actualizar precio total
            actualizarPrecioTotal();
        };
        
        // Función para cambiar cantidad
        window.cambiarCantidad = function(delta) {
            var cantidadInput = document.getElementById('cantidad');
            var cantidadDisplay = document.getElementById('cantidad-display');
            var cantidadesMobile = document.querySelectorAll('#cantidad-mobile, .cantidad-display');
            
            var cantidadActual = parseInt(cantidadInput.value) || 1;
            var nuevaCantidad = Math.max(1, cantidadActual + delta);
            
            cantidadInput.value = nuevaCantidad;
            
            // Actualizar display principal
            if (cantidadDisplay) {
                cantidadDisplay.textContent = nuevaCantidad;
            }
            
            // Actualizar displays adicionales
            cantidadesMobile.forEach(function(el) {
                if (el.tagName === 'INPUT') {
                    el.value = nuevaCantidad;
                } else {
                    el.textContent = nuevaCantidad;
                }
            });
            
            actualizarPrecioTotal();
        };
        
        // Función para actualizar el precio total
        window.actualizarPrecioTotal = function() {
            var productoId = document.getElementById('producto_id').value;
            var producto = window.opcionesPorProducto.find(p => p.id == productoId);
            
            if (!producto) return;
            
            var precioBase = parseFloat(producto.precio);
            var precioOpciones = 0;
            var cantidad = parseInt(document.getElementById('cantidad').value) || 1;
            
            // Sumar precios de opciones seleccionadas
            var opcionesSeleccionadas = document.querySelectorAll('#modal-opciones input:checked');
            opcionesSeleccionadas.forEach(function(input) {
                var precio = parseFloat(input.dataset.precio) || 0;
                precioOpciones += precio;
            });
            
            var precioTotal = (precioBase + precioOpciones) * cantidad;
            
            // Actualizar displays de precio
            var precioElements = document.querySelectorAll('#precio-total-mobile, #precio-total-desktop');
            precioElements.forEach(function(el) {
                el.textContent = '$' + precioTotal.toFixed(2);
            });
        };
        
        // Función para mostrar toast de producto agregado
        window.mostrarToastProductoAgregado = function() {
            // Obtener información del producto desde el backend (si está disponible)
            fetch('/get_producto_agregado')
                .then(response => response.json())
                .then(data => {
                    if (data && data.nombre) {
                        // Crear y mostrar el toast
                        var toastHtml = `
                            <div class="toast toast-carrito border-0 shadow-lg show" role="alert" aria-live="assertive" aria-atomic="true" id="toast-producto-agregado">
                                <div class="toast-header border-0 pb-2" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                                    <div class="bg-white rounded-circle p-2 me-3">
                                        <i class="fas fa-check text-success"></i>
                                    </div>
                                    <div class="me-auto">
                                        <strong>¡Producto agregado!</strong>
                                        <div class="small opacity-75">Al carrito de compras</div>
                                    </div>
                                    <button type="button" class="btn-close btn-close-white" onclick="cerrarToast('toast-producto-agregado')" aria-label="Cerrar"></button>
                                </div>
                                <div class="toast-body pt-0" style="background: white;">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            ${data.imagen ? `<img src="${data.imagen}" alt="${data.nombre}" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">` : '<div class="bg-light rounded d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;"><i class="fas fa-utensils text-muted"></i></div>'}
                                        </div>
                                        <div class="flex-grow-1">
                                            <div class="fw-semibold">${data.nombre}</div>
                                            <div class="small text-muted">
                                                ${data.cantidad} × $${data.precio.toFixed(2)}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <a href="/carrito" class="btn btn-outline-success btn-sm me-2">
                                            <i class="fas fa-shopping-cart me-1"></i>Ver carrito
                                        </a>
                                        <button type="button" class="btn btn-success btn-sm" onclick="cerrarToast('toast-producto-agregado')">
                                            <i class="fas fa-plus me-1"></i>Seguir comprando
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Insertar el toast en el contenedor
                        var toastContainer = document.querySelector('.position-fixed.bottom-0.end-0');
                        if (toastContainer) {
                            toastContainer.innerHTML = toastHtml;
                            
                            // Auto-cerrar después de 5 segundos
                            setTimeout(function() {
                                cerrarToast('toast-producto-agregado');
                            }, 5000);
                        }
                        
                        // ACTUALIZAR EL CONTADOR RESPETANDO MÓVIL/ESCRITORIO
                        if (typeof window.actualizarCarritoHeader === 'function') {
                            console.log('🔄 Actualizando contador del carrito (respetando móvil/escritorio)...');
                            window.actualizarCarritoHeader();
                        } else {
                            console.warn('⚠️ Función actualizarCarritoHeader no disponible');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error al obtener información del producto agregado:', error);
                    // Toast de fallback
                    mostrarToastSimple('✅ Producto agregado al carrito');
                    
                    // Actualizar carrito incluso en caso de error
                    if (typeof window.actualizarCarritoHeader === 'function') {
                        window.actualizarCarritoHeader();
                    }
                });
        };
        
        // Función para cerrar toast
        window.cerrarToast = function(toastId) {
            var toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.remove('show');
                setTimeout(function() {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        };
        
        // Función para toast simple de fallback
        window.mostrarToastSimple = function(mensaje) {
            var toastHtml = `
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" id="toast-simple">
                    <div class="toast-header" style="background: #28a745; color: white;">
                        <strong class="me-auto">${mensaje}</strong>
                        <button type="button" class="btn-close btn-close-white" onclick="cerrarToast('toast-simple')" aria-label="Cerrar"></button>
                    </div>
                </div>
            `;
            
            var toastContainer = document.querySelector('.position-fixed.bottom-0.end-0');
            if (toastContainer) {
                toastContainer.innerHTML = toastHtml;
                setTimeout(function() {
                    cerrarToast('toast-simple');
                }, 3000);
            }
            
            // ACTUALIZAR EL CONTADOR RESPETANDO MÓVIL/ESCRITORIO
            if (typeof window.actualizarCarritoHeader === 'function') {
                console.log('🔄 Actualizando contador del carrito (toast simple - respetando móvil/escritorio)...');
                window.actualizarCarritoHeader();
            }
        };
        
        console.log('✅ Funciones de modal completo cargadas');
        
        // Verificar si se agregó un producto al carrito
        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('agregado') === '1') {
            // Mostrar toast de producto agregado
            setTimeout(function() {
                mostrarToastProductoAgregado();
                // Limpiar el parámetro de la URL sin recargar
                window.history.replaceState({}, document.title, window.location.pathname);
            }, 500);
        }
        
        // Event listener para el formulario de personalizar
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar contador del carrito al cargar la página (respetando móvil/escritorio)
            if (typeof window.actualizarCarritoHeader === 'function') {
                console.log('🔄 Inicializando contador del carrito (respetando móvil/escritorio)...');
                window.actualizarCarritoHeader();
            }
            
            // Agregar listener al formulario cuando se cargue
            setTimeout(function() {
                var form = document.getElementById('form-personalizar');
                if (form) {
                    form.addEventListener('submit', function(e) {
                        console.log('📤 Enviando formulario...');
                        
                        // Debug: mostrar todos los datos del formulario
                        var formData = new FormData(form);
                        console.log('📋 Datos del formulario:');
                        var tieneOpciones = false;
                        var opcionesPorTipo = { radio: 0, checkbox: 0 };
                        
                        for (let [key, value] of formData.entries()) {
                            console.log('  ' + key + ': ' + value);
                            if (key.startsWith('opcion_')) {
                                tieneOpciones = true;
                                // Determinar tipo por el nombre del campo
                                if (key.includes('[]')) {
                                    opcionesPorTipo.checkbox++;
                                } else {
                                    opcionesPorTipo.radio++;
                                }
                            }
                        }
                        
                        console.log('📊 Resumen de opciones enviadas:');
                        console.log('  - Radio buttons:', opcionesPorTipo.radio);
                        console.log('  - Checkboxes:', opcionesPorTipo.checkbox);
                        console.log('  - Total opciones:', tieneOpciones);
                        
                        // Verificar que los datos obligatorios estén presentes
                        var productoId = formData.get('producto_id');
                        var cantidad = formData.get('cantidad');
                        var sucursalId = formData.get('sucursal_id');
                        
                        console.log('✅ Verificación de datos:');
                        console.log('  - producto_id:', productoId);
                        console.log('  - cantidad:', cantidad);
                        console.log('  - sucursal_id:', sucursalId);
                        console.log('  - tiene opciones seleccionadas:', tieneOpciones);
                        
                        if (!productoId || !cantidad || !sucursalId) {
                            e.preventDefault();
                            alert('Error: Faltan datos obligatorios del producto');
                            return false;
                        }
                        
                        // Advertencia si no hay opciones obligatorias seleccionadas
                        var opcionesObligatorias = document.querySelectorAll('.opcion-grupo-moderno[data-obligatorio="true"]');
                        var faltanObligatorias = false;
                        
                        opcionesObligatorias.forEach(function(grupo) {
                            var inputsEnGrupo = grupo.querySelectorAll('input[type="radio"], input[type="checkbox"]');
                            var algunoSeleccionado = false;
                            inputsEnGrupo.forEach(function(input) {
                                if (input.checked) {
                                    algunoSeleccionado = true;
                                }
                            });
                            if (!algunoSeleccionado) {
                                faltanObligatorias = true;
                                console.warn('⚠️ Falta seleccionar opción obligatoria en grupo:', grupo);
                            }
                        });
                        
                        if (faltanObligatorias) {
                            e.preventDefault();
                            alert('Por favor selecciona todas las opciones obligatorias');
                            return false;
                        }
                        
                        console.log('✅ Formulario válido, enviando...');
                    });
                } else {
                    console.error('❌ No se encontró el formulario form-personalizar');
                }
            }, 1000);
        });
    </script>

    <!-- Filtros de Categorías -->
    <div class="categories-section mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="categories-container">
                    <!-- Botón "Todos" -->
                    <div class="category-item">
                        <button class="category-btn active" data-categoria="todos" onclick="filtrarPorCategoria('todos')">
                            <div class="category-icon">
                                <i class="fas fa-th-large"></i>
                            </div>
                            <span class="category-name">Todos</span>
                            <span class="category-count" id="count-todos">{{ productos|length }}</span>
                        </button>
                        <span class="category-label-mobile">Todos</span>
                    </div>

                    <!-- Categorías dinámicas -->
                    {% for categoria in categorias %}
                    <div class="category-item">
                        <button class="category-btn" data-categoria="{{ categoria.id }}" onclick="filtrarPorCategoria('{{ categoria.id }}')">
                            <div class="category-icon">
                                {% if categoria.nombre|lower == 'pozoles' %}
                                    <i class="fas fa-bowl-hot"></i>
                                {% elif categoria.nombre|lower == 'bebidas' %}
                                    <i class="fas fa-coffee"></i>
                                {% elif categoria.nombre|lower == 'antojitos' %}
                                    <i class="fas fa-cookie-bite"></i>
                                {% elif categoria.nombre|lower == 'postres' %}
                                    <i class="fas fa-ice-cream"></i>
                                {% else %}
                                    <i class="fas fa-utensils"></i>
                                {% endif %}
                            </div>
                            <span class="category-name">{{ categoria.nombre }}</span>
                            <span class="category-count" id="count-{{ categoria.id }}">
                                {{ productos|selectattr('categoria_id', 'equalto', categoria.id)|list|length }}
                            </span>
                        </button>
                        <span class="category-label-mobile">{{ categoria.nombre }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Productos -->
    <div class="products-section">
        <div class="row" id="productos-lista">
        {% for p in productos %}
        <div class="col-lg-4 col-md-6 mb-4 producto-item" 
             data-sucursales="{{ p.sucursales|join(',') }}" 
             data-categoria="{{ p.categoria_id or 'sin-categoria' }}">
            <div class="card h-100 shadow-sm producto-card" data-producto-id="{{ p.id }}" style="cursor:pointer;">
                {% if p.imagen %}
                <div class="card-img-container">
                    <img src="{{ p.imagen }}" class="card-img-top" alt="{{ p.nombre }}">
                    <div class="category-badge">
                        <i class="fas fa-tag me-1"></i>{{ p.categoria_nombre }}
                    </div>
                </div>
                {% endif %}
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ p.nombre }}</h5>
                    <p class="card-text">{{ p.descripcion }}</p>
                    <div class="mb-2">
                        <span class="fw-bold text-success" style="font-size:1.2em;">
                            ${{ "%.2f"|format(p['precio']|float) }}
                        </span>
                    </div>
                    <button class="btn btn-agregar-menu w-100 mt-auto agregar-btn" onclick="abrirModal({{ p.id }});event.stopPropagation();">
                        <span class="agregar-text">Agregar</span>
                        <span class="agregar-icon"><i class="bi bi-cart-plus-fill"></i></span>
                        <span class="agregar-ripple"></span>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    </div>
    <!-- Modal para personalizar producto -->
    <div class="modal fade" id="modalProducto" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-fullscreen-md-down modal-xl modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content modal-content-moderno">
          <div class="modal-body p-0">
            <div class="row g-0 h-100">
              <!-- COLUMNA IZQUIERDA - IMAGEN -->
              <div class="col-lg-6">
                <div class="imagen-producto-container">
                  <button type="button" class="btn-close-moderno" data-bs-dismiss="modal" aria-label="Cerrar">
                    <i class="fas fa-times"></i>
                  </button>
                  <div id="modal-img-container" class="imagen-principal">
                    <!-- La imagen se carga dinámicamente aquí -->
                  </div>
                </div>
              </div>
              
              <!-- COLUMNA DERECHA - INFORMACIÓN Y OPCIONES -->
              <div class="col-lg-6">
                <div class="contenido-producto">
                  <!-- Formulario de opciones con información del producto incluida -->
                  <div class="opciones-scroll-container-completo">
                    <form id="form-personalizar" method="post" action="{{ url_for('agregar_carrito') }}">
                      <input type="hidden" name="producto_id" id="producto_id">
                      <input type="hidden" name="cantidad" id="cantidad" value="1">
                      <input type="hidden" name="sucursal_id" id="sucursal_id" value="">
                      
                      <!-- Header del producto dentro del área scrolleable -->
                      <div class="producto-header-scroll">
                        <h2 id="modal-nombre" class="producto-titulo-scroll"></h2>
                        <div class="producto-precio-scroll">
                          <span id="modal-precio" class="precio-base-scroll">$0.00</span>
                        </div>
                        <p id="modal-descripcion" class="producto-descripcion-scroll"></p>
                      </div>
                      
                      <div id="modal-opciones" class="opciones-modernas">
                        <!-- Las opciones se cargan dinámicamente aquí -->
                      </div>
                    </form>
                  </div>
                  
                  <!-- Controles inferiores -->
                  <div class="controles-inferiores">
                    <div class="cantidad-y-precio">
                      <div class="cantidad-controls-moderno">
                        <button type="button" class="btn-cantidad-moderno" onclick="cambiarCantidad(-1)">
                          <i class="fas fa-minus"></i>
                        </button>
                        <span class="cantidad-display-moderno" id="cantidad-display">1</span>
                        <button type="button" class="btn-cantidad-moderno" onclick="cambiarCantidad(1)">
                          <i class="fas fa-plus"></i>
                        </button>
                      </div>
                      
                      <div class="precio-total-moderno">
                        <span id="precio-total-desktop" class="precio-final">$0.00</span>
                      </div>
                    </div>
                    
                    <button type="submit" class="btn-agregar-moderno" form="form-personalizar">
                      <i class="fas fa-shopping-cart me-2"></i>Agregar al Carrito
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Toast profesional para "Agregado al carrito" -->
    <div class="position-fixed bottom-0 end-0 p-4" style="z-index: 2000;">
        <div id="toastCarrito" class="toast toast-carrito border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header border-0 pb-2">
                <div class="bg-success rounded-circle p-2 me-3">
                    <i class="fas fa-check text-white"></i>
                </div>
                <div class="me-auto">
                    <strong class="text-success">¡Producto agregado!</strong>
                    <div class="small text-muted">Al carrito de compras</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
            <div class="toast-body pt-0">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <img id="toast-producto-img" src="" alt="" class="rounded" style="width: 50px; height: 50px; object-fit: cover;">
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-semibold" id="toast-producto-nombre"></div>
                        <div class="small text-muted">
                            <span id="toast-producto-cantidad"></span> × <span id="toast-producto-precio"></span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <a href="/carrito" class="btn btn-outline-success btn-sm me-2">
                        <i class="fas fa-shopping-cart me-1"></i>Ver carrito
                    </a>
                    <button type="button" class="btn btn-success btn-sm" data-bs-dismiss="toast">
                        <i class="fas fa-plus me-1"></i>Seguir comprando
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contenedor para modales dinámicos -->
<div id="modalContainer"></div>

<style>
.btn-cancelar {
    background: linear-gradient(90deg, #ff5858 0%, #f09819 100%);
    color: #fff;
    font-weight: bold;
    border: none;
    box-shadow: 0 2px 8px rgba(255,88,88,0.15);
    transition: box-shadow 0.2s, background 0.2s;
}
.btn-cancelar:hover, .btn-cancelar:focus {
    background: linear-gradient(90deg, #f09819 0%, #ff5858 100%);
    box-shadow: 0 4px 16px rgba(255,88,88,0.25);
    color: #fff;
}
.btn-agregar {
    background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
    color: #fff;
    font-weight: bold;
    border: none;
    box-shadow: 0 2px 8px rgba(67,233,123,0.15);
    position: relative;
    overflow: hidden;
    transition: box-shadow 0.2s, background 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}
.btn-agregar:hover, .btn-agregar:focus {
    background: linear-gradient(90deg, #38f9d7 0%, #43e97b 100%);
    box-shadow: 0 4px 16px rgba(67,233,123,0.25);
    color: #fff;
}
.btn-agregar-menu {
    background: linear-gradient(90deg, #ffb347 0%, #ffcc33 100%);
    color: #fff;
    font-weight: bold;
    border: none;
    position: relative;
    overflow: hidden;
    transition: box-shadow 0.2s, transform 0.2s;
    box-shadow: 0 2px 8px rgba(255,204,51,0.15);
    font-size: 1.2em;
    letter-spacing: 0.5px;
    border-radius: 30px;
    padding: 0.7em 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}
.btn-agregar-menu:hover, .btn-agregar-menu:focus {
    background: linear-gradient(90deg, #ffcc33 0%, #ffb347 100%);
    box-shadow: 0 4px 16px rgba(255,204,51,0.25);
    color: #fff;
    transform: scale(1.04);
}
.btn-agregar .agregar-icon, .btn-agregar-menu .agregar-icon {
    font-size: 1.3em;
    vertical-align: middle;
    transition: transform 0.2s;
}
.btn-agregar:active .agregar-icon, .btn-agregar-menu:active .agregar-icon {
    transform: scale(1.2) rotate(-10deg);
}
.agregar-btn .agregar-icon {
    margin-left: 8px;
    font-size: 1.3em;
    vertical-align: middle;
    transition: transform 0.2s;
}
.agregar-btn:active .agregar-icon {
    transform: scale(1.2) rotate(-10deg);
}
.agregar-btn .agregar-ripple {
    position: absolute;
    border-radius: 50%;
    transform: scale(0);
    animation: ripple 0.6s linear;
    background: rgba(56,249,215,0.3);
    pointer-events: none;
    width: 100px;
    height: 100px;
    left: 50%;
    top: 50%;
    z-index: 1;
}
.btn-agregar-menu .agregar-ripple {
    position: absolute;
    border-radius: 50%;
    transform: scale(0);
    animation: ripple 0.6s linear;
    background: rgba(255,204,51,0.3);
    pointer-events: none;
    width: 100px;
    height: 100px;
    left: 50%;
    top: 50%;
    z-index: 1;
}
@keyframes ripple {
    to {
        transform: scale(2.5);
        opacity: 0;
    }
}

/* Estilos para el modal profesional */
.modal-xl {
    max-width: 1200px;
    width: 90%;
}

/* ===== MODAL DESKTOP PROFESIONAL (992px+) ===== */
@media (min-width: 992px) {
    .modal-xl {
        max-width: 1100px !important;
        width: 90% !important;
    }
    
    .modal-fullscreen-md-down {
        width: auto !important;
        max-width: 1100px !important;
        height: auto !important;
        margin: 2rem auto !important;
        background: rgba(0,0,0,0.75) !important;
        backdrop-filter: blur(8px) !important;
    }
    
    .modal-fullscreen-md-down .modal-content {
        border: none !important;
        border-radius: 16px !important;
        height: auto !important;
        max-height: 85vh !important;
        min-height: 650px !important;
        display: flex !important;
        flex-direction: column !important;
        box-shadow: 0 25px 50px rgba(0,0,0,0.3) !important;
        overflow: hidden !important;
        background: white !important;
    }
    
    .modal-fullscreen-md-down .modal-body {
        padding: 0 !important;
        flex: 1 !important;
        display: flex !important;
        flex-direction: row !important;
        min-height: 620px !important;
    }
    
    .modal-fullscreen-md-down .row {
        margin: 0 !important;
        flex: 1 !important;
        display: flex !important;
        min-height: 100% !important;
    }
    
    /* COLUMNA IZQUIERDA - IMAGEN Y CONTROLES */
    .modal-fullscreen-md-down .col-lg-5 {
        flex: 0 0 42% !important;
        max-width: 42% !important;
        padding: 25px !important;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        border-right: 1px solid #dee2e6 !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: space-between !important;
    }
    
    .modal-fullscreen-md-down .col-lg-5 img {
        width: 100% !important;
        height: auto !important;
        max-height: 300px !important;
        object-fit: cover !important;
        border-radius: 12px !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2) !important;
        margin-bottom: 20px !important;
    }
    
    .modal-fullscreen-md-down .col-lg-5 .controls-section {
        background: white !important;
        padding: 20px !important;
        border-radius: 12px !important;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
        border: 1px solid #e9ecef !important;
        margin-top: auto !important;
    }
    
    /* COLUMNA DERECHA - INFORMACIÓN Y OPCIONES */
    .modal-fullscreen-md-down .col-lg-7 {
        flex: 0 0 58% !important;
        max-width: 58% !important;
        padding: 0 !important;
        display: flex !important;
        flex-direction: column !important;
    }
    
    /* HEADER DEL PRODUCTO */
    .modal-fullscreen-md-down .product-header {
        background: linear-gradient(135deg, #e97c1a 0%, #d67a1a 100%) !important;
        color: white !important;
        padding: 25px 30px !important;
        border-bottom: 3px solid #c56e17 !important;
    }
    
    .modal-fullscreen-md-down .product-header h5 {
        font-size: 1.6rem !important;
        font-weight: 700 !important;
        margin-bottom: 10px !important;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
    }
    
    .modal-fullscreen-md-down .product-header .precio-base {
        font-size: 1.3rem !important;
        font-weight: 600 !important;
        background: rgba(255,255,255,0.2) !important;
        padding: 8px 15px !important;
        border-radius: 20px !important;
        display: inline-block !important;
    }
    
    /* ÁREA DE OPCIONES SCROLLEABLE */
    .modal-fullscreen-md-down .opciones-section {
        flex: 1 !important;
        padding: 30px !important;
        overflow-y: auto !important;
        background: #fafbfc !important;
        scrollbar-width: thin !important;
        scrollbar-color: #e97c1a #f1f3f4 !important;
    }
    
    .modal-fullscreen-md-down .opciones-section::-webkit-scrollbar {
        width: 8px !important;
    }
    
    .modal-fullscreen-md-down .opciones-section::-webkit-scrollbar-track {
        background: #f1f3f4 !important;
        border-radius: 4px !important;
    }
    
    .modal-fullscreen-md-down .opciones-section::-webkit-scrollbar-thumb {
        background: #e97c1a !important;
        border-radius: 4px !important;
    }
    
    .modal-fullscreen-md-down .opciones-section::-webkit-scrollbar-thumb:hover {
        background: #d67a1a !important;
    }
    
    /* TÍTULOS DE OPCIONES */
    .modal-fullscreen-md-down .opciones-personalizadas h6 {
        color: #2c3e50 !important;
        font-weight: 600 !important;
        font-size: 1.1rem !important;
        margin-bottom: 15px !important;
        padding-bottom: 8px !important;
        border-bottom: 2px solid #e97c1a !important;
        display: inline-block !important;
    }
    
    /* OPCIONES CLICKEABLES SIN CHECKBOXES */
    .modal-fullscreen-md-down .opcion-item {
        background: white !important;
        border: 2px solid #e9ecef !important;
        border-radius: 10px !important;
        padding: 15px 18px !important;
        margin-bottom: 10px !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        user-select: none !important;
    }
    
    .modal-fullscreen-md-down .opcion-item:hover {
        border-color: #e97c1a !important;
        background: #fff8f0 !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(233, 124, 26, 0.15) !important;
    }
    
    .modal-fullscreen-md-down .opcion-item.selected {
        border-color: #e97c1a !important;
        background: linear-gradient(135deg, #fff8f0 0%, #fef4e7 100%) !important;
        box-shadow: 0 6px 25px rgba(233, 124, 26, 0.25) !important;
    }
    
    .modal-fullscreen-md-down .opcion-item .opcion-texto {
        font-weight: 500 !important;
        color: #2c3e50 !important;
        font-size: 1rem !important;
    }
    
    .modal-fullscreen-md-down .opcion-item .opcion-precio {
        color: #e97c1a !important;
        font-weight: 600 !important;
        font-size: 0.95rem !important;
    }
    
    /* OCULTAR INPUTS EN DESKTOP */
    .modal-fullscreen-md-down input[type="checkbox"],
    .modal-fullscreen-md-down input[type="radio"] {
        display: none !important;
    }
    
    .modal-fullscreen-md-down .form-check-input {
        display: none !important;
    }
    
    .modal-fullscreen-md-down .form-check-label {
        margin: 0 !important;
        padding: 0 !important;
        width: 100% !important;
        cursor: pointer !important;
    }
    
    /* CONTROLES DE CANTIDAD Y TOTAL */
    .modal-fullscreen-md-down .cantidad-controls {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 15px !important;
        margin-bottom: 20px !important;
    }
    
    .modal-fullscreen-md-down .cantidad-controls .btn {
        width: 40px !important;
        height: 40px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        font-weight: 700 !important;
        transition: all 0.3s ease !important;
    }
    
    .modal-fullscreen-md-down .cantidad-controls .cantidad-display {
        font-size: 1.3rem !important;
        font-weight: 700 !important;
        color: #2c3e50 !important;
        min-width: 50px !important;
        text-align: center !important;
    }
    
    .modal-fullscreen-md-down .total-precio {
        font-size: 1.5rem !important;
        font-weight: 700 !important;
        color: #e97c1a !important;
        text-align: center !important;
        margin-bottom: 15px !important;
    }
    
    .modal-fullscreen-md-down .btn-agregar-carrito {
        background: linear-gradient(135deg, #e97c1a 0%, #d67a1a 100%) !important;
        border: none !important;
        color: white !important;
        font-size: 1.1rem !important;
        padding: 12px 25px !important;
        width: 100% !important;
        border-radius: 10px !important;
        text-transform: uppercase !important;
        font-weight: 700 !important;
        letter-spacing: 0.5px !important;
        transition: all 0.3s ease !important;
    }
    
    .modal-fullscreen-md-down .btn-agregar-carrito:hover {
        background: linear-gradient(135deg, #d67a1a 0%, #c56e17 100%) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(233, 124, 26, 0.4) !important;
    }
}


    
    #btn-agregar-carrito:hover {
        background: linear-gradient(135deg, #d86b1a, #e6850e) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 6px 20px rgba(233, 124, 26, 0.4) !important;
    }
    
    .bottom-controls .d-flex {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    .bottom-controls .btn {
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
}

@media (min-width: 1200px) {
    .modal-xl {
        max-width: 1200px;
        width: 80%;
    }
}

/* Modal fullscreen para móviles */
@media (max-width: 767.98px) {
    .modal-fullscreen-md-down {
        width: 100vw !important;
        max-width: none !important;
        height: 100vh !important;
        margin: 0 !important;
    }
    
    .modal-fullscreen-md-down .modal-content {
        border: 0;
        border-radius: 0 !important;
        height: 100vh !important;
        max-height: 100vh !important;
        display: flex !important;
        flex-direction: column !important;
    }
    
    .modal-fullscreen-md-down .modal-body {
        height: 100vh !important;
        overflow: hidden !important;
        padding: 0 !important;
        display: flex !important;
        flex-direction: column !important;
    }
    
    .modal-fullscreen-md-down .row {
        height: 100vh !important;
        flex-direction: column !important;
        margin: 0 !important;
        flex: 1 !important;
    }
    
    .modal-fullscreen-md-down .col-lg-5 {
        height: 15vh !important; /* Reducir drásticamente de 35vh a 15vh */
        min-height: 15vh !important;
        max-height: 15vh !important;
        flex: none !important;
        width: 100% !important;
        padding: 5px !important; /* Reducir padding */
    }
    
    .modal-fullscreen-md-down .col-lg-7 {
        height: 85vh !important; /* Aumentar de 65vh a 85vh */
        min-height: 85vh !important;
        max-height: 85vh !important;
        flex: 1 !important;
        width: 100% !important;
        display: flex !important;
        flex-direction: column !important;
        padding: 0 !important;
        position: relative !important;
    }
    
    /* Imagen del producto más pequeña en móvil */
    .modal-fullscreen-md-down .col-lg-5 img {
        width: 100% !important;
        height: 100% !important;
        max-height: calc(15vh - 10px) !important;
        object-fit: cover !important;
        border-radius: 8px !important;
    }
    
    /* Contenedor de contenido scrolleable */
    .modal-fullscreen-md-down .col-lg-7 > div {
        display: flex !important;
        flex-direction: column !important;
        height: 100% !important;
        padding: 10px !important; /* Reducir padding de 15px a 10px */
        padding-bottom: 90px !important; /* Reducir espacio para botones de 100px a 90px */
    }
    
    /* Header del producto fijo */
    .modal-fullscreen-md-down .product-header {
        position: sticky !important;
        top: 0 !important;
        background: white !important;
        z-index: 1010 !important;
        margin-bottom: 10px !important; /* Reducir de 15px a 10px */
        padding: 10px 0 8px 0 !important; /* Reducir padding */
        border-bottom: 2px solid #f8f9fa !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1) !important;
    }
    
    /* Área de opciones scrolleable */
    .modal-fullscreen-md-down .opciones-container,
    .modal-fullscreen-md-down #wizard-container {
        flex: 1 !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        margin-bottom: 15px !important;
        padding-right: 10px !important;
        scrollbar-width: thin !important;
        scrollbar-color: #e97c1a #f8f9fa !important;
    }
    
    /* Personalizar scrollbar para móvil */
    .modal-fullscreen-md-down .opciones-container::-webkit-scrollbar,
    .modal-fullscreen-md-down #wizard-container::-webkit-scrollbar {
        width: 6px !important;
    }
    
    .modal-fullscreen-md-down .opciones-container::-webkit-scrollbar-track,
    .modal-fullscreen-md-down #wizard-container::-webkit-scrollbar-track {
        background: #f8f9fa !important;
        border-radius: 3px !important;
    }
    
    .modal-fullscreen-md-down .opciones-container::-webkit-scrollbar-thumb,
    .modal-fullscreen-md-down #wizard-container::-webkit-scrollbar-thumb {
        background: #e97c1a !important;
        border-radius: 3px !important;
    }
    
    /* Botones fijos en la parte inferior */
    .modal-fullscreen-md-down .bottom-controls {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        background: white !important;
        padding: 15px !important;
        border-top: 3px solid #e97c1a !important;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.15) !important;
        z-index: 1020 !important;
        margin: 0 !important;
        border-radius: 0 !important;
        max-height: 180px !important;
        min-height: 160px !important;
    }
    
    /* Controles de cantidad y precio en una fila */
    .modal-fullscreen-md-down .bottom-controls .row {
        margin: 0 !important;
        height: auto !important;
        flex-direction: row !important;
        align-items: center !important;
        margin-bottom: 15px !important;
    }
    
    .modal-fullscreen-md-down .bottom-controls .col-md-6 {
        flex: 1 !important;
        text-align: center !important;
        margin-bottom: 0 !important;
        padding: 5px !important;
    }
    
    /* Controles de cantidad más compactos */
    .modal-fullscreen-md-down .cantidad-controls {
        justify-content: center !important;
        max-width: none !important;
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
    }
    
    .modal-fullscreen-md-down .btn-cantidad {
        width: 35px !important;
        height: 35px !important;
        font-size: 14px !important;
        border-radius: 50% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .modal-fullscreen-md-down .cantidad-input {
        max-width: 50px !important;
        font-size: 16px !important;
        text-align: center !important;
        font-weight: bold !important;
        border-radius: 8px !important;
        height: 35px !important;
    }
    
    /* Precio total destacado */
    .modal-fullscreen-md-down .precio-total {
        padding: 10px !important;
        margin: 0 !important;
        border-radius: 10px !important;
        background: linear-gradient(135deg, #f8f9fa, #ffffff) !important;
        border: 2px solid #e97c1a !important;
    }
    
    .modal-fullscreen-md-down .precio-total .fs-3 {
        font-size: 1.4rem !important;
        color: #e97c1a !important;
        font-weight: bold !important;
        margin: 0 !important;
    }
    
    /* Botones de acción fijos */
    .modal-fullscreen-md-down .bottom-controls .d-flex:last-child {
        display: flex !important;
        gap: 10px !important;
        flex-direction: row !important;
        margin-top: 10px !important;
    }
    
    .modal-fullscreen-md-down .bottom-controls .btn {
        flex: 1 !important;
        padding: 12px 8px !important;
        font-size: 14px !important;
        font-weight: bold !important;
        border-radius: 25px !important;
        min-height: 45px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }
    
    /* Estilo específico para botón cancelar */
    .modal-fullscreen-md-down .btn-cancelar {
        background: linear-gradient(135deg, #6c757d, #495057) !important;
        border: none !important;
        color: white !important;
        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3) !important;
    }
    
    /* Estilo específico para botón agregar */
    .modal-fullscreen-md-down .btn-agregar {
        background: linear-gradient(135deg, #e97c1a, #ffcc33) !important;
        border: none !important;
        color: white !important;
        box-shadow: 0 4px 15px rgba(233, 124, 26, 0.3) !important;
    }
    
    /* Botón cerrar reposicionado */
    .modal-fullscreen-md-down .btn-close {
        position: fixed !important;
        top: 15px !important;
        right: 15px !important;
        font-size: 1.2rem !important;
        z-index: 1050 !important;
        background: rgba(255, 255, 255, 0.9) !important;
        border-radius: 50% !important;
        width: 40px !important;
        height: 40px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important;
    }
    
    /* Mensaje de error fijo */
    .modal-fullscreen-md-down #mensaje-obligatorio {
        position: fixed !important;
        bottom: 180px !important;
        left: 15px !important;
        right: 15px !important;
        z-index: 1015 !important;
        border-radius: 10px !important;
        font-size: 14px !important;
        padding: 12px !important;
        text-align: center !important;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3) !important;
    }
}

.product-header {
    border-bottom: 2px solid #f8f9fa;
    padding-bottom: 20px;
}

.opciones-container {
    padding-right: 10px;
}

.opciones-container::-webkit-scrollbar {
    width: 6px;
}

.opciones-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.opciones-container::-webkit-scrollbar-thumb {
    background: var(--pozoleria-orange);
    border-radius: 10px;
}

.opcion-group {
    background: #f8f9fc;
    border: 2px solid #e9ecef;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.opcion-group.error {
    border-color: #dc3545;
    background: #fff5f5;
    animation: pulse-error 1s ease-in-out;
}

.opcion-group.error .opcion-title {
    color: #dc3545;
}

.opcion-group.error .badge {
    background-color: #dc3545 !important;
    animation: flash 0.5s ease-in-out 3;
}

@keyframes pulse-error {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

@keyframes flash {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.opcion-group:hover {
    border-color: var(--pozoleria-orange);
    box-shadow: 0 4px 15px rgba(233, 124, 26, 0.1);
}

.opcion-title {
    color: #495057;
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.opcion-subtitle {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 15px;
    font-style: italic;
}

.opcion-item {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.opcion-item:hover {
    border-color: var(--pozoleria-orange);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.opcion-item.selected {
    border-color: var(--pozoleria-orange);
    background: linear-gradient(45deg, rgba(233, 124, 26, 0.1), rgba(233, 124, 26, 0.05));
}

.opcion-item.error {
    border-color: #dc3545;
    background: linear-gradient(45deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
}

.opcion-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(233, 124, 26, 0.1), transparent);
    transition: left 0.5s;
}

.opcion-item:hover::before {
    left: 100%;
}

.form-check-input {
    margin-top: 2px;
    margin-right: 12px;
    width: 20px;
    height: 20px;
    flex-shrink: 0;
}

.form-check-input:checked {
    background-color: var(--pozoleria-orange);
    border-color: var(--pozoleria-orange);
}

.form-check-label {
    font-weight: 500;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    line-height: 1.2;
}

.form-check {
    display: flex;
    align-items: flex-start;
    gap: 10px;
}

.opcion-precio {
    color: var(--pozoleria-orange);
    font-weight: 700;
    margin-left: auto;
    flex-shrink: 0;
}

.cantidad-controls {
    max-width: 200px;
}

.btn-cantidad {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    transition: all 0.3s ease;
}

.btn-cantidad:hover {
    transform: scale(1.1);
}

.cantidad-input {
    border-radius: 15px;
    font-size: 1.2rem;
    font-weight: 700;
    border: 2px solid #e9ecef;
    max-width: 80px;
}

.cantidad-input:focus {
    border-color: var(--pozoleria-orange);
    box-shadow: 0 0 0 0.2rem rgba(233, 124, 26, 0.25);
}

.precio-total {
    padding: 15px;
    background: linear-gradient(45deg, #f8f9fa, #ffffff);
    border-radius: 15px;
    border: 2px solid #e9ecef;
}

.bottom-controls {
    background: white;
    border-top: 2px solid #f8f9fa;
    padding-top: 20px;
    margin-top: 20px;
}

/* Responsive mejoras */
@media (max-width: 1199px) {
    .modal-xl {
        width: 90%;
        max-width: 900px;
    }
}

@media (max-width: 991px) {
    .modal-xl {
        width: 95%;
        max-width: none;
        margin: 20px auto;
    }
    
    /* Layout vertical en tablets */
    .modal-content .row {
        flex-direction: column;
    }
    
    .modal-content .col-lg-5,
    .modal-content .col-lg-7 {
        max-width: 100%;
        flex: 0 0 auto;
    }
    
    /* Altura fija para imagen en tablets */
    .modal-content .col-lg-5 {
        min-height: 250px;
        max-height: 300px;
    }
    
    .opciones-container {
        max-height: 350px;
    }
}

}

@media (max-width: 576px) {
    .modal-xl {
        width: 100%;
        margin: 5px auto;
        max-height: 98vh;
    }
    
    .modal-content {
        border-radius: 15px !important;
        max-height: 98vh;
    }
    
    /* Imagen aún más pequeña */
    .modal-content .col-lg-5 {
        min-height: 150px;
        max-height: 150px;
    }
    
    /* Padding más pequeño */
    .modal-content .col-lg-7 .p-4 {
        padding: 1rem !important;
    }
    
    .product-header h2 {
        font-size: 1.2rem !important;
    }
    
    .opciones-container {
        max-height: 250px;
    }
    
    /* Badges más pequeños */
    .product-header .badge {
        font-size: 0.7rem !important;
        padding: 4px 8px !important;
    }
    
    /* Formulario más compacto */
    .form-check-label {
        font-size: 0.9rem;
    }
    
    .opcion-precio {
        font-size: 0.85rem !important;
    }
    
    /* Layout de una columna para controles */
    .bottom-controls .row {
        flex-direction: column;
    }
    
    .bottom-controls .col-md-6 {
        width: 100%;
        text-align: center !important;
        margin-bottom: 1rem;
    }
}

/* Estilos para el toast del carrito */
.toast-carrito {
    background: #fff;
    border-radius: 16px;
    min-width: 350px;
    max-width: 400px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15) !important;
    border: 1px solid rgba(0,0,0,0.05);
    animation: slideInUp 0.4s ease-out;
}

.toast-carrito .toast-header {
    background: #fff;
    border-radius: 16px 16px 0 0;
    padding: 1rem 1rem 0.5rem 1rem;
}

.toast-carrito .toast-body {
    padding: 0 1rem 1rem 1rem;
}

.toast-carrito .bg-success {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.toast-carrito .btn-outline-success {
    border-color: #28a745;
    color: #28a745;
    transition: all 0.3s ease;
}

.toast-carrito .btn-outline-success:hover {
    background: #28a745;
    border-color: #28a745;
    color: #fff;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
}

.toast-carrito .btn-success {
    background: linear-gradient(135deg, #28a745, #20c997);
    border: none;
    transition: all 0.3s ease;
}

.toast-carrito .btn-success:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 16px rgba(40, 167, 69, 0.4);
}

@keyframes slideInUp {
    from {
        transform: translateY(100px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Responsive para móviles */
@media (max-width: 768px) {
    .toast-carrito {
        min-width: 300px;
        max-width: 90vw;
    }
}

/* ========== ESTILOS DEL WIZARD PASO A PASO ========== */

.progress-indicator {
    margin-bottom: 2rem;
}

.step-circle {
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.step-circle.completed {
    background: #28a745 !important;
    border-color: #28a745 !important;
    color: white !important;
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.step-circle.active {
    background: #e97c1a !important;
    border-color: #e97c1a !important;
    color: white !important;
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(233, 124, 26, 0.3);
}

.wizard-step {
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.4s ease;
}

.wizard-step.active {
    opacity: 1;
    transform: translateY(0);
}

.wizard-option {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.wizard-option::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(233, 124, 26, 0.1), transparent);
    transition: left 0.5s;
    z-index: 1;
}

.wizard-option:hover::before {
    left: 100%;
}

.wizard-option:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-color: #e97c1a !important;
}

.wizard-option.selected {
    border-color: #e97c1a !important;
    background: rgba(233, 124, 26, 0.1) !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(233, 124, 26, 0.2);
}

.wizard-buttons {
    margin-top: 2rem;
}

/* Separación adicional en móvil */
@media (max-width: 767.98px) {
    .wizard-buttons {
        margin-top: 25px !important;
        padding-top: 15px !important;
    }
    
    /* Ocultar inputs de radio/checkbox en el wizard para móvil */
    .wizard-input {
        display: none !important;
    }
    
    /* Ajustar el primer div del wizard-option en móvil */
    .wizard-option > div:first-child {
        gap: 0 !important;
        justify-content: flex-start !important;
    }
}

.wizard-buttons .btn {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.wizard-buttons .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

.wizard-buttons .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: scale(0.95);
}

.wizard-buttons .btn:disabled:hover {
    transform: scale(0.95);
}

.btn-outline-secondary {
    border-color: #6c757d;
    color: #6c757d;
}

.btn-outline-secondary:hover {
    background: #6c757d;
    border-color: #6c757d;
    color: white;
}

/* Animaciones del wizard */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(50px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes slideOutLeft {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(-50px);
    }
}

.wizard-step-enter {
    animation: slideInRight 0.4s ease-out;
}

.wizard-step-exit {
    animation: slideOutLeft 0.3s ease-in;
}

/* Responsive para wizard */
@media (max-width: 768px) {
    .progress-indicator {
        margin-bottom: 1.5rem;
    }
    
    .progress-indicator .step-circle {
        width: 30px !important;
        height: 30px !important;
        font-size: 12px !important;
    }
    
    .wizard-step {
        padding: 15px !important;
        margin: 10px 0 !important;
    }
    
    .wizard-step h4 {
        font-size: 1.1rem !important;
        margin-bottom: 15px !important;
    }
    
    .options-grid {
        gap: 10px !important;
    }
    
    .wizard-option {
        padding: 15px !important;
        min-height: 60px !important;
    }
    
    /* Botones del wizard fijos en móvil */
    .modal-fullscreen-md-down .wizard-buttons {
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        right: 0 !important;
        background: white !important;
        padding: 20px 15px !important; /* Aumentar padding superior de 15px a 20px */
        border-top: 3px solid #e97c1a !important;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.15) !important;
        z-index: 1020 !important;
        margin: 0 !important;
        margin-top: 20px !important; /* Agregar margen superior */
        border-radius: 0 !important;
        display: flex !important;
        gap: 10px !important;
        justify-content: center !important;
        min-height: 80px !important;
        align-items: center !important;
    }
    
    .modal-fullscreen-md-down .wizard-buttons .btn {
        flex: 1 !important;
        max-width: 150px !important;
        padding: 12px !important;
        font-size: 14px !important;
        font-weight: bold !important;
        border-radius: 25px !important;
        min-height: 45px !important;
    }
    
    /* Espacio inferior en el wizard container */
    .modal-fullscreen-md-down #wizard-container {
        padding-bottom: 120px !important; /* Aumentar de 100px a 120px para más separación */
    }
    
    /* Estilos para wizard steps en móvil */
    .modal-fullscreen-md-down .wizard-step {
        margin-bottom: 20px !important;
        padding: 20px 15px !important;
    }
    
    .modal-fullscreen-md-down .wizard-step h4 {
        font-size: 1.2rem !important;
        text-align: center !important;
        margin-bottom: 20px !important;
        color: #e97c1a !important;
    }
    
    .modal-fullscreen-md-down .wizard-option {
        margin-bottom: 20px !important; /* Aumentar de 15px a 20px */
        padding: 18px !important;
        border: 3px solid #dee2e6 !important;
        border-radius: 15px !important;
        background: #f8f9fa !important;
        min-height: 70px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        cursor: pointer !important;
    }
    
    /* Separación adicional para la última opción */
    .modal-fullscreen-md-down .wizard-option:last-of-type {
        margin-bottom: 30px !important; /* Más separación para la última opción */
    }
    
    .modal-fullscreen-md-down .wizard-option > div:first-child {
        flex: 1 !important;
        text-align: left !important;
        font-size: 16px !important;
        font-weight: 500 !important;
        color: #2c3e50 !important;
        line-height: 1.3 !important;
        margin-right: 10px !important;
    }
    
    .modal-fullscreen-md-down .wizard-option > div:last-child {
        flex-shrink: 0 !important;
        text-align: right !important;
        font-size: 15px !important;
        font-weight: 600 !important;
        color: #e97c1a !important;
    }
    
    /* Ocultar inputs de radio/checkbox en móvil para el wizard */
    .modal-fullscreen-md-down .wizard-option .wizard-input {
        display: none !important; /* Ocultar completamente el círculo/checkbox */
    }
    
    /* Ajustar el contenedor del texto para que ocupe todo el espacio */
    .modal-fullscreen-md-down .wizard-option > div:first-child {
        gap: 0 !important; /* Quitar gap ya que no hay input */
        justify-content: flex-start !important;
    }
    
    .modal-fullscreen-md-down .wizard-option:hover {
        border-color: #e97c1a !important;
        background: rgba(233, 124, 26, 0.1) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(233, 124, 26, 0.2) !important;
    }
    
    .modal-fullscreen-md-down .wizard-option.selected {
        border-color: #e97c1a !important;
        background: rgba(233, 124, 26, 0.15) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 8px 25px rgba(233, 124, 26, 0.3) !important;
    }
}

@media (max-width: 576px) {
    .progress-indicator {
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .progress-indicator > div:not(.step-circle) {
        width: 15px !important;
    }
    
    .wizard-step h4 {
        font-size: 1rem !important;
    }
    
    .wizard-option {
        padding: 12px !important;
        display: flex !important;
        flex-direction: row !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 8px !important;
    }
    
    .wizard-option > div:first-child {
        flex: 1 !important;
        text-align: left !important;
        font-size: 14px !important;
        line-height: 1.3 !important;
        margin-right: 8px !important;
    }
    
    .wizard-option > div:last-child {
        flex-shrink: 0 !important;
        text-align: right !important;
        font-size: 13px !important;
        font-weight: 600 !important;
        color: #e97c1a !important;
    }
    
    /* Ocultar inputs en móviles pequeños también */
    .wizard-option .wizard-input {
        display: none !important; /* Ocultar círculo/checkbox en móviles pequeños */
    }
    
    /* Ajustar contenedor de texto en móviles pequeños */
    .wizard-option > div:first-child {
        gap: 0 !important; /* Sin gap ya que no hay input */
        justify-content: flex-start !important;
    }
    }
}

/* ========== ESTILOS DE CATEGORÍAS ========== */

/* Header del catálogo */
.catalog-header {
    background: linear-gradient(135deg, rgba(233, 124, 26, 0.1) 0%, rgba(233, 124, 26, 0.05) 100%);
    border-radius: 20px;
    padding: 3rem 2rem;
    margin-bottom: 2rem;
}

.decorative-line {
    width: 100px;
    height: 4px;
    background: linear-gradient(90deg, var(--pozoleria-orange), #ffcc33);
    border-radius: 2px;
}

/* Contenedor de categorías */
.categories-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
    padding: 1.5rem;
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    border: 2px solid rgba(233, 124, 26, 0.1);
}

/* Botones de categoría */
.category-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 1.2rem 1.5rem;
    background: #fff;
    border: 2px solid #e9ecef;
    border-radius: 15px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    min-width: 120px;
    text-decoration: none;
    color: #6c757d;
}

.category-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(233, 124, 26, 0.1), transparent);
    transition: left 0.5s;
}

.category-btn:hover::before {
    left: 100%;
}

.category-btn:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(233, 124, 26, 0.2);
    border-color: var(--pozoleria-orange);
    color: var(--pozoleria-orange);
}

.category-btn.active {
    background: linear-gradient(135deg, var(--pozoleria-orange), #ffcc33);
    border-color: var(--pozoleria-orange);
    color: #fff;
    transform: translateY(-3px);
    box-shadow: 0 12px 30px rgba(233, 124, 26, 0.3);
}

.category-btn.active:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(233, 124, 26, 0.4);
}

/* Icono de categoría */
.category-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    transition: all 0.3s ease;
    color: #6c757d;
}

.category-btn:hover .category-icon {
    background: linear-gradient(135deg, rgba(233, 124, 26, 0.1), rgba(233, 124, 26, 0.2));
    color: var(--pozoleria-orange);
    transform: scale(1.1);
}

.category-btn.active .category-icon {
    background: rgba(255,255,255,0.2);
    color: #fff;
    transform: scale(1.1);
}

/* Nombre de categoría */
.category-name {
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
}

/* Contador de productos */
.category-count {
    background: #e9ecef;
    color: #6c757d;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 700;
    transition: all 0.3s ease;
}

.category-btn:hover .category-count {
    background: rgba(233, 124, 26, 0.1);
    color: var(--pozoleria-orange);
}

.category-btn.active .category-count {
    background: rgba(255,255,255,0.2);
    color: #fff;
}

/* Badge de categoría en productos */
.card-img-container {
    position: relative;
    overflow: hidden;
}

.category-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background: linear-gradient(135deg, var(--pozoleria-orange), #ffcc33);
    color: #fff;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    backdrop-filter: blur(10px);
}

/* Animaciones de filtrado */
.producto-item {
    transition: all 0.5s ease;
}

.producto-item.hidden {
    opacity: 0;
    transform: scale(0.8);
    pointer-events: none;
}

.producto-item.showing {
    opacity: 1;
    transform: scale(1);
}

/* Responsive para categorías */
@media (max-width: 768px) {
    .categories-container {
        gap: 0.8rem;
        padding: 1rem;
    }
    
    .category-btn {
        min-width: 100px;
        padding: 1rem 1.2rem;
    }
    
    .category-icon {
        width: 40px;
        height: 40px;
        font-size: 1.2rem;
    }
    
    .category-name {
        font-size: 0.8rem;
    }
    
    .catalog-header {
        padding: 2rem 1rem;
    }
    
    .catalog-header h1 {
        font-size: 2rem;
    }
}

@media (max-width: 576px) {
    .categories-container {
        gap: 0.5rem;
        padding: 0.8rem;
    }
    
    .category-btn {
        min-width: 80px;
        padding: 0.8rem 1rem;
        gap: 0.3rem;
    }
    
    .category-icon {
        width: 35px;
        height: 35px;
        font-size: 1rem;
    }
    
    .category-name {
        font-size: 0.7rem;
    }
    
    .category-count {
        font-size: 0.7rem;
        padding: 0.1rem 0.4rem;
    }
}

/* ===== ESTILOS MODAL MODERNO (Inspirado en La Casa de Toño) ===== */

.modal-content-moderno {
    border-radius: 16px;
    overflow: hidden;
    border: none;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

.imagen-producto-container {
    position: relative;
    height: 100vh;
    min-height: 500px;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-close-moderno {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: rgba(255,255,255,0.9);
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
    transition: all 0.3s ease;
}

.btn-close-moderno:hover {
    background: rgba(255,255,255,1);
    transform: scale(1.1);
}

.imagen-principal {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 40px;
}

.imagen-principal img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
}

.contenido-producto {
    height: 100vh;
    min-height: 500px;
    display: flex;
    flex-direction: column;
    background: white;
}

.opciones-scroll-container-completo {
    flex: 1;
    overflow-y: auto;
    padding: 0 40px;
}

.producto-header-scroll {
    padding: 40px 0 30px 0;
    border-bottom: 1px solid #f0f0f0;
    margin-bottom: 30px;
}

.producto-titulo-scroll {
    font-size: 2rem;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 10px;
    line-height: 1.2;
}

.precio-base-scroll {
    font-size: 1.5rem;
    font-weight: 600;
    color: #27ae60;
}

.producto-descripcion-scroll {
    font-size: 1rem;
    color: #7f8c8d;
    margin-top: 10px;
    line-height: 1.5;
}

.opciones-scroll-container {
    flex: 1;
    overflow-y: auto;
    padding: 0 40px;
}

.opciones-modernas {
    padding-bottom: 30px;
}

.opcion-grupo-moderno {
    margin-bottom: 40px;
}

.opcion-header {
    margin-bottom: 20px;
}

.opcion-titulo-moderno {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

.badge-obligatorio {
    display: inline-block;
    background: #27ae60;
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-opcional {
    display: inline-block;
    background: #95a5a6;
    color: white;
    font-size: 0.75rem;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.opcion-descripcion {
    font-size: 0.9rem;
    color: #7f8c8d;
    margin: 8px 0 0 0;
}

.opciones-container {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.opcion-item-moderno {
    cursor: pointer;
    transition: all 0.2s ease;
}

.opcion-radio-container {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 16px 20px;
    transition: all 0.3s ease;
    background: white;
}

.opcion-item-moderno:hover .opcion-radio-container {
    border-color: #27ae60;
    box-shadow: 0 2px 10px rgba(39,174,96,0.1);
}

.opcion-radio-input:checked + .opcion-radio-label .opcion-radio-container {
    border-color: #27ae60;
    background: rgba(39,174,96,0.05);
    box-shadow: 0 2px 10px rgba(39,174,96,0.15);
}

.opcion-radio-input {
    display: none;
}

.opcion-radio-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    width: 100%;
    margin: 0;
}

.radio-button {
    width: 20px;
    height: 20px;
    border: 2px solid #bdc3c7;
    border-radius: 50%;
    margin-right: 15px;
    position: relative;
    transition: all 0.3s ease;
    flex-shrink: 0;
}

.opcion-radio-input:checked + .opcion-radio-label .radio-button {
    border-color: #27ae60;
}

.opcion-radio-input:checked + .opcion-radio-label .radio-button::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 8px;
    height: 8px;
    background: #27ae60;
    border-radius: 50%;
}

.opcion-content {
    flex: 1;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.opcion-nombre {
    font-size: 1rem;
    font-weight: 500;
    color: #2c3e50;
}

.opcion-precio-moderno {
    font-size: 0.95rem;
    font-weight: 600;
    color: #27ae60;
}

.controles-inferiores {
    padding: 30px 40px 40px 40px;
    border-top: 1px solid #f0f0f0;
    background: #fafbfc;
}

.cantidad-y-precio {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.cantidad-controls-moderno {
    display: flex;
    align-items: center;
    gap: 15px;
}

.btn-cantidad-moderno {
    width: 45px;
    height: 45px;
    border: 2px solid #e9ecef;
    background: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: #7f8c8d;
    transition: all 0.3s ease;
    cursor: pointer;
}

.btn-cantidad-moderno:hover {
    border-color: #27ae60;
    color: #27ae60;
    transform: scale(1.1);
}

.cantidad-display-moderno {
    font-size: 1.25rem;
    font-weight: 600;
    color: #2c3e50;
    min-width: 30px;
    text-align: center;
}

.precio-total-moderno {
    text-align: right;
}

.precio-final {
    font-size: 1.75rem;
    font-weight: 700;
    color: #27ae60;
}

.btn-agregar-moderno {
    width: 100%;
    background: #27ae60;
    color: white;
    border: none;
    border-radius: 12px;
    padding: 16px 24px;
    font-size: 1.1rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-agregar-moderno:hover {
    background: #219a52;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(39,174,96,0.3);
}

.btn-agregar-moderno:active {
    transform: translateY(0);
}

/* Responsive para móviles */
@media (max-width: 991px) {
    .modal-content-moderno {
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
    }
    
    .imagen-producto-container {
        height: 40vh;
        min-height: 250px;
    }
    
    .contenido-producto {
        height: 60vh;
    }
    
    .opciones-scroll-container-completo {
        padding: 0 20px;
    }
    
    .producto-header-scroll {
        padding: 20px 0 15px 0;
        margin-bottom: 20px;
    }
    
    .producto-titulo-scroll {
        font-size: 1.5rem;
    }
    
    .controles-inferiores {
        padding: 20px;
    }
    
    .cantidad-y-precio {
        margin-bottom: 15px;
    }
    
    .precio-final {
        font-size: 1.5rem;
    }
}

.no-image-placeholder {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #95a5a6;
}

.no-image-placeholder p {
    margin: 0;
    font-size: 1rem;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.js"></script>
<script>
    console.log('🚀 INICIANDO SCRIPT PRINCIPAL...');
    console.log('Bootstrap disponible en script principal:', typeof bootstrap !== 'undefined');
    
    // Datos de establecimientos con estado actual
    window.establecimientosData = {
        {% for s in sucursales %}
        {{ s.id }}: {
            nombre: "{{ s.nombre }}",
            direccion: "{{ s.direccion }}",
            telefono: "{{ s.telefono }}",
            activa: {{ s.activa|lower }},
            abierta_ahora: {{ s.abierta_ahora|lower }},
            horarios: [
                {% for horario in s.horarios %}
                "{{ horario }}"{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    };

    // Mantener referencia para compatibilidad con código existente
    window.sucursalesData = window.establecimientosData;

    // Opciones por producto cargadas desde backend
    var opcionesPorProducto = {
        {% for p in productos %}
        {{ p.id }}: {
            imagen: "{{ p.imagen }}",
            nombre: `{{ p.nombre|e }}`,
            precio: {{ p.precio|default(0)|float }},
            opciones: {{ p.opciones|tojson }}
        },
        {% endfor %}
    };
    
    // Debug log para verificar inicialización
    console.log('=== INICIALIZACIÓN COMPLETA ===');
    console.log('Productos cargados:', Object.keys(opcionesPorProducto).length);
    console.log('IDs disponibles:', Object.keys(opcionesPorProducto));
    console.log('opcionesPorProducto:', opcionesPorProducto);
    console.log('Bootstrap disponible:', typeof bootstrap !== 'undefined');
    console.log('=============================');

    // Función completa para abrir el modal (se ejecuta cuando el script principal se carga)
    function abrirModalCompleto(id) {
        console.log('=== ABRIENDO MODAL ===');
        console.log('ID recibido:', id);
        console.log('Bootstrap disponible:', typeof bootstrap !== 'undefined');
        console.log('Elemento modal existe:', document.getElementById('modalProducto') !== null);
        
        // Verificar que tenemos una sucursal seleccionada
        var sucursalActual = localStorage.getItem('sucursal_id');
        console.log('Sucursal actual:', sucursalActual);
        if (!sucursalActual) {
            console.warn('⚠️ No hay sucursal seleccionada');
            alert('Por favor selecciona una sucursal primero');
            return;
        }
        
        // Buscar el producto
        console.log('opcionesPorProducto disponible:', typeof opcionesPorProducto !== 'undefined');
        console.log('Productos cargados:', Object.keys(opcionesPorProducto || {}));
        var producto = opcionesPorProducto[id];
        if (!producto) {
            console.error('❌ Producto no encontrado para ID:', id);
            console.log('IDs disponibles:', Object.keys(opcionesPorProducto || {}));
            return;
        }
        
        console.log('✅ Producto encontrado:', producto);
        
        // Llenar información básica del modal
        document.getElementById('modal-nombre').textContent = producto.nombre;
        document.getElementById('modal-precio').textContent = '$' + parseFloat(producto.precio).toFixed(2);
        document.getElementById('producto_id').value = id;
        document.getElementById('cantidad').value = 1;
        document.getElementById('sucursal_id').value = sucursalActual;
        
        // Configurar imagen
        var modalImgContainer = document.getElementById('modal-img-container');
        if (modalImgContainer) {
            if (producto.imagen) {
                modalImgContainer.innerHTML = '<img src="' + producto.imagen + '" class="img-fluid">';
            } else {
                modalImgContainer.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted"><i class="fas fa-image fa-3x opacity-50"></i></div>';
            }
        }
        
        // Limpiar opciones anteriores
        var modalOpciones = document.getElementById('modal-opciones');
        if (modalOpciones) {
            modalOpciones.innerHTML = '';
            
            // Si el producto tiene opciones, generarlas
            if (producto.opciones && producto.opciones.length > 0) {
                var opcionesHtml = '';
                
                producto.opciones.forEach(function(opcion, index) {
                    opcionesHtml += '<div class="opcion-grupo mb-4">';
                    opcionesHtml += '<h6 class="opcion-titulo">' + opcion.titulo;
                    if (opcion.obligatorio) {
                        opcionesHtml += ' <span class="badge opcion-obligatorio">Obligatorio</span>';
                    } else {
                        opcionesHtml += ' <span class="badge opcion-opcional">Opcional</span>';
                    }
                    opcionesHtml += '</h6>';
                    
                    if (opcion.opciones && opcion.opciones.length > 0) {
                        opcion.opciones.forEach(function(valor, valorIndex) {
                            var inputType = opcion.multiple ? 'checkbox' : 'radio';
                            var inputName = 'opcion_' + index;
                            var inputId = inputName + '_' + valorIndex;
                            
                            opcionesHtml += '<div class="opcion-item form-check mb-2">';
                            opcionesHtml += '<input class="form-check-input" type="' + inputType + '" name="' + inputName + '" id="' + inputId + '" value="' + valor.id + '" data-precio="' + (valor.precio || 0) + '">';
                            opcionesHtml += '<label class="form-check-label" for="' + inputId + '">';
                            opcionesHtml += '<div class="opcion-texto">' + valor.nombre + '</div>';
                            if (valor.precio && parseFloat(valor.precio) > 0) {
                                opcionesHtml += '<div class="opcion-precio">+$' + parseFloat(valor.precio).toFixed(2) + '</div>';
                            }
                            opcionesHtml += '</label>';
                            opcionesHtml += '</div>';
                        });
                    }
                    
                    opcionesHtml += '</div>';
                });
                
                modalOpciones.innerHTML = opcionesHtml;
            } else {
                modalOpciones.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-check-circle fa-3x"></i><h5 class="mt-3">Producto listo</h5><p>Este producto no requiere personalización adicional.</p></div>';
            }
        }
        
        // Mostrar el modal
        console.log('Intentando abrir modal...');
        try {
            var modal = new bootstrap.Modal(document.getElementById('modalProducto'));
            modal.show();
            console.log('✅ Modal abierto exitosamente');
        } catch (error) {
            console.error('❌ Error al abrir modal:', error);
        }
    }

    // Reemplazar la función simplificada con la versión completa
    window.abrirModalCompleto = abrirModalCompleto;
    window.abrirModal = abrirModalCompleto;
    console.log('✅ abrirModal reemplazada con versión completa');
    console.log('✅ abrirModalCompleto asignada a window');

    function mostrarModal(id) {
        var producto = opcionesPorProducto[id];
        if (!producto) {
            console.log('ERROR: Producto no encontrado para ID:', id);
            return;
        }
        
        console.log('DEBUG: Producto encontrado:', producto);
        console.log('DEBUG: Opciones del producto:', producto.opciones);
        
        document.getElementById('modal-nombre').textContent = producto.nombre;
        document.getElementById('producto_id').value = id;
        document.getElementById('modal-img-container').innerHTML = producto.imagen ? '<img src="' + producto.imagen + '" class="img-fluid rounded" style="max-height:300px;">' : '';
        
        var opcionesHtml = '';
        
        // DETECTAR SI ES MÓVIL
        var esMobil = window.innerWidth <= 768;
        console.log('Detectado dispositivo - Es móvil:', esMobil, 'Ancho:', window.innerWidth);
        
        if (!producto.opciones || producto.opciones.length === 0) {
            opcionesHtml = '<div class="text-center text-muted"><i class="fas fa-info-circle me-2"></i>Este producto no tiene opciones adicionales.</div>';
        } else {
            console.log('Iniciando sistema de preguntas paso a paso para', producto.opciones.length, 'grupos');
            
            // SISTEMA DE PREGUNTAS PASO A PASO
            opcionesHtml = '<div id="wizard-container" style="min-height: 300px;">';
            
            // Indicador de progreso
            opcionesHtml += '<div class="progress-indicator mb-4" style="display: flex; justify-content: center; align-items: center; gap: 10px;">';
            for (var i = 0; i < producto.opciones.length; i++) {
                var estiloCirculo = esMobil ? 
                    'width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 2px solid #dee2e6; background: #f8f9fa; color: #6c757d;' :
                    'width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid #dee2e6; background: #f8f9fa; color: #6c757d;';
                
                opcionesHtml += '<div class="step-circle" id="step-' + i + '" style="' + estiloCirculo + '">' + (i + 1) + '</div>';
                if (i < producto.opciones.length - 1) {
                    opcionesHtml += '<div style="width: 30px; height: 2px; background: #dee2e6; border-radius: 1px;"></div>';
                }
            }
            opcionesHtml += '</div>';
            
            // Contenedor de preguntas
            opcionesHtml += '<div id="question-container" style="text-align: center; margin-bottom: 30px;">';
            
            // Generar todas las preguntas (ocultas inicialmente)
            producto.opciones.forEach(function(op, index) {
                var estilosGrupo = esMobil ? 
                    'background: white !important; border: 3px solid #e97c1a !important; margin: 20px 0 !important; padding: 25px !important; border-radius: 15px !important; display: none; position: relative !important; z-index: 999 !important; min-height: 100px !important; text-align: center;' :
                    'background: white; border: 2px solid #e9ecef; margin: 20px 0; padding: 25px; border-radius: 12px; display: none; text-align: center; position: relative;';
                
                opcionesHtml += '<div class="wizard-step" id="wizard-step-' + index + '" data-step="' + index + '" data-obligatorio="' + op.obligatorio + '" style="' + estilosGrupo + '">';
                
                // Título de la pregunta
                var estilosTitulo = esMobil ?
                    'font-weight: 700 !important; color: #495057 !important; margin-bottom: 20px !important; font-size: 1.3rem !important; text-align: center !important;' :
                    'font-weight: 700; color: #495057; margin-bottom: 20px; font-size: 1.2rem; text-align: center;';
                
                opcionesHtml += '<h4 style="' + estilosTitulo + '">';
                opcionesHtml += '<i class="fas fa-question-circle me-2" style="color: #e97c1a;"></i>';
                opcionesHtml += op.titulo;
                opcionesHtml += '</h4>';
                
                // Badge obligatorio/opcional
                if (op.obligatorio) {
                    opcionesHtml += '<div class="mb-3"><span class="badge bg-success" style="font-size: 0.9rem; padding: 8px 16px;">Obligatorio</span></div>'; /* Cambiar bg-danger a bg-success */
                } else {
                    opcionesHtml += '<div class="mb-3"><span class="badge bg-secondary" style="font-size: 0.9rem; padding: 8px 16px;">Opcional</span></div>'; /* Cambiar bg-success a bg-secondary */
                }
                
                // Subtítulo con instrucciones
                var textoInstrucciones = '';
                if (op.tipo === 'radio') {
                    textoInstrucciones = op.obligatorio ? 'Selecciona una opción' : 'Selecciona una opción (opcional)';
                } else if (op.tipo === 'checkbox') {
                    textoInstrucciones = op.obligatorio ? 'Selecciona al menos una opción' : 'Selecciona al menos una opción (opcional)';
                }
                
                var estilosSubtitulo = esMobil ?
                    'color: #6c757d !important; font-size: 1rem !important; margin-bottom: 20px !important; text-align: center !important; font-style: italic !important;' :
                    'color: #6c757d; font-size: 0.95rem; margin-bottom: 20px; text-align: center; font-style: italic;';
                
                opcionesHtml += '<div style="' + estilosSubtitulo + '">' + textoInstrucciones + '</div>';
                
                // Opciones de respuesta
                if (op.opciones && op.opciones.length > 0) {
                    opcionesHtml += '<div class="options-grid" style="display: grid; gap: 15px; max-width: 500px; margin: 0 auto 30px;">';
                    
                    op.opciones.forEach(function(opt, idx) {
                        var inputType = op.tipo;
                        var inputName = (op.nombre || 'opcion_' + index) + (inputType == "checkbox" ? "[]" : "");
                        var inputId = (op.nombre || 'opcion_' + index) + "_" + idx;
                        
                        var estilosOpcion = esMobil ?
                            'background: #f8f9fa !important; border: 3px solid #dee2e6 !important; padding: 20px !important; border-radius: 15px !important; cursor: pointer !important; transition: all 0.3s ease !important; position: relative !important; z-index: 998 !important; min-height: 70px !important; display: flex !important; align-items: center !important; justify-content: space-between !important;' :
                            'background: #f8f9fa; border: 2px solid #dee2e6; padding: 18px; border-radius: 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: space-between;';
                        
                        opcionesHtml += '<div class="wizard-option" style="' + estilosOpcion + '" onclick="seleccionarOpcionWizard(\'' + inputId + '\', ' + index + ')">';
                        opcionesHtml += '<div style="display: flex; align-items: center; gap: ' + (esMobil ? '0px' : '15px') + ';">';
                        
                        // Solo mostrar el input en escritorio, ocultarlo en móvil
                        if (!esMobil) {
                            opcionesHtml += '<input class="form-check-input wizard-input" type="' + inputType + '" name="' + inputName + '" id="' + inputId + '" value="' + opt.texto + '" data-precio="' + (opt.precio || 0) + '" style="width: 24px; height: 24px; margin: 0;">';
                        } else {
                            opcionesHtml += '<input class="form-check-input wizard-input" type="' + inputType + '" name="' + inputName + '" id="' + inputId + '" value="' + opt.texto + '" data-precio="' + (opt.precio || 0) + '" style="display: none;">';
                        }
                        
                        opcionesHtml += '<label for="' + inputId + '" style="font-weight: 600; cursor: pointer; margin: 0; font-size: ' + (esMobil ? '1.1rem' : '1rem') + ';">' + opt.texto + '</label>';
                        opcionesHtml += '</div>';
                        if (opt.precio && opt.precio > 0) {
                            opcionesHtml += '<div style="color: #e97c1a; font-weight: bold; font-size: ' + (esMobil ? '1.1rem' : '1rem') + ';">';
                            opcionesHtml += '+$' + parseFloat(opt.precio).toFixed(2);
                            opcionesHtml += '</div>';
                        }
                        opcionesHtml += '</div>';
                    });
                    
                    opcionesHtml += '</div>';
                }
                
                // Botones de navegación
                opcionesHtml += '<div class="wizard-buttons" style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">';
                
                // Botón omitir (solo para opcionales)
                if (!op.obligatorio) {
                    var estiloOmitir = esMobil ?
                        'padding: 12px 24px !important; font-size: 1rem !important; border-radius: 25px !important; font-weight: 600 !important; min-width: 120px !important;' :
                        'padding: 10px 20px; font-size: 0.9rem; border-radius: 20px; font-weight: 600; min-width: 100px;';
                    
                    opcionesHtml += '<button type="button" class="btn btn-outline-secondary" onclick="omitirPregunta(' + index + ')" style="' + estiloOmitir + '">';
                    opcionesHtml += '<i class="fas fa-forward me-2"></i>Omitir';
                    opcionesHtml += '</button>';
                }
                
                // Botón continuar
                var estiloContinuar = esMobil ?
                    'padding: 12px 24px !important; font-size: 1rem !important; border-radius: 25px !important; font-weight: 600 !important; min-width: 120px !important; background: linear-gradient(135deg, #e97c1a, #ffcc33) !important; border: none !important; color: white !important;' :
                    'padding: 10px 20px; font-size: 0.9rem; border-radius: 20px; font-weight: 600; min-width: 100px; background: linear-gradient(135deg, #e97c1a, #ffcc33); border: none; color: white;';
                
                opcionesHtml += '<button type="button" class="btn btn-primary wizard-continue" id="continue-' + index + '" onclick="siguientePregunta(' + index + ')" disabled style="' + estiloContinuar + '">';
                if (index === producto.opciones.length - 1) {
                    opcionesHtml += '<i class="fas fa-check me-2"></i>Finalizar';
                } else {
                    opcionesHtml += '<i class="fas fa-arrow-right me-2"></i>Continuar';
                }
                opcionesHtml += '</button>';
                
                opcionesHtml += '</div>';
                opcionesHtml += '</div>';
            });
            
            opcionesHtml += '</div>';
            opcionesHtml += '</div>';
            
            console.log('Sistema de wizard generado correctamente para', esMobil ? 'móvil' : 'desktop');
        }
        
        console.log('HTML final generado. Longitud:', opcionesHtml.length);
        
        // INSERTAR HTML
        var modalOpciones = document.getElementById('modal-opciones');
        if (modalOpciones) {
            console.log('Insertando HTML en modal-opciones');
            modalOpciones.innerHTML = opcionesHtml;
            console.log('Contenido insertado. Elemento tiene', modalOpciones.children.length, 'hijos');
            
            // FORZAR VISIBILIDAD
            modalOpciones.style.display = 'block';
            modalOpciones.style.visibility = 'visible';
            modalOpciones.style.opacity = '1';
            
            // ESTILOS ESPECÍFICOS PARA MÓVIL
            if (esMobil) {
                console.log('Aplicando estilos especiales para móvil');
                modalOpciones.style.background = '#ffffff';
                modalOpciones.style.padding = '10px';
                modalOpciones.style.minHeight = '300px';
                modalOpciones.style.maxHeight = 'none';
                modalOpciones.style.overflow = 'visible';
                modalOpciones.style.position = 'relative';
                modalOpciones.style.zIndex = '1000';
                modalOpciones.style.width = '100%';
                
                // FORZAR CONTENEDOR PADRE TAMBIÉN
                var modalBody = modalOpciones.closest('.modal-body');
                if (modalBody) {
                    modalBody.style.overflow = 'visible';
                    modalBody.style.maxHeight = 'none';
                }
                
                var colLg7 = modalOpciones.closest('.col-lg-7');
                if (colLg7) {
                    colLg7.style.overflow = 'visible';
                    colLg7.style.maxHeight = 'none';
                }
            }
            
            // Verificar que se insertó correctamente
            setTimeout(function() {
                var grupos = modalOpciones.querySelectorAll('.opcion-grupo');
                var wizardSteps = modalOpciones.querySelectorAll('.wizard-step');
                console.log('Grupos de opciones encontrados después de insertar:', grupos.length);
                console.log('Pasos de wizard encontrados:', wizardSteps.length);
                
                if (esMobil) {
                    console.log('Aplicando estilos finales a grupos móviles');
                    grupos.forEach(function(grupo, i) {
                        grupo.style.display = 'block';
                        grupo.style.visibility = 'visible';
                        grupo.style.opacity = '1';
                        grupo.style.position = 'relative';
                        grupo.style.zIndex = '999';
                        grupo.style.background = 'white';
                        grupo.style.border = '3px solid #e97c1a';
                        grupo.style.margin = '20px 5px';
                        grupo.style.padding = '20px';
                        grupo.style.borderRadius = '15px';
                        grupo.style.minHeight = '100px';
                        
                        console.log('Grupo', i, 'configurado para móvil');
                    });
                } else {
                    grupos.forEach(function(grupo, i) {
                        grupo.style.display = 'block';
                        grupo.style.visibility = 'visible';
                        grupo.style.opacity = '1';
                    });
                }
                
                // Inicializar wizard si hay pasos
                if (wizardSteps.length > 0) {
                    inicializarWizard();
                }
            }, 100);
        } else {
            console.error('ERROR: No se encontró el elemento modal-opciones');
        }
        
        // VERIFICAR SI LAS OPCIONES TIENEN DATOS
        if (producto.opciones && producto.opciones.length > 0) {
            console.log('Producto tiene', producto.opciones.length, 'grupos de opciones');
            producto.opciones.forEach(function(op, index) {
                console.log('Grupo', index, ':', op.titulo, 'con', (op.opciones ? op.opciones.length : 0), 'opciones');
            });
        } else {
            console.log('ERROR: Producto sin opciones o opciones vacías');
        }
        
        // Mostrar el modal
        var modal = new bootstrap.Modal(document.getElementById('modalProducto'));
        modal.show();
        
        // Forzar actualización de precio
        actualizarTotalModal();
        
        // Agregar event listeners para actualizar el total
        setTimeout(function() {
            // Verificar si hay wizard
            var wizardContainer = document.getElementById('wizard-container');
            var selectorInputs = wizardContainer ? '.wizard-input' : '.opcion-input';
            
            var inputs = document.querySelectorAll(selectorInputs);
            console.log('Configurando event listeners para', inputs.length, 'inputs en', esMobil ? 'móvil' : 'desktop', 'modo:', wizardContainer ? 'wizard' : 'tradicional');
            
            inputs.forEach(function(input, index) {
                console.log('Configurando input', index, ':', input.id, 'tipo:', input.type);
                
                input.addEventListener('change', function() {
                    console.log('Input cambiado:', input.value, 'checked:', input.checked, 'en', esMobil ? 'móvil' : 'desktop');
                    
                    if (!wizardContainer) {
                        // Modo tradicional
                        var parentItem = input.closest('.opcion-item');
                        if (parentItem) {
                            if (input.checked) {
                                parentItem.classList.add('selected');
                                parentItem.style.borderColor = '#e97c1a';
                                parentItem.style.backgroundColor = 'rgba(233, 124, 26, 0.1)';
                                if (esMobil) {
                                    parentItem.style.border = '3px solid #e97c1a';
                                    parentItem.style.background = 'rgba(233, 124, 26, 0.2)';
                                }
                            } else {
                                parentItem.classList.remove('selected');
                                parentItem.style.borderColor = '#dee2e6';
                                parentItem.style.backgroundColor = '#f8f9fa';
                                if (esMobil) {
                                    parentItem.style.border = '2px solid #dee2e6';
                                    parentItem.style.background = '#f8f9fa';
                                }
                            }
                            
                            // Si es radio, deseleccionar otros
                            if (input.type === 'radio') {
                                var otherRadios = document.querySelectorAll('input[name="' + input.name + '"]');
                                otherRadios.forEach(function(radio) {
                                    if (radio !== input) {
                                        var otherItem = radio.closest('.opcion-item');
                                        if (otherItem) {
                                            otherItem.classList.remove('selected');
                                            otherItem.style.borderColor = '#dee2e6';
                                            otherItem.style.backgroundColor = '#f8f9fa';
                                            if (esMobil) {
                                                otherItem.style.border = '2px solid #dee2e6';
                                                otherItem.style.background = '#f8f9fa';
                                            }
                                        }
                                    }
                                });
                            }
                        }
                        
                        // Limpiar errores
                        var opcionGrupo = input.closest('.opcion-grupo');
                        if (opcionGrupo) {
                            opcionGrupo.classList.remove('error');
                        }
                    } else {
                        // Modo wizard - verificar selecciones para habilitar botón continuar
                        var step = input.closest('.wizard-step');
                        if (step) {
                            var stepIndex = parseInt(step.getAttribute('data-step'));
                            verificarSeleccionesWizard(stepIndex);
                        }
                    }
                    
                    actualizarTotalModal();
                });
            });
            
            var cantidadInput = document.getElementById('input-cantidad');
            if (cantidadInput) {
                cantidadInput.addEventListener('input', function() {
                    actualizarTotalModal();
                });
            }
            
            // Inicializar el total
            actualizarTotalModal();
        }, 300);
    }

    function toggleOpcion(element, inputId) {
        var input = document.getElementById(inputId);
        if (!input) return;
        
        // Si es radio button, deseleccionar otros del mismo grupo
        if (input.type === 'radio') {
            var otherRadios = document.querySelectorAll('input[name="' + input.name + '"]');
            otherRadios.forEach(function(radio) {
                radio.checked = false;
                var parentItem = radio.closest('.opcion-item');
                if (parentItem) {
                    parentItem.classList.remove('selected');
                }
            });
            input.checked = true;
            element.classList.add('selected');
        } else if (input.type === 'checkbox') {
            // Para checkboxes, toggle el estado
            input.checked = !input.checked;
            if (input.checked) {
                element.classList.add('selected');
            } else {
                element.classList.remove('selected');
            }
        }
        
        // Limpiar errores de validación
        var opcionGrupo = element.closest('.opcion-grupo');
        if (opcionGrupo) {
            opcionGrupo.classList.remove('error');
        }
        
        // Actualizar total
        actualizarTotalModal();
    }

    // ========== FUNCIONES DEL WIZARD PASO A PASO ==========
    
    var wizardCurrentStep = 0;
    var wizardTotalSteps = 0;
    
    function inicializarWizard() {
        console.log('Inicializando wizard paso a paso');
        var steps = document.querySelectorAll('.wizard-step');
        wizardTotalSteps = steps.length;
        wizardCurrentStep = 0;
        
        if (wizardTotalSteps > 0) {
            console.log('Wizard iniciado con', wizardTotalSteps, 'pasos');
            mostrarPasoWizard(0);
        }
    }
    
    function mostrarPasoWizard(stepIndex) {
        console.log('Mostrando paso', stepIndex + 1, 'de', wizardTotalSteps);
        const esMobil = window.innerWidth <= 768;
        
        // Vibración táctil en móvil al cambiar de paso
        if (esMobil && navigator.vibrate) {
            navigator.vibrate(30);
        }
        
        // Ocultar todos los pasos
        var steps = document.querySelectorAll('.wizard-step');
        steps.forEach(function(step) {
            step.style.display = 'none';
        });
        
        // Mostrar el paso actual
        var currentStep = document.getElementById('wizard-step-' + stepIndex);
        if (currentStep) {
            currentStep.style.display = 'block';
            
            // En móvil, ajustar posición de los botones
            if (esMobil) {
                var wizardButtons = currentStep.querySelector('.wizard-buttons');
                if (wizardButtons) {
                    // Los botones ya están fijos con CSS, solo asegurar visibilidad
                    wizardButtons.style.position = 'fixed';
                    wizardButtons.style.bottom = '0';
                    wizardButtons.style.left = '0';
                    wizardButtons.style.right = '0';
                    wizardButtons.style.zIndex = '1020';
                }
            }
            
            // Animar entrada
            setTimeout(function() {
                currentStep.style.transform = 'translateY(0)';
                currentStep.style.opacity = '1';
            }, 50);
        }
        
        // Actualizar indicador de progreso
        actualizarProgreso(stepIndex);
        
        wizardCurrentStep = stepIndex;
    }
    
    function actualizarProgreso(stepIndex) {
        var circles = document.querySelectorAll('.step-circle');
        circles.forEach(function(circle, index) {
            if (index < stepIndex) {
                // Pasos completados
                circle.style.background = '#28a745';
                circle.style.borderColor = '#28a745';
                circle.style.color = 'white';
                circle.innerHTML = '<i class="fas fa-check" style="font-size: 12px;"></i>';
            } else if (index === stepIndex) {
                // Paso actual
                circle.style.background = '#e97c1a';
                circle.style.borderColor = '#e97c1a';
                circle.style.color = 'white';
                circle.innerHTML = index + 1;
            } else {
                // Pasos pendientes
                circle.style.background = '#f8f9fa';
                circle.style.borderColor = '#dee2e6';
                circle.style.color = '#6c757d';
                circle.innerHTML = index + 1;
            }
        });
    }
    
    function seleccionarOpcionWizard(inputId, stepIndex) {
        console.log('Seleccionando opción:', inputId, 'en paso:', stepIndex);
        
        var input = document.getElementById(inputId);
        if (!input) return;
        
        var step = document.getElementById('wizard-step-' + stepIndex);
        var esObligatorio = step.getAttribute('data-obligatorio') === 'true';
        const esMobil = window.innerWidth <= 768;
        
        // Manejar selección según tipo de input
        if (input.type === 'radio') {
            // Deseleccionar otros radios del mismo grupo
            var otherRadios = document.querySelectorAll('input[name="' + input.name + '"]');
            otherRadios.forEach(function(radio) {
                radio.checked = false;
                var parentOption = radio.closest('.wizard-option');
                if (parentOption) {
                    parentOption.classList.remove('selected');
                    parentOption.style.borderColor = '#dee2e6';
                    parentOption.style.background = '#f8f9fa';
                    if (esMobil) {
                        parentOption.style.transform = 'translateY(0)';
                        parentOption.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                    }
                }
            });
            
            // Seleccionar el actual
            input.checked = true;
            var parentOption = input.closest('.wizard-option');
            if (parentOption) {
                parentOption.classList.add('selected');
                parentOption.style.borderColor = '#e97c1a';
                parentOption.style.background = 'rgba(233, 124, 26, 0.15)';
                if (esMobil) {
                    parentOption.style.transform = 'translateY(-2px)';
                    parentOption.style.boxShadow = '0 8px 25px rgba(233, 124, 26, 0.3)';
                    
                    // Vibración táctil en móvil (si está disponible)
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                    
                    // Efecto de ondas
                    var ripple = document.createElement('div');
                    ripple.style.position = 'absolute';
                    ripple.style.borderRadius = '50%';
                    ripple.style.background = 'rgba(233, 124, 26, 0.4)';
                    ripple.style.transform = 'scale(0)';
                    ripple.style.animation = 'ripple 0.6s linear';
                    ripple.style.left = '50%';
                    ripple.style.top = '50%';
                    ripple.style.width = '40px';
                    ripple.style.height = '40px';
                    ripple.style.marginLeft = '-20px';
                    ripple.style.marginTop = '-20px';
                    ripple.style.pointerEvents = 'none';
                    ripple.style.zIndex = '1';
                    
                    parentOption.style.position = 'relative';
                    parentOption.appendChild(ripple);
                    
                    setTimeout(function() {
                        parentOption.removeChild(ripple);
                    }, 600);
                }
            }
            
            // Habilitar botón continuar
            habilitarContinuar(stepIndex);
            
        } else if (input.type === 'checkbox') {
            // Toggle checkbox
            input.checked = !input.checked;
            var parentOption = input.closest('.wizard-option');
            if (parentOption) {
                if (input.checked) {
                    parentOption.classList.add('selected');
                    parentOption.style.borderColor = '#e97c1a';
                    parentOption.style.background = 'rgba(233, 124, 26, 0.15)';
                    if (esMobil) {
                        parentOption.style.transform = 'translateY(-2px)';
                        parentOption.style.boxShadow = '0 8px 25px rgba(233, 124, 26, 0.3)';
                        
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                    }
                } else {
                    parentOption.classList.remove('selected');
                    parentOption.style.borderColor = '#dee2e6';
                    parentOption.style.background = '#f8f9fa';
                    if (esMobil) {
                        parentOption.style.transform = 'translateY(0)';
                        parentOption.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                    }
                }
            }
            
            // Verificar si hay alguna selección para habilitar continuar
            verificarSeleccionesWizard(stepIndex);
        }
        
        // Actualizar total
        actualizarTotalModal();
    }
    
    function verificarSeleccionesWizard(stepIndex) {
        var step = document.getElementById('wizard-step-' + stepIndex);
        var inputs = step.querySelectorAll('.wizard-input');
        var haySeleccion = Array.from(inputs).some(function(input) {
            return input.checked;
        });
        
        var esObligatorio = step.getAttribute('data-obligatorio') === 'true';
        
        if (haySeleccion || !esObligatorio) {
            habilitarContinuar(stepIndex);
        } else {
            deshabilitarContinuar(stepIndex);
        }
    }
    
    function habilitarContinuar(stepIndex) {
        var continueBtn = document.getElementById('continue-' + stepIndex);
        if (continueBtn) {
            continueBtn.disabled = false;
            continueBtn.style.opacity = '1';
            continueBtn.style.transform = 'scale(1)';
        }
    }
    
    function deshabilitarContinuar(stepIndex) {
        var continueBtn = document.getElementById('continue-' + stepIndex);
        if (continueBtn) {
            continueBtn.disabled = true;
            continueBtn.style.opacity = '0.6';
            continueBtn.style.transform = 'scale(0.95)';
        }
    }
    
    function siguientePregunta(stepIndex) {
        console.log('Avanzando desde paso', stepIndex);
        
        // Marcar paso como completado
        actualizarProgreso(stepIndex + 1);
        
        if (stepIndex + 1 < wizardTotalSteps) {
            // Ir al siguiente paso
            setTimeout(function() {
                mostrarPasoWizard(stepIndex + 1);
            }, 300);
        } else {
            // Último paso - finalizar wizard
            finalizarWizard();
        }
    }
    
    function omitirPregunta(stepIndex) {
        console.log('Omitiendo paso', stepIndex);
        
        // Limpiar selecciones del paso actual
        var step = document.getElementById('wizard-step-' + stepIndex);
        var inputs = step.querySelectorAll('.wizard-input');
        inputs.forEach(function(input) {
            input.checked = false;
        });
        
        // Actualizar total
        actualizarTotalModal();
        
        // Avanzar al siguiente paso
        siguientePregunta(stepIndex);
    }
    
    function finalizarWizard() {
        console.log('Finalizando wizard');
        
        // Ocultar wizard
        var wizardContainer = document.getElementById('wizard-container');
        if (wizardContainer) {
            wizardContainer.style.transition = 'all 0.5s ease';
            wizardContainer.style.transform = 'translateY(-20px)';
            wizardContainer.style.opacity = '0';
            
            setTimeout(function() {
                wizardContainer.innerHTML = '<div class="text-center text-success"><i class="fas fa-check-circle me-2" style="font-size: 2rem; color: #28a745;"></i><h4 style="color: #28a745; margin-top: 15px;">¡Configuración Completada!</h4><p class="text-muted">Tu producto ha sido personalizado correctamente.</p></div>';
                wizardContainer.style.transform = 'translateY(0)';
                wizardContainer.style.opacity = '1';
            }, 500);
        }
        
        // Mostrar resumen de selecciones (opcional)
        mostrarResumenSelecciones();
    }
    
    function mostrarResumenSelecciones() {
        var productoId = document.getElementById('modal-producto-id').value;
        var producto = opcionesPorProducto[productoId];
        
        console.log('Resumen de selecciones para producto:', producto.nombre);
        
        var selecciones = [];
        var inputs = document.querySelectorAll('.wizard-input:checked');
        inputs.forEach(function(input) {
            var precio = parseFloat(input.getAttribute('data-precio')) || 0;
            selecciones.push({
                texto: input.value,
                precio: precio
            });
        });
        
        console.log('Opciones seleccionadas:', selecciones);
    }

    function validarOpcionesObligatorias() {
        const esMobil = window.innerWidth <= 768;
        console.log('Validando opciones obligatorias en modo:', esMobil ? 'móvil' : 'desktop');
        
        var valido = true;
        var errores = [];
        
        // Verificar si estamos en modo wizard MÓVIL (nuevo sistema)
        var wizardStepsMovil = document.querySelectorAll('#productModal .wizard-step');
        var wizardStepsAntiguo = document.querySelectorAll('#wizard-container .wizard-step');
        var wizardStepsModalOpciones = document.querySelectorAll('#modal-opciones .wizard-step');
        
        console.log('Pasos wizard móvil (productModal):', wizardStepsMovil.length);
        console.log('Pasos wizard antiguo (wizard-container):', wizardStepsAntiguo.length);
        console.log('Pasos wizard en modal-opciones:', wizardStepsModalOpciones.length);
        
        if (wizardStepsMovil.length > 0) {
            console.log('=== USANDO VALIDACIÓN MÓVIL NUEVA ===');
            console.log('Validando en modo wizard móvil - encontrados', wizardStepsMovil.length, 'pasos');
            
            // En modo wizard móvil, verificar cada paso obligatorio
            wizardStepsMovil.forEach(function(step, stepIndex) {
                const esObligatorio = step.getAttribute('data-obligatorio') === 'true';
                console.log(`Validando paso ${stepIndex}, obligatorio:`, esObligatorio);
                
                if (esObligatorio) {
                    const inputs = step.querySelectorAll('.wizard-input');
                    const tieneSeleccion = Array.from(inputs).some(input => input.checked);
                    
                    console.log(`Paso ${stepIndex} - Inputs encontrados:`, inputs.length, 'Con selección:', tieneSeleccion);
                    
                    if (!tieneSeleccion) {
                        valido = false;
                        const titulo = step.querySelector('h3, h4'); // Buscar h3 o h4
                        const nombrePaso = titulo ? titulo.textContent.replace('🍲', '').replace('?', '').trim() : `Paso ${stepIndex + 1}`;
                        errores.push(nombrePaso);
                        console.log('❌ Paso obligatorio sin selección:', nombrePaso);
                    } else {
                        console.log('✅ Paso obligatorio con selección válida');
                    }
                }
            });
            
        } else if (wizardStepsModalOpciones.length > 0) {
            console.log('=== USANDO VALIDACIÓN MODAL-OPCIONES ===');
            console.log('Validando en modo wizard modal-opciones - encontrados', wizardStepsModalOpciones.length, 'pasos');
            
            // En modo wizard en modal-opciones, verificar cada paso obligatorio
            wizardStepsModalOpciones.forEach(function(step, stepIndex) {
                const esObligatorio = step.getAttribute('data-obligatorio') === 'true';
                console.log(`Validando paso ${stepIndex}, obligatorio:`, esObligatorio);
                
                if (esObligatorio) {
                    const inputs = step.querySelectorAll('.wizard-input');
                    const tieneSeleccion = Array.from(inputs).some(input => input.checked);
                    
                    console.log(`Paso ${stepIndex} - Inputs encontrados:`, inputs.length, 'Con selección:', tieneSeleccion);
                    
                    if (!tieneSeleccion) {
                        valido = false;
                        const titulo = step.querySelector('h3, h4'); // Buscar h3 o h4
                        const nombrePaso = titulo ? titulo.textContent.replace('🍲', '').replace('?', '').trim() : `Paso ${stepIndex + 1}`;
                        errores.push(nombrePaso);
                        console.log('❌ Paso obligatorio sin selección:', nombrePaso);
                    } else {
                        console.log('✅ Paso obligatorio con selección válida');
                    }
                }
            });
            
        } else if (wizardStepsAntiguo.length > 0) {
            console.log('=== USANDO VALIDACIÓN ANTIGUA ===');
            console.log('Validando en modo wizard antiguo - encontrados', wizardStepsAntiguo.length, 'pasos');
            
            // En modo wizard antiguo, verificar cada paso obligatorio
            wizardStepsAntiguo.forEach(function(step, stepIndex) {
                const esObligatorio = step.getAttribute('data-obligatorio') === 'true';
                console.log(`Validando paso ${stepIndex}, obligatorio:`, esObligatorio);
                
                if (esObligatorio) {
                    const inputs = step.querySelectorAll('.wizard-input');
                    const tieneSeleccion = Array.from(inputs).some(input => input.checked);
                    
                    console.log(`Paso ${stepIndex} - Inputs encontrados:`, inputs.length, 'Con selección:', tieneSeleccion);
                    
                    if (!tieneSeleccion) {
                        valido = false;
                        const titulo = step.querySelector('h3, h4'); // Buscar h3 o h4
                        const nombrePaso = titulo ? titulo.textContent.replace('🍲', '').replace('?', '').trim() : `Paso ${stepIndex + 1}`;
                        errores.push(nombrePaso);
                        console.log('❌ Paso obligatorio sin selección:', nombrePaso);
                    } else {
                        console.log('✅ Paso obligatorio con selección válida');
                    }
                }
            });
            
        } else {
            // Modo tradicional (para compatibilidad)
            console.log('Validando en modo tradicional');
            
            // Limpiar errores previos
            document.querySelectorAll('.opcion-grupo.error').forEach(function(group) {
                group.classList.remove('error');
                // Limpiar estilos de error específicos
                if (esMobil) {
                    group.style.border = '';
                    group.style.background = '';
                    group.style.borderRadius = '';
                    group.style.padding = '';
                    group.style.margin = '';
                } else {
                    group.style.border = '';
                    group.style.borderRadius = '';
                    group.style.padding = '';
                    group.style.backgroundColor = '';
                }
            });
            
            // Verificar cada grupo de opciones obligatorias
            var gruposObligatorios = document.querySelectorAll('.opcion-grupo');
            gruposObligatorios.forEach(function(grupo) {
                var badge = grupo.querySelector('.badge.bg-danger');
                if (badge) { // Es obligatorio
                    var inputs = grupo.querySelectorAll('input[type="checkbox"], input[type="radio"]');
                    var tieneSeleccion = Array.from(inputs).some(function(input) {
                        return input.checked;
                    });
                    
                    if (!tieneSeleccion) {
                        valido = false;
                        grupo.classList.add('error');
                        
                        // Aplicar estilos de error específicos por dispositivo
                        if (esMobil) {
                            grupo.style.border = '3px solid #dc3545 !important';
                            grupo.style.background = 'rgba(220, 53, 69, 0.1) !important';
                            grupo.style.borderRadius = '8px !important';
                            grupo.style.padding = '10px !important';
                            grupo.style.margin = '5px 0 !important';
                        } else {
                            grupo.style.border = '2px solid #dc3545';
                            grupo.style.backgroundColor = 'rgba(220, 53, 69, 0.05)';
                            grupo.style.borderRadius = '5px';
                            grupo.style.padding = '8px';
                        }
                        
                        var titulo = grupo.querySelector('.opcion-titulo span');
                        errores.push(titulo ? titulo.textContent : 'Una opción obligatoria');
                    }
                }
            });
        }
        
        console.log('Resultado de validación:', { valido, errores });
        
        if (!valido) {
            // Mostrar mensaje de error específico
            console.log('Mostrando mensaje de error para:', errores);
            alert('Por favor selecciona una opción para: ' + errores.join(', '));
        }
        
        return valido;
    }

    function actualizarTotalModal() {
        var productoId = document.getElementById('modal-producto-id').value;
        var producto = opcionesPorProducto[productoId];
        if (!producto) return;
        
        var precioBase = parseFloat(producto.precio) || 0;
        var cantidad = parseInt(document.getElementById('input-cantidad').value) || 1;
        
        // También tomar cantidad desde el control de desktop si existe
        var cantidadDesktop = document.getElementById('cantidad');
        if (cantidadDesktop) {
            cantidad = parseInt(cantidadDesktop.value) || 1;
            // Sincronizar ambos inputs
            var inputCantidad = document.getElementById('input-cantidad');
            if (inputCantidad) {
                inputCantidad.value = cantidad;
            }
        }
        
        var precioOpciones = 0;
        
        // Verificar si estamos en modo wizard
        var wizardContainer = document.getElementById('wizard-container');
        var selectorOpciones = wizardContainer ? '.wizard-input:checked' : '.opcion-input:checked';
        
        // Sumar precios de opciones seleccionadas
        var opcionesSeleccionadas = document.querySelectorAll(selectorOpciones);
        opcionesSeleccionadas.forEach(function(input) {
            var precio = parseFloat(input.getAttribute('data-precio')) || 0;
            precioOpciones += precio;
        });
        
        var total = (precioBase + precioOpciones) * cantidad;
        
        // Actualizar precio total en columna derecha
        var elementoTotal = document.getElementById('precio-total');
        if (elementoTotal) {
            elementoTotal.textContent = '$' + total.toFixed(2);
        }
        
        // Actualizar precio total en columna izquierda (desktop)
        var elementoTotalDesktop = document.getElementById('precio-total-desktop');
        if (elementoTotalDesktop) {
            elementoTotalDesktop.textContent = '$' + total.toFixed(2);
        }
        
        console.log('Total actualizado:', {
            base: precioBase,
            opciones: precioOpciones,
            cantidad: cantidad,
            total: total,
            modo: wizardContainer ? 'wizard' : 'tradicional'
        });
    }

    function filtrarPorSucursal() {
        var sucursalId = localStorage.getItem('sucursal_id');
        var items = document.querySelectorAll('.producto-item');
        items.forEach(function(item) {
            var sucursales = item.getAttribute('data-sucursales').split(',');
            if (!sucursalId || sucursales.includes(sucursalId)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    // Función para cambiar cantidad en desktop
    function cambiarCantidad(incremento) {
        var cantidadInput = document.getElementById('cantidad');
        if (!cantidadInput) return;
        
        var cantidadActual = parseInt(cantidadInput.value) || 1;
        var nuevaCantidad = cantidadActual + incremento;
        
        if (nuevaCantidad >= 1 && nuevaCantidad <= 10) {
            cantidadInput.value = nuevaCantidad;
            actualizarTotalModal();
        }
    }
    
    // Helper para obtener el carrito de la sucursal actual
    function getSucursalId() {
        return localStorage.getItem('sucursal_id') || '';
    }
    function getCarritoSucursal() {
        var sucursalId = getSucursalId();
        var carritos = JSON.parse(localStorage.getItem('carritos_por_sucursal') || '{}');
        return carritos[sucursalId] || [];
    }
    function setCarritoSucursal(carrito) {
        var sucursalId = getSucursalId();
        var carritos = JSON.parse(localStorage.getItem('carritos_por_sucursal') || '{}');
        carritos[sucursalId] = carrito;
        localStorage.setItem('carritos_por_sucursal', JSON.stringify(carritos));
    }

    // Actualiza el header del carrito para la sucursal actual
    function actualizarCarritoHeader() {
        var carrito = getCarritoSucursal();
        var total = 0;
        var cantidad = 0;
        carrito.forEach(function(item) {
            cantidad += item.cantidad || 1;
            
            // Calcular precio con opciones personalizadas
            var precioConOpciones = item.precio || 0;
            if (item.opciones_personalizadas && Array.isArray(item.opciones_personalizadas)) {
                item.opciones_personalizadas.forEach(function(opcion) {
                    if (opcion.precio) {
                        precioConOpciones += parseFloat(opcion.precio);
                    }
                });
            }
            
            total += precioConOpciones * (item.cantidad || 1);
        });
        var cartCount = document.getElementById('cart-count');
        var cartTotal = document.getElementById('cart-total');
        if (cartCount) cartCount.textContent = cantidad;
        if (cartTotal) cartTotal.textContent = '$' + total.toFixed(2);
    }
    document.addEventListener('DOMContentLoaded', function() {
        // Event listener para el botón de agregar al carrito en desktop
        document.addEventListener('click', function(e) {
            if (e.target && e.target.id === 'btn-agregar-carrito-desktop') {
                e.preventDefault();
                var formulario = document.getElementById('form-personalizar');
                if (formulario) {
                    formulario.submit();
                }
            }
        });
        
        // Event listener para sincronizar cambios en cantidad desktop
        document.addEventListener('input', function(e) {
            if (e.target && e.target.id === 'cantidad') {
                actualizarTotalModal();
            }
        });
        
        var sucursalId = localStorage.getItem('sucursal_id');
        if (!sucursalId) {
            var modal = new bootstrap.Modal(document.getElementById('modalSucursal'));
            modal.show();
            document.getElementById('btnElegirSucursal').onclick = function() {
                if (!validarSucursalSeleccionada()) {
                    return;
                }
                
                var sucursalSeleccionada = document.querySelector('input[name="sucursal_radio"]:checked');
                if (sucursalSeleccionada) {
                    localStorage.setItem('sucursal_id', sucursalSeleccionada.value);
                    
                    // Obtener información de la sucursal para mostrar
                    var sucursalCard = sucursalSeleccionada.closest('.sucursal-option');
                    var sucursalNombre = sucursalCard.querySelector('.card-title').textContent;
                    var estado = sucursalCard.querySelector('.badge').textContent.trim();
                    
                    localStorage.setItem('sucursal_nombre', sucursalNombre);
                    
                    filtrarPorSucursal();
                    modal.hide();
                    
                    // Mostrar mensaje de confirmación con estado
                    mostrarNotificacion(`Sucursal seleccionada: ${sucursalNombre} (${estado})`, 'success');
                } else {
                    mostrarNotificacion('Por favor selecciona una sucursal', 'warning');
                }
            };
        } else {
            filtrarPorSucursal();
        }

        // Abrir modal al hacer click en cualquier parte del card
        document.querySelectorAll('.producto-card').forEach(function(card) {
            card.addEventListener('click', function(e) {
                // Evita abrir dos veces si el botón fue clickeado
                if (e.target.closest('.agregar-btn')) return;
                var id = card.getAttribute('data-producto-id');
                mostrarModal(id);
            });
        });

        // Ripple effect for "Agregar" button
        document.querySelectorAll('.agregar-btn').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                var ripple = btn.querySelector('.agregar-ripple');
                if (ripple) {
                    ripple.style.left = (e.offsetX - 50) + 'px';
                    ripple.style.top = (e.offsetY - 50) + 'px';
                    ripple.classList.remove('show');
                    void ripple.offsetWidth;
                    ripple.classList.add('show');
                    setTimeout(function() {
                        ripple.classList.remove('show');
                    }, 600);
                }
            });
        });

        // Toast flotante "Agregado al carrito"
        var form = document.getElementById('form-personalizar');
        if (form) {
            form.onsubmit = function(e) {
                e.preventDefault();
                console.log('=== SUBMIT DEL FORMULARIO INICIADO ===');
                
                // Detectar si estamos en desktop (pantalla grande)
                var esDesktop = window.innerWidth >= 992;
                console.log('Es desktop:', esDesktop);
                
                // Usar validación específica según la plataforma
                var validacionExitosa = false;
                if (esDesktop) {
                    validacionExitosa = validarModalDesktop();
                } else {
                    validacionExitosa = validarOpcionesObligatorias();
                }
                
                if (!validacionExitosa) {
                    console.log('Validación fallida');
                    return false;
                }
                
                // Obtener datos del producto y cantidad
                var productoId = document.getElementById('producto_id').value;
                console.log('Producto ID:', productoId);
                var cantidad = parseInt(form.querySelector('[name="cantidad"]').value) || 1;
                console.log('Cantidad:', cantidad);
                var producto = opcionesPorProducto[productoId];
                console.log('Producto encontrado:', producto);
                var precio = producto && producto.precio ? parseFloat(producto.precio) : 0;
                console.log('Precio base:', precio);
                
                // Obtener opciones personalizadas seleccionadas
                var opcionesPersonalizadas = [];
                
                // Verificar si estamos en modo wizard
                var wizardContainer = document.getElementById('wizard-container');
                
                if (wizardContainer) {
                    // Modo wizard - obtener opciones de los inputs del wizard
                    console.log('Recolectando opciones en modo wizard');
                    var wizardInputs = document.querySelectorAll('.wizard-input:checked');
                    wizardInputs.forEach(function(input) {
                        var precio = parseFloat(input.getAttribute('data-precio')) || 0;
                        opcionesPersonalizadas.push({
                            texto: input.value,
                            precio: precio
                        });
                    });
                } else {
                    // Modo tradicional
                    console.log('Recolectando opciones en modo tradicional');
                    if (producto && producto.opciones) {
                        producto.opciones.forEach(function(opcion) {
                            var inputs = document.querySelectorAll('input[name="' + opcion.nombre + '"], input[name="' + opcion.nombre + '[]"]');
                            inputs.forEach(function(input) {
                                if (input.checked) {
                                    // Buscar la opción correspondiente en la data del producto
                                    var opcionData = opcion.opciones.find(function(opt) {
                                        return opt.texto === input.value;
                                    });
                                    if (opcionData) {
                                        opcionesPersonalizadas.push({
                                            texto: opcionData.texto,
                                            precio: opcionData.precio || 0
                                        });
                                    }
                                }
                            });
                        });
                    }
                }
                
                console.log('Opciones personalizadas recolectadas:', opcionesPersonalizadas);
                
                var carrito = getCarritoSucursal();
                var existente = carrito.find(function(item) { 
                    return item.id == productoId && JSON.stringify(item.opciones_personalizadas) === JSON.stringify(opcionesPersonalizadas);
                });
                if (existente) {
                    existente.cantidad += cantidad;
                } else {
                    carrito.push({
                        id: productoId,
                        cantidad: cantidad,
                        precio: precio,
                        nombre: producto.nombre,
                        opciones_personalizadas: opcionesPersonalizadas
                    });
                }
                setCarritoSucursal(carrito);
                actualizarCarritoHeader();

                // Poblar información del toast
                var toastImg = document.getElementById('toast-producto-img');
                var toastNombre = document.getElementById('toast-producto-nombre');
                var toastCantidad = document.getElementById('toast-producto-cantidad');
                var toastPrecio = document.getElementById('toast-producto-precio');
                
                // Obtener imagen del producto desde el modal
                var modalImg = document.querySelector('#modalProducto .modal-body img');
                if (modalImg && toastImg) {
                    toastImg.src = modalImg.src;
                    toastImg.alt = producto.nombre;
                }
                
                if (toastNombre) toastNombre.textContent = producto.nombre;
                if (toastCantidad) toastCantidad.textContent = cantidad;
                if (toastPrecio) toastPrecio.textContent = '$' + (precio * cantidad).toFixed(2);

                // Mostrar toast con duración más larga
                var toastEl = document.getElementById('toastCarrito');
                var toast = new bootstrap.Toast(toastEl, { delay: 5000 });
                toast.show();
                
                var modal = bootstrap.Modal.getInstance(document.getElementById('modalProducto'));
                if (modal) modal.hide();
            };
        }
        // Mejorar cantidad con botones +/-
        var inputCantidad = document.getElementById('input-cantidad');
        var btnSumar = document.getElementById('btn-sumar-cantidad');
        var btnRestar = document.getElementById('btn-restar-cantidad');
        if (inputCantidad && btnSumar && btnRestar) {
            btnSumar.onclick = function() {
                inputCantidad.value = Math.max(1, parseInt(inputCantidad.value) + 1);
                actualizarTotalModal();
            };
            btnRestar.onclick = function() {
                inputCantidad.value = Math.max(1, parseInt(inputCantidad.value) - 1);
                actualizarTotalModal();
            };
        }
        actualizarCarritoHeader();
    });

    function finalizarWizardMovil() {
        console.log('=== FINALIZANDO WIZARD MÓVIL ===');
        
        // Debug: Mostrar todas las selecciones actuales
        const todasLasSelecciones = document.querySelectorAll('.wizard-input:checked');
        console.log('Selecciones encontradas:', todasLasSelecciones.length);
        todasLasSelecciones.forEach((input, index) => {
            const step = input.closest('.wizard-step');
            const stepIndex = step ? step.getAttribute('data-step') : 'N/A';
            console.log(`Selección ${index + 1}:`, {
                input: input.id,
                name: input.name,
                value: input.value,
                step: stepIndex,
                obligatorio: step ? step.getAttribute('data-obligatorio') : 'N/A'
            });
        });
        
        // Validar opciones obligatorias
        console.log('Iniciando validación de opciones obligatorias...');
        const validacionResultado = validarOpcionesObligatorias();
        console.log('Resultado de validación:', validacionResultado);
        
        if (!validacionResultado) {
            console.log('❌ Validación falló - no se puede finalizar wizard');
            return false;
        }
        
        console.log('✅ Validación exitosa - procediendo a agregar al carrito');
        
        // Obtener datos del producto y cantidad
        var productoId = document.getElementById('modal-producto-id').value;
        var cantidad = 1; // Por defecto
        var producto = opcionesPorProducto[productoId];
        var precio = producto && producto.precio ? parseFloat(producto.precio) : 0;
        
        // Obtener opciones personalizadas seleccionadas del wizard
        var opcionesPersonalizadas = [];
        var wizardInputs = document.querySelectorAll('.wizard-input:checked');
        wizardInputs.forEach(function(input) {
            var precio = parseFloat(input.getAttribute('data-precio')) || 0;
            opcionesPersonalizadas.push({
                nombre: input.name,
                valor: input.value,
                precio: precio
            });
        });
        
        console.log('Opciones personalizadas recolectadas:', opcionesPersonalizadas);
        
        var carrito = getCarritoSucursal();
        var existente = carrito.find(function(item) { 
            return item.id == productoId && JSON.stringify(item.opciones_personalizadas) === JSON.stringify(opcionesPersonalizadas);
        });
        
        if (existente) {
            existente.cantidad += cantidad;
        } else {
            carrito.push({
                id: productoId,
                cantidad: cantidad,
                precio: precio,
                nombre: producto.nombre,
                opciones_personalizadas: opcionesPersonalizadas
            });
        }
        
        setCarritoSucursal(carrito);
        actualizarCarritoHeader();

        // Poblar información del toast
        var toastImg = document.getElementById('toast-producto-img');
        var toastNombre = document.getElementById('toast-producto-nombre');
        var toastCantidad = document.getElementById('toast-producto-cantidad');
        var toastPrecio = document.getElementById('toast-producto-precio');
        
        // Obtener imagen del producto desde el modal
        var modalImg = document.querySelector('#modalProducto .modal-body img');
        if (modalImg && toastImg) {
            toastImg.src = modalImg.src;
            toastImg.alt = producto.nombre;
        }
        
        if (toastNombre) toastNombre.textContent = producto.nombre;
        if (toastCantidad) toastCantidad.textContent = cantidad;
        if (toastPrecio) toastPrecio.textContent = '$' + (precio * cantidad).toFixed(2);

        // Mostrar toast con duración más larga
        var toastEl = document.getElementById('toastCarrito');
        var toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        toast.show();
        
        var modal = bootstrap.Modal.getInstance(document.getElementById('modalProducto'));
        if (modal) modal.hide();
    }

    // ========== FUNCIONES DE FILTRADO POR CATEGORÍAS ==========
    
    function filtrarPorCategoria(categoriaId) {
        // Actualizar botones activos
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Actualizar contenedores de categorías activos
        document.querySelectorAll('.category-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Agregar clase activa al botón y contenedor seleccionado
        const botonSeleccionado = document.querySelector(`[data-categoria="${categoriaId}"]`);
        const contenedorSeleccionado = botonSeleccionado.closest('.category-item');
        
        botonSeleccionado.classList.add('active');
        if (contenedorSeleccionado) {
            contenedorSeleccionado.classList.add('active');
        }
        
        // Filtrar productos
        const productos = document.querySelectorAll('.producto-item');
        let visibleCount = 0;
        
        productos.forEach(producto => {
            const productoCategoriaId = producto.getAttribute('data-categoria');
            const sucursalActual = localStorage.getItem('sucursal_id');
            const sucursalesProducto = producto.getAttribute('data-sucursales').split(',');
            
            // Verificar si el producto pertenece a la sucursal actual
            const disponibleEnSucursal = !sucursalActual || sucursalesProducto.includes(sucursalActual);
            
            // Verificar si el producto pertenece a la categoría seleccionada
            const perteneceCategoria = categoriaId === 'todos' || productoCategoriaId === categoriaId;
            
            if (perteneceCategoria && disponibleEnSucursal) {
                producto.classList.remove('hidden');
                producto.classList.add('showing');
                visibleCount++;
            } else {
                producto.classList.add('hidden');
                producto.classList.remove('showing');
            }
        });
        
        // Actualizar contadores (opcional)
        actualizarContadoresCategorias();
    }
    
    function actualizarContadoresCategorias() {
        const sucursalActual = localStorage.getItem('sucursal_id');
        const productos = document.querySelectorAll('.producto-item');
        const contadores = {};
        
        // Contar productos por categoría
        productos.forEach(producto => {
            const categoriaId = producto.getAttribute('data-categoria');
            const sucursalesProducto = producto.getAttribute('data-sucursales').split(',');
            const disponibleEnSucursal = !sucursalActual || sucursalesProducto.includes(sucursalActual);
            
            if (disponibleEnSucursal) {
                contadores[categoriaId] = (contadores[categoriaId] || 0) + 1;
                contadores['todos'] = (contadores['todos'] || 0) + 1;
            }
        });
        
        // Actualizar displays de contadores
        Object.keys(contadores).forEach(categoriaId => {
            const contador = document.getElementById(`count-${categoriaId}`);
            if (contador) {
                contador.textContent = contadores[categoriaId] || 0;
            }
        });
    }
    
    // Aplicar filtros iniciales cuando se carga la página
    document.addEventListener('DOMContentLoaded', function() {
        // Filtrar por sucursal inicial si ya está seleccionada
        const sucursalActual = localStorage.getItem('sucursal_id');
        if (sucursalActual) {
            filtrarPorSucursal(sucursalActual);
        }
        
        // Activar categoría "Todos" por defecto
        filtrarPorCategoria('todos');
    });

    // FUNCIONES SEPARADAS PARA MÓVIL Y ESCRITORIO
    function mostrarModalDesktop(id) {
        console.log('=== MODAL DESKTOP INICIADO ===');
        console.log('ID recibido:', id, 'Tipo:', typeof id);
        
        // Verificar que tenemos una sucursal seleccionada
        var sucursalActual = localStorage.getItem('sucursal_id');
        if (!sucursalActual) {
            alert('Por favor selecciona una sucursal primero');
            return;
        }
        
        var producto = opcionesPorProducto[id];
        
        if (!producto) {
            console.error('❌ ERROR: Producto no encontrado para ID:', id);
            return;
        }
        
        console.log('✅ Producto encontrado:', producto);
        
        // Elementos del nuevo modal
        var modalNombre = document.getElementById('modal-nombre');
        var modalPrecio = document.getElementById('modal-precio');
        var modalDescripcion = document.getElementById('modal-descripcion');
        var productoId = document.getElementById('producto_id');
        var opcionesPersonalizadas = document.getElementById('modal-opciones');
        var modalImgContainer = document.getElementById('modal-img-container');
        var cantidadDisplay = document.getElementById('cantidad-display');
        var precioTotalDesktop = document.getElementById('precio-total-desktop');
        
        if (!modalNombre || !productoId || !opcionesPersonalizadas) {
            console.error('❌ ERROR: Elementos del modal no encontrados');
            return;
        }
        
        console.log('✅ Elementos DOM encontrados correctamente');
        
        // Configurar información del producto
        modalNombre.textContent = producto.nombre;
        if (modalPrecio) modalPrecio.textContent = '$' + parseFloat(producto.precio).toFixed(2);
        if (modalDescripcion) modalDescripcion.textContent = producto.descripcion || '';
        menuItemId.value = id;
        
        // Configurar sucursal_id desde localStorage
        var sucursalActual = localStorage.getItem('sucursal_id');
        if (sucursalActual) {
            document.getElementById('sucursal_id').value = sucursalActual;
        }
        
        // Configurar imagen
        if (modalImgContainer) {
            if (producto.imagen) {
                modalImgContainer.innerHTML = '<img src="' + producto.imagen + '" class="img-fluid">';
            } else {
                modalImgContainer.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted"><i class="fas fa-image fa-3x opacity-50"></i></div>';
            }
        }
        
        // Limpiar opciones anteriores
        opcionesPersonalizadas.innerHTML = '';
        
        // Resetear cantidad
        if (cantidadDisplay) cantidadDisplay.textContent = '1';
        document.getElementById('cantidad').value = '1';
        
        // Si el producto tiene opciones, generarlas
        if (producto.opciones && producto.opciones.length > 0) {
            console.log('Generando opciones para escritorio:', producto.opciones.length);
            
            var opcionesHtml = '';
            
            producto.opciones.forEach(function(opcion, index) {
                var nombreInput = opcion.nombre || ('opcion_' + index);
                
                opcionesHtml += '<div class="opciones-personalizadas mb-4">';
                opcionesHtml += '<h6>' + opcion.titulo + '</h6>';
                
                // Agregar opciones individuales
                if (opcion.opciones && opcion.opciones.length > 0) {
                    opcion.opciones.forEach(function(valorOpcion, j) {
                        var inputId = nombreInput + '_' + j;
                        var tipoInput = opcion.tipo === 'checkbox' ? 'checkbox' : 'radio';
                        var nameInput = opcion.tipo === 'radio' ? nombreInput : (nombreInput + '[]');
                        
                        opcionesHtml += '<div class="opcion-item" onclick="toggleOpcion(this, \'' + tipoInput + '\')">';
                        opcionesHtml += '<input type="' + tipoInput + '" id="' + inputId + '" name="' + nameInput + '" value="' + valorOpcion.texto + '" data-precio="' + (valorOpcion.precio || 0) + '" style="display: none;">';
                        opcionesHtml += '<div class="opcion-texto">' + valorOpcion.texto + '</div>';
                        
                        if (valorOpcion.precio && parseFloat(valorOpcion.precio) > 0) {
                            opcionesHtml += '<div class="opcion-precio">+$' + parseFloat(valorOpcion.precio).toFixed(2) + '</div>';
                        }
                        
                        opcionesHtml += '</div>';
                    });
                }
                
                opcionesHtml += '</div>';
            });
            
            opcionesPersonalizadas.innerHTML = opcionesHtml;
        } else {
            opcionesPersonalizadas.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-check-circle fa-3x"></i><h5 class="mt-3">Producto listo</h5><p>Este producto no requiere personalización adicional.</p></div>';
        }
        
        // Calcular precio inicial
        actualizarPrecio();
        
        // Mostrar modal
        var modal = new bootstrap.Modal(document.getElementById('modalProducto'));
        modal.show();
        
        console.log('✅ Modal mostrado exitosamente');
    }

    // Función para manejar clic en opciones del modal desktop
    function toggleOpcion(element, tipo) {
        var input = element.querySelector('input');
        
        if (tipo === 'radio') {
            // Para radio: deseleccionar otros del mismo grupo
            var name = input.name;
            var otrosInputs = document.querySelectorAll('input[name="' + name + '"]');
            otrosInputs.forEach(function(otroInput) {
                otroInput.checked = false;
                otroInput.closest('.opcion-item').classList.remove('selected');
            });
            
            // Seleccionar el actual
            input.checked = true;
            element.classList.add('selected');
        } else {
            // Para checkbox: toggle
            input.checked = !input.checked;
            element.classList.toggle('selected', input.checked);
        }
        
        actualizarPrecio();
    }

    // Función para cambiar cantidad
    function cambiarCantidad(delta) {
        var cantidadInput = document.getElementById('cantidad');
        var cantidadDisplay = document.getElementById('cantidad-display');
        
        var nuevaCantidad = parseInt(cantidadInput.value) + delta;
        if (nuevaCantidad < 1) nuevaCantidad = 1;
        if (nuevaCantidad > 10) nuevaCantidad = 10;
        
        cantidadInput.value = nuevaCantidad;
        if (cantidadDisplay) cantidadDisplay.textContent = nuevaCantidad;
        
        actualizarPrecio();
    }

    // Función para actualizar el precio total
    function actualizarPrecio() {
        var productoId = document.getElementById('producto_id').value;
        var producto = opcionesPorProducto[productoId];
        
        if (!producto) return;
        
        var precioBase = parseFloat(producto.precio) || 0;
        var cantidad = parseInt(document.getElementById('cantidad').value) || 1;
        var precioOpciones = 0;
        
        // Calcular precio de opciones seleccionadas
        var opcionesSeleccionadas = document.querySelectorAll('#modal-opciones input:checked');
        opcionesSeleccionadas.forEach(function(input) {
            var precio = parseFloat(input.getAttribute('data-precio')) || 0;
            precioOpciones += precio;
        });
        
        var total = (precioBase + precioOpciones) * cantidad;
        
        // Actualizar displays de precio
        var precioTotalDesktop = document.getElementById('precio-total-desktop');
        if (precioTotalDesktop) {
            precioTotalDesktop.textContent = '$' + total.toFixed(2);
        }
    }

    // Función de validación simple para el modal de escritorio
    function validarModalDesktop() {
        console.log('=== VALIDANDO MODAL DESKTOP ===');
        
        var productoId = document.getElementById('producto_id').value;
        var producto = opcionesPorProducto[productoId];
        
        if (!producto || !producto.opciones) {
            console.log('No hay opciones que validar');
            return true;
        }
        
        var valido = true;
        var errores = [];
        
        // Verificar cada grupo de opciones obligatorias
        producto.opciones.forEach(function(opcion, index) {
            if (opcion.obligatorio) {
                var nombreInput = opcion.nombre || ('opcion_' + index);
                var inputs = document.querySelectorAll('input[name="' + nombreInput + '"]');
                var tieneSeleccion = false;
                
                inputs.forEach(function(input) {
                    if (input.checked) {
                        tieneSeleccion = true;
                    }
                });
                
                if (!tieneSeleccion) {
                    valido = false;
                    errores.push(opcion.titulo);
                    console.log('❌ Opción obligatoria sin seleccionar:', opcion.titulo);
                }
            }
        });
        
        if (!valido) {
            alert('Por favor selecciona las siguientes opciones obligatorias:\n- ' + errores.join('\n- '));
        }
        
        return valido;
    }
            });
            
            modalOpciones.innerHTML = opcionesHtml;
        } else {
            // Producto sin opciones - versión mejorada
            modalOpciones.innerHTML = '<div class="text-center text-muted p-4">' +
                '<div class="mb-3">' +
                '<i class="fas fa-check-circle fa-4x text-success opacity-75"></i>' +
                '</div>' +
                '<h5 class="text-success">¡Listo para agregar!</h5>' +
                '<p class="mb-0">Este producto no requiere opciones adicionales</p>' +
                '</div>';
        }
        
        // Actualizar precio inicial
        actualizarTotalModal();
        
        // Agregar event listeners para hacer toda la opción clickeable (solo desktop)
        setTimeout(function() {
            const formChecks = document.querySelectorAll('#modal-opciones .form-check');
            formChecks.forEach(function(formCheck) {
                // Agregar listener al contenedor completo
                formCheck.addEventListener('click', function(e) {
                    // Solo proceder si no se hizo click directamente en el input oculto
                    if (e.target.type !== 'radio' && e.target.type !== 'checkbox') {
                        const input = formCheck.querySelector('.form-check-input');
                        if (input) {
                            // Para radio buttons, desmarcar otros en el mismo grupo
                            if (input.type === 'radio') {
                                const allRadios = document.querySelectorAll(`input[name="${input.name}"]`);
                                allRadios.forEach(radio => radio.checked = false);
                            }
                            
                            // Alternar el estado del input actual
                            if (input.type === 'checkbox') {
                                input.checked = !input.checked;
                            } else {
                                input.checked = true;
                            }
                            
                            // Disparar evento change para actualizar precios
                            input.dispatchEvent(new Event('change'));
                        }
                    }
                });
            });
        }, 100);
        
        // Mostrar modal
        var modal = new bootstrap.Modal(document.getElementById('modalProducto'));
        modal.show();
        
        // FORZAR VISIBILIDAD DE OPCIONES EN DESKTOP
        setTimeout(function() {
            const modalOpcionesEl = document.getElementById('modal-opciones');
            const opcionesContainer = document.querySelector('.opciones-container');
            const opcionGrupos = document.querySelectorAll('.opcion-grupo');
            const opcionItems = document.querySelectorAll('.opcion-item');
            const formChecks = document.querySelectorAll('#modal-opciones .form-check');
            
            console.log('🔍 Forzando visibilidad en desktop...');
            
            if (modalOpcionesEl) {
                modalOpcionesEl.style.display = 'block !important';
                modalOpcionesEl.style.visibility = 'visible !important';
                modalOpcionesEl.style.opacity = '1 !important';
                console.log('✅ modal-opciones visible');
            }
            
            if (opcionesContainer) {
                opcionesContainer.style.display = 'block !important';
                opcionesContainer.style.visibility = 'visible !important';
                opcionesContainer.style.opacity = '1 !important';
                console.log('✅ opciones-container visible');
            }
            
            opcionGrupos.forEach((grupo, i) => {
                grupo.style.display = 'block !important';
                grupo.style.visibility = 'visible !important';
                grupo.style.opacity = '1 !important';
                console.log(`✅ opcion-grupo ${i} visible`);
            });
            
            opcionItems.forEach((item, i) => {
                item.style.display = 'block !important';
                item.style.visibility = 'visible !important';
                item.style.opacity = '1 !important';
                console.log(`✅ opcion-item ${i} visible`);
            });
            
            formChecks.forEach((check, i) => {
                check.style.display = 'flex !important';
                check.style.visibility = 'visible !important';
                check.style.opacity = '1 !important';
                console.log(`✅ form-check ${i} visible`);
            });
            
            console.log('🎉 Visibilidad forzada completada en desktop');
        }, 200);
        
        console.log('✅ Modal desktop mostrado correctamente');
    }

    function mostrarModalMovil(id) {
        console.log('=== INICIANDO MODAL MÓVIL ===');
        const producto = opcionesPorProducto[id];
        console.log('Producto recibido:', producto);
        console.log('ID del producto:', id);
        console.log('Opciones del producto:', producto ? producto.opciones : 'NO HAY PRODUCTO');
        
        if (!producto) {
            console.error('PRODUCTO NO ENCONTRADO');
            return;
        }
        
        if (!producto.opciones || !Array.isArray(producto.opciones) || producto.opciones.length === 0) {
            console.log('Producto sin opciones, mostrando modal simple móvil');
            mostrarModalSimple(id);
            return;
        }
        
        // Configurar variables globales
        window.currentProductId = id;
        window.currentWizardStep = 0;
        window.wizardTotalSteps = producto.opciones.length;
        
        console.log('Configurado:', {
            productId: id,
            currentStep: 0,
            totalSteps: window.wizardTotalSteps,
            primeraOpcion: producto.opciones[0]
        });
        
        // Generar contenido del wizard móvil
        let modalContent = `
        <div class="modal fade" id="productModal" tabindex="-1">
            <div class="modal-dialog modal-lg" style="margin: 10px; max-width: calc(100% - 20px); height: calc(100vh - 20px);">
                <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #e97c1a, #ffcc33); color: white; flex-shrink: 0;">
                        <h5 class="modal-title">
                            <i class="fas fa-utensils me-2"></i>
                            Personalizar: ${producto.nombre}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" style="padding: 15px; flex: 1; overflow-y: auto; display: flex; flex-direction: column;">
                        
                        <!-- Imagen del producto -->
                        ${producto.imagen ? `
                        <div class="text-center mb-3" style="flex-shrink: 0;">
                            <img src="${producto.imagen}" class="img-fluid rounded" style="max-height: 150px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                        </div>` : ''}
                        
                        <!-- Indicador de progreso -->
                        <div class="progress-indicator mb-3" style="display: flex; justify-content: center; align-items: center; gap: 8px; flex-shrink: 0;">`;
        
        // Generar círculos de progreso (más pequeños para móvil)
        for (let i = 0; i < producto.opciones.length; i++) {
            modalContent += `<div class="step-circle" id="step-${i}" style="width: 30px; height: 30px; border-radius: 50%; border: 2px solid #dee2e6; background: #f8f9fa; color: #6c757d; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 12px;">${i + 1}</div>`;
            if (i < producto.opciones.length - 1) {
                modalContent += `<div class="step-line" style="width: 20px; height: 2px; background: #dee2e6;"></div>`;
            }
        }
        
        modalContent += `</div>
                        
                        <!-- Contenedor de preguntas con scroll automático -->
                        <div id="question-container" style="flex: 1; min-height: 0; overflow-y: auto;">`;
        
        // Generar cada paso del wizard
        producto.opciones.forEach((opcion, index) => {
            console.log('Generando paso', index, 'para opción:', opcion.titulo);
            
            const badgeClass = opcion.obligatorio ? 'bg-success' : 'bg-secondary';
            const badgeText = opcion.obligatorio ? 'OBLIGATORIO' : 'OPCIONAL';
            
            modalContent += `
            <div class="wizard-step" id="wizard-step-${index}" data-step="${index}" data-obligatorio="${opcion.obligatorio}" 
                 style="display: ${index === 0 ? 'block' : 'none'}; background: white; padding: 20px 15px; border-radius: 12px; margin-bottom: 15px; border: 2px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                
                <!-- Título de la pregunta -->
                <h3 style="font-weight: 700; color: #2c3e50; margin-bottom: 15px; font-size: 1.2rem; text-align: center;">
                    <i class="fas fa-question-circle me-2" style="color: #e97c1a;"></i>
                    ${opcion.titulo}
                </h3>
                
                <!-- Badge obligatorio/opcional -->
                <div class="mb-3 text-center">
                    <span class="badge ${badgeClass}" style="font-size: 0.9rem; padding: 8px 16px; font-weight: 600;">${badgeText}</span>
                </div>
                
                <!-- Instrucciones -->
                <div style="color: #6c757d; font-size: 1rem; margin-bottom: 20px; font-style: italic; text-align: center;">
                    ${opcion.obligatorio ? 'Selecciona una opción' : 'Selecciona una opción (opcional)'}
                </div>
                
                <!-- Lista de opciones -->
                <div class="options-grid" style="display: grid; gap: 12px; margin-bottom: 20px;">`;
            
            // Generar opciones
            if (opcion.opciones && opcion.opciones.length > 0) {
                console.log('Opción', index, 'tiene', opcion.opciones.length, 'valores');
                opcion.opciones.forEach((opt, idx) => {
                    const inputType = opcion.tipo;
                    const inputName = opcion.tipo === 'checkbox' ? `${opcion.nombre}[]` : opcion.nombre;
                    const precioTexto = opt.precio > 0 ? ` (+$${opt.precio})` : '';
                    
                    modalContent += `
                    <div class="wizard-option" onclick="seleccionarOpcionWizard('wizard-input-${index}-${idx}', ${index})" 
                         style="padding: 15px; border: 3px solid #dee2e6; border-radius: 10px; background: #f8f9fa; cursor: pointer; transition: all 0.3s ease; min-height: 60px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <input type="${inputType}" id="wizard-input-${index}-${idx}" name="${inputName}" 
                               value="${opt.texto}" class="wizard-input" style="display: none;"
                               data-precio="${opt.precio || 0}">
                        <div style="font-weight: 600; color: #2c3e50; font-size: 1.1rem; text-align: center; line-height: 1.3;">
                            ${opt.texto_mostrado || opt.texto}${precioTexto}
                        </div>
                    </div>`;
                });
            } else {
                console.log('ADVERTENCIA: Opción', index, 'no tiene valores');
                modalContent += `<div style="color: red; font-size: 1.2rem; padding: 20px;">ERROR: Esta opción no tiene valores definidos</div>`;
            }
            
            modalContent += `</div>
                
                <!-- Los botones ahora estarán en el footer -->
            </div>`;
        });
        
        modalContent += `</div>
                    </div>
                    <div class="modal-footer" style="background: #f8f9fa; border-top: 1px solid #dee2e6; padding: 12px 15px; flex-shrink: 0; position: sticky; bottom: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; gap: 10px;">
                        
                        <!-- Botones de la izquierda -->
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cancelar
                            </button>
                            
                            <!-- Botón omitir - se mostrará dinámicamente -->
                            <button type="button" class="btn btn-sm btn-outline-secondary wizard-omitir" id="omitir-btn" 
                                    style="display: none; padding: 8px 16px; font-size: 0.9rem; border-radius: 18px; font-weight: 600;">
                                <i class="fas fa-forward me-1"></i>Omitir
                            </button>
                        </div>
                        
                        <!-- Información del centro -->
                        <div class="text-muted small text-center" style="flex: 1;">
                            <i class="fas fa-clock me-1"></i>
                            Paso <span id="current-step-display">1</span> de ${producto.opciones.length}
                        </div>
                        
                        <!-- Botón de la derecha -->
                        <div>
                            <button type="button" class="btn btn-sm btn-primary wizard-continue" id="main-continue-btn" 
                                    style="padding: 8px 20px; font-size: 0.9rem; border-radius: 18px; font-weight: 600; background: linear-gradient(135deg, #e97c1a, #ffcc33); border: none; color: white; min-width: 100px;">
                                <i class="fas fa-arrow-right me-1"></i>Continuar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        
        console.log('HTML generado, longitud:', modalContent.length);
        
        // Buscar o crear el contenedor del modal
        let modalContainer = document.getElementById('modalContainer');
        if (!modalContainer) {
            modalContainer = document.createElement('div');
            modalContainer.id = 'modalContainer';
            document.body.appendChild(modalContainer);
            console.log('Contenedor de modal creado');
        }
        
        modalContainer.innerHTML = modalContent;
        console.log('HTML insertado en contenedor');
        
        // VALIDAR QUE LOS PASOS SE CREARON CORRECTAMENTE
        setTimeout(() => {
            console.log('=== VALIDANDO PASOS CREADOS ===');
            const todosLosPasos = document.querySelectorAll('.wizard-step');
            console.log('Total de pasos encontrados:', todosLosPasos.length);
            
            todosLosPasos.forEach((paso, index) => {
                const titulo = paso.querySelector('h3');
                const opciones = paso.querySelectorAll('.wizard-option');
                console.log(`Paso ${index}:`, {
                    id: paso.id,
                    titulo: titulo ? titulo.textContent.trim() : 'SIN TÍTULO',
                    opciones: opciones.length,
                    display: paso.style.display,
                    visible: paso.offsetHeight > 0
                });
            });
            
            // Mostrar el primer paso
            mostrarPasoWizardMovil(0);
            console.log('=== VALIDACIÓN COMPLETADA ===');
        }, 100);
        
        // Inicializar progreso
        actualizarProgresoMovil(0);
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
        
        console.log('=== MODAL MÓVIL MOSTRADO ===');
    }

    function mostrarModalSimple(id) {
        const producto = opcionesPorProducto[id];
        if (!producto) return;
        
        window.currentProductId = id;
        
        const modalContent = `
        <div class="modal fade" id="productModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Agregar: ${producto.nombre}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <div class="mb-4">
                            ${producto.imagen ? `<img src="${producto.imagen}" class="img-fluid rounded mb-3" style="max-height: 200px;">` : ''}
                            <h4>${producto.nombre}</h4>
                            <p class="text-muted">Este producto no tiene opciones adicionales.</p>
                            <div class="fs-3 fw-bold text-success">$${(producto.precio || 0).toFixed(2)}</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="agregarProductoSimple()">Agregar al carrito</button>
                    </div>
                </div>
            </div>
        </div>`;
        
        let modalContainer = document.getElementById('modalContainer');
        if (!modalContainer) {
            modalContainer = document.createElement('div');
            modalContainer.id = 'modalContainer';
            document.body.appendChild(modalContainer);
        }
        
        modalContainer.innerHTML = modalContent;
        
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
    }

    function agregarProductoSimple() {
        agregarProductoAlCarrito(window.currentProductId, 1, {});
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
        modal.hide();
    }

    function mostrarModalEscritorio(id) {
        const producto = opcionesPorProducto[id];
        if (!producto) {
            console.error('Producto no encontrado para ID:', id);
            return;
        }
        
        window.currentProductId = id;
        
        let modalContent = `
        <div class="modal fade" id="productModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Personalizar: ${producto.nombre}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">`;
        
        // Si no tiene opciones, mostrar versión simple
        if (!producto.opciones || !Array.isArray(producto.opciones) || producto.opciones.length === 0) {
            modalContent += `
                        <div class="text-center">
                            ${producto.imagen ? `<img src="${producto.imagen}" class="img-fluid rounded mb-3" style="max-height: 200px;">` : ''}
                            <h4>${producto.nombre}</h4>
                            <p class="text-muted">Este producto no tiene opciones adicionales.</p>
                            <div class="fs-3 fw-bold text-success">$${(producto.precio || 0).toFixed(2)}</div>
                        </div>`;
        } else {
            modalContent += `<form id="productForm">`;
            
            // Procesar cada opción
            producto.opciones.forEach(opcion => {
                const badgeClass = opcion.obligatorio ? 'opcion-obligatorio' : 'opcion-opcional';
                const badgeText = opcion.obligatorio ? 'OBLIGATORIO' : 'OPCIONAL';
                
                modalContent += `
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label fw-bold">${opcion.titulo}</label>
                        <span class="badge ${badgeClass}">${badgeText}</span>
                    </div>`;
                
                if (opcion.instrucciones) {
                    modalContent += `<p class="text-muted small mb-2">${opcion.instrucciones}</p>`;
                }
                
                // Procesar valores de la opción
                if (opcion.opciones && opcion.opciones.length > 0) {
                    opcion.opciones.forEach(valor => {
                        const inputType = opcion.permite_multiple ? 'checkbox' : 'radio';
                        const inputName = opcion.permite_multiple ? `opcion_${opcion.id}[]` : `opcion_${opcion.id}`;
                        const precioTexto = valor.precio_adicional > 0 ? ` (+$${valor.precio_adicional})` : '';
                        
                        modalContent += `
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="${inputType}" 
                                   name="${inputName}" value="${valor.id}" 
                                   id="valor_${valor.id}"
                                   data-precio="${valor.precio_adicional || 0}"
                                   ${opcion.obligatorio ? 'required' : ''}>
                            <label class="form-check-label" for="valor_${valor.id}">
                                ${valor.valor}${precioTexto}
                            </label>
                        </div>`;
                    });
                }
                
                modalContent += `</div>`;
            });
            
            modalContent += `</form>`;
        }
        
        modalContent += `
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>`;
        
        if (!producto.opciones || producto.opciones.length === 0) {
            modalContent += `<button type="button" class="btn btn-primary" onclick="agregarProductoSimple()">Agregar al carrito</button>`;
        } else {
            modalContent += `<button type="button" class="btn btn-primary" onclick="agregarAlCarritoEscritorio()">Agregar al carrito</button>`;
        }
        
        modalContent += `
                    </div>
                </div>
            </div>
        </div>`;
        
        let modalContainer = document.getElementById('modalContainer');
        if (!modalContainer) {
            modalContainer = document.createElement('div');
            modalContainer.id = 'modalContainer';
            document.body.appendChild(modalContainer);
        }
        
        modalContainer.innerHTML = modalContent;
        
        const modal = new bootstrap.Modal(document.getElementById('productModal'));
        modal.show();
    }

    function agregarAlCarritoEscritorio() {
        const form = document.getElementById('productForm');
        if (!form) {
            // Sin formulario, agregar producto simple
            agregarProductoSimple();
            return;
        }
        
        const formData = new FormData(form);
        const selectedOptions = {};
        
        // Recopilar todas las opciones seleccionadas
        for (let [key, value] of formData.entries()) {
            if (key.startsWith('opcion_')) {
                const opcionId = key.replace('opcion_', '').replace('[]', '');
                if (!selectedOptions[opcionId]) {
                    selectedOptions[opcionId] = [];
                }
                selectedOptions[opcionId].push(value);
            }
        }
        
        // Validar opciones obligatorias
        const producto = opcionesPorProducto[window.currentProductId];
        if (producto && producto.opciones) {
            const opcionesObligatorias = producto.opciones.filter(op => op.obligatorio);
            
            for (let opcion of opcionesObligatorias) {
                if (!selectedOptions[opcion.id] || selectedOptions[opcion.id].length === 0) {
                    alert(`Por favor selecciona una opción para: ${opcion.titulo}`);
                    return;
                }
            }
        }
        
        // Agregar al carrito usando la lógica existente
        agregarProductoAlCarrito(window.currentProductId, 1, selectedOptions);
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
        modal.hide();
    }

    function agregarAlCarritoMovil() {
        console.log('=== AGREGANDO AL CARRITO MÓVIL ===');
        
        // DEPURACIÓN: Verificar dónde están los pasos del wizard
        const stepsEnProductModal = document.querySelectorAll('#productModal .wizard-step');
        const stepsEnModalOpciones = document.querySelectorAll('#modal-opciones .wizard-step');
        const stepsGeneral = document.querySelectorAll('.wizard-step');
        
        console.log('Pasos en #productModal:', stepsEnProductModal.length);
        console.log('Pasos en #modal-opciones:', stepsEnModalOpciones.length);
        console.log('Pasos generales (.wizard-step):', stepsGeneral.length);
        
        // DEPURACIÓN: Mostrar todas las selecciones actuales
        const todasLasSelecciones = document.querySelectorAll('.wizard-input:checked');
        console.log('Selecciones encontradas:', todasLasSelecciones.length);
        todasLasSelecciones.forEach((input, index) => {
            const step = input.closest('.wizard-step');
            const stepIndex = step ? step.getAttribute('data-step') : 'N/A';
            console.log(`Selección ${index + 1}:`, {
                valor: input.value,
                id: input.id,
                paso: stepIndex,
                obligatorio: step ? step.getAttribute('data-obligatorio') : 'N/A',
                contenedor: step ? (step.closest('#productModal') ? 'productModal' : step.closest('#modal-opciones') ? 'modal-opciones' : step.closest('#wizard-container') ? 'wizard-container' : 'otro') : 'N/A'
            });
        });
        
        // Usar la función de validación centralizada que ya funciona
        console.log('Iniciando validación usando validarOpcionesObligatorias...');
        const validacionResultado = validarOpcionesObligatorias();
        console.log('Resultado de validación:', validacionResultado);
        
        if (!validacionResultado) {
            console.log('❌ Validación falló - no se puede agregar al carrito');
            return;
        }
        
        console.log('✅ Validación exitosa - procediendo a agregar al carrito');
        
        // Recopilar opciones seleccionadas del wizard CON PRECIOS CORRECTOS
        const opcionesPersonalizadas = [];
        const wizardInputs = document.querySelectorAll('.wizard-input:checked');
        
        console.log('=== PROCESANDO OPCIONES SELECCIONADAS ===');
        wizardInputs.forEach((input, index) => {
            const precio = parseFloat(input.getAttribute('data-precio')) || 0;
            const texto = input.value;
            const nombre = input.name;
            
            console.log(`Opción ${index + 1}:`, {
                texto: texto,
                precio: precio,
                nombre: nombre
            });
            
            opcionesPersonalizadas.push({
                texto: texto,
                precio: precio,
                nombre: nombre
            });
        });
        
        console.log('Opciones personalizadas con precios:', opcionesPersonalizadas);
        
        // Calcular precio total (base + opciones)
        const producto = opcionesPorProducto[window.currentProductId];
        const precioBase = parseFloat(producto.precio) || 0;
        const precioOpciones = opcionesPersonalizadas.reduce((total, opcion) => total + opcion.precio, 0);
        const precioTotal = precioBase + precioOpciones;
        
        console.log('Cálculo de precios:', {
            base: precioBase,
            opciones: precioOpciones,
            total: precioTotal
        });
        
        // Agregar al carrito DIRECTAMENTE sin usar agregarProductoAlCarrito
        const carrito = getCarritoSucursal();
        const existente = carrito.find(item => 
            item.id == window.currentProductId && 
            JSON.stringify(item.opciones_personalizadas) === JSON.stringify(opcionesPersonalizadas)
        );
        
        if (existente) {
            existente.cantidad += 1;
            console.log('Producto existente actualizado, nueva cantidad:', existente.cantidad);
        } else {
            const nuevoItem = {
                id: window.currentProductId,
                cantidad: 1,
                precio: precioBase, // Precio base del producto
                nombre: producto.nombre,
                opciones_personalizadas: opcionesPersonalizadas
            };
            carrito.push(nuevoItem);
            console.log('Nuevo producto agregado al carrito:', nuevoItem);
        }
        
        setCarritoSucursal(carrito);
        actualizarCarritoHeader();
        
        console.log('Carrito actualizado correctamente');
        
        // Mostrar toast con precio correcto
        mostrarToastAgregadoMovil(producto, 1, precioTotal);
        
        // Cerrar modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
        modal.hide();
    }

    function mostrarToastAgregadoMovil(producto, cantidad, precioTotal) {
        console.log('Mostrando toast móvil:', { producto: producto.nombre, cantidad, precioTotal });
        
        // Poblar información del toast
        const toastImg = document.getElementById('toast-producto-img');
        const toastNombre = document.getElementById('toast-producto-nombre');
        const toastCantidad = document.getElementById('toast-producto-cantidad');
        const toastPrecio = document.getElementById('toast-producto-precio');
        
        if (toastImg && producto.imagen) {
            toastImg.src = producto.imagen;
            toastImg.alt = producto.nombre;
        }
        
        if (toastNombre) toastNombre.textContent = producto.nombre;
        if (toastCantidad) toastCantidad.textContent = cantidad;
        if (toastPrecio) toastPrecio.textContent = '$' + (precioTotal * cantidad).toFixed(2);

        // Mostrar toast
        const toastEl = document.getElementById('toastCarrito');
        if (toastEl) {
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
        } else {
            console.error('Toast element not found');
        }
    }

    function agregarProductoAlCarrito(productoId, cantidad, opcionesSeleccionadas) {
        const producto = opcionesPorProducto[productoId];
        if (!producto) return;
        
        // Calcular opciones personalizadas con precios
        const opcionesPersonalizadas = [];
        
        if (opcionesSeleccionadas && Object.keys(opcionesSeleccionadas).length > 0) {
            Object.keys(opcionesSeleccionadas).forEach(opcionKey => {
                const valores = opcionesSeleccionadas[opcionKey];
                valores.forEach(valorId => {
                    // Buscar el precio de esta opción en los datos del producto
                    if (producto.opciones) {
                        producto.opciones.forEach(opcion => {
                            if (opcion.opciones) {
                                opcion.opciones.forEach(valorOpcion => {
                                    if (valorOpcion.id == valorId) {
                                        opcionesPersonalizadas.push({
                                            texto: valorOpcion.valor,
                                            precio: parseFloat(valorOpcion.precio_adicional) || 0
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
            });
        }
        
        // Agregar al carrito
        const carrito = getCarritoSucursal();
        const existente = carrito.find(item => 
            item.id == productoId && 
            JSON.stringify(item.opciones_personalizadas) === JSON.stringify(opcionesPersonalizadas)
        );
        
        if (existente) {
            existente.cantidad += cantidad;
        } else {
            carrito.push({
                id: productoId,
                cantidad: cantidad,
                precio: parseFloat(producto.precio) || 0,
                nombre: producto.nombre,
                opciones_personalizadas: opcionesPersonalizadas
            });
        }
        
        setCarritoSucursal(carrito);
        actualizarCarritoHeader();
        
        // Mostrar toast de confirmación
        mostrarToastAgregado(producto, cantidad);
    }

    function mostrarToastAgregado(producto, cantidad) {
        // Poblar información del toast
        const toastImg = document.getElementById('toast-producto-img');
        const toastNombre = document.getElementById('toast-producto-nombre');
        const toastCantidad = document.getElementById('toast-producto-cantidad');
        const toastPrecio = document.getElementById('toast-producto-precio');
        
        if (toastImg && producto.imagen) {
            toastImg.src = producto.imagen;
            toastImg.alt = producto.nombre;
        }
        
        if (toastNombre) toastNombre.textContent = producto.nombre;
        if (toastCantidad) toastCantidad.textContent = cantidad;
        if (toastPrecio) toastPrecio.textContent = '$' + ((producto.precio || 0) * cantidad).toFixed(2);

        // Mostrar toast
        const toastEl = document.getElementById('toastCarrito');
        if (toastEl) {
            const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
            toast.show();
        }
    }

    // FUNCIONES ESPECÍFICAS PARA EL WIZARD MÓVIL
    function mostrarPasoWizardMovil(stepIndex) {
        console.log('=== MOSTRANDO PASO MÓVIL ===');
        console.log('Paso solicitado:', stepIndex);
        console.log('Total de pasos:', window.wizardTotalSteps);
        
        // Validar que el paso existe
        if (stepIndex >= window.wizardTotalSteps) {
            console.error('Paso fuera de rango:', stepIndex);
            return;
        }
        
        // Ocultar todos los pasos
        const steps = document.querySelectorAll('.wizard-step');
        console.log('Pasos encontrados:', steps.length);
        
        steps.forEach((step, index) => {
            step.style.display = 'none';
            console.log(`Paso ${index} ocultado`);
        });
        
        // Mostrar el paso actual
        const currentStep = document.getElementById(`wizard-step-${stepIndex}`);
        console.log('Buscando paso:', `wizard-step-${stepIndex}`);
        
        if (currentStep) {
            currentStep.style.display = 'block';
            currentStep.style.opacity = '1';
            currentStep.style.transform = 'translateY(0)';
            console.log(`✓ Paso ${stepIndex} mostrado correctamente`);
            
            // Verificar que el paso tiene contenido
            const titulo = currentStep.querySelector('h3');
            const opciones = currentStep.querySelectorAll('.wizard-option');
            console.log(`Paso ${stepIndex} - Título:`, titulo ? titulo.textContent : 'NO ENCONTRADO');
            console.log(`Paso ${stepIndex} - Opciones:`, opciones.length);
            
        } else {
            console.error(`✗ No se encontró el paso wizard-step-${stepIndex}`);
            
            // Debug: Listar todos los pasos disponibles
            const allSteps = document.querySelectorAll('[id^="wizard-step-"]');
            console.log('Pasos disponibles:');
            allSteps.forEach(step => {
                console.log('- ID:', step.id, 'Display:', step.style.display);
            });
        }
        
        // Actualizar indicador de progreso
        actualizarProgresoMovil(stepIndex);
        
        // Actualizar botones del footer
        actualizarBotonesFooter(stepIndex);
        
        // Actualizar variable global
        window.currentWizardStep = stepIndex;
        
        console.log('=== FIN MOSTRAR PASO MÓVIL ===');
    }

    function actualizarProgresoMovil(stepIndex) {
        console.log('Actualizando progreso móvil, paso:', stepIndex);
        
        const circles = document.querySelectorAll('.step-circle');
        circles.forEach((circle, index) => {
            if (index < stepIndex) {
                // Pasos completados
                circle.style.background = '#28a745';
                circle.style.borderColor = '#28a745';
                circle.style.color = 'white';
                circle.innerHTML = '<i class="fas fa-check" style="font-size: 12px;"></i>';
            } else if (index === stepIndex) {
                // Paso actual
                circle.style.background = '#e97c1a';
                circle.style.borderColor = '#e97c1a';
                circle.style.color = 'white';
                circle.innerHTML = index + 1;
            } else {
                // Pasos pendientes
                circle.style.background = '#f8f9fa';
                circle.style.borderColor = '#dee2e6';
                circle.style.color = '#6c757d';
                circle.innerHTML = index + 1;
            }
        });
        
        // Actualizar display del paso actual
        const stepDisplay = document.getElementById('current-step-display');
        if (stepDisplay) {
            stepDisplay.textContent = stepIndex + 1;
        }
        
        window.currentWizardStep = stepIndex;
    }

    function actualizarBotonesFooter(stepIndex) {
        console.log('Actualizando botones footer para paso:', stepIndex);
        
        // Obtener producto actual para verificar opciones
        const producto = opcionesPorProducto[window.currentProductId];
        if (!producto || !producto.opciones || stepIndex >= producto.opciones.length) {
            console.error('No se puede actualizar footer - producto o paso inválido');
            return;
        }
        
        const opcionActual = producto.opciones[stepIndex];
        const esUltimoPaso = stepIndex === producto.opciones.length - 1;
        
        // Actualizar botón omitir
        const btnOmitir = document.getElementById('omitir-btn');
        if (btnOmitir) {
            if (opcionActual.obligatorio) {
                btnOmitir.style.display = 'none';
            } else {
                btnOmitir.style.display = 'inline-block';
                btnOmitir.onclick = () => omitirPreguntaWizard(stepIndex);
            }
        }
        
        // Actualizar botón continuar
        const btnContinuar = document.getElementById('main-continue-btn');
        if (btnContinuar) {
            // Cambiar texto según si es último paso
            if (esUltimoPaso) {
                btnContinuar.innerHTML = '<i class="fas fa-check me-1"></i>Agregar';
                btnContinuar.onclick = () => finalizarWizardMovil();
            } else {
                btnContinuar.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Continuar';
                btnContinuar.onclick = () => siguientePreguntaWizard(stepIndex);
            }
            
            // Deshabilitar si es obligatorio y no hay selección
            if (opcionActual.obligatorio) {
                btnContinuar.disabled = true;
                btnContinuar.style.opacity = '0.6';
            } else {
                btnContinuar.disabled = false;
                btnContinuar.style.opacity = '1';
            }
        }
        
        console.log('Botones footer actualizados:', {
            paso: stepIndex,
            esObligatorio: opcionActual.obligatorio,
            esUltimo: esUltimoPaso,
            omitirVisible: !opcionActual.obligatorio
        });
    }

    function seleccionarOpcionWizard(inputId, stepIndex) {
        console.log('Seleccionando opción wizard:', inputId, 'en paso:', stepIndex);
        
        const input = document.getElementById(inputId);
        if (!input) {
            console.error('Input no encontrado:', inputId);
            return;
        }
        
        const step = document.getElementById(`wizard-step-${stepIndex}`);
        const esObligatorio = step.getAttribute('data-obligatorio') === 'true';
        
        // Manejar selección según tipo de input
        if (input.type === 'radio') {
            // Deseleccionar otros radios del mismo grupo
            const otherRadios = document.querySelectorAll(`input[name="${input.name}"]`);
            otherRadios.forEach(radio => {
                radio.checked = false;
                const parentOption = radio.closest('.wizard-option');
                if (parentOption) {
                    parentOption.classList.remove('selected');
                    parentOption.style.borderColor = '#dee2e6';
                    parentOption.style.background = '#f8f9fa';
                    parentOption.style.transform = 'none';
                    parentOption.style.boxShadow = 'none';
                }
            });
            
            // Seleccionar el actual
            input.checked = true;
            const parentOption = input.closest('.wizard-option');
            if (parentOption) {
                parentOption.classList.add('selected');
                parentOption.style.borderColor = '#e97c1a';
                parentOption.style.background = 'rgba(233, 124, 26, 0.15)';
                parentOption.style.transform = 'scale(1.02)';
                parentOption.style.boxShadow = '0 4px 12px rgba(233, 124, 26, 0.3)';
            }
            
            // Habilitar botón continuar
            habilitarContinuarWizard(stepIndex);
            
        } else if (input.type === 'checkbox') {
            // Toggle checkbox
            input.checked = !input.checked;
            const parentOption = input.closest('.wizard-option');
            if (parentOption) {
                if (input.checked) {
                    parentOption.classList.add('selected');
                    parentOption.style.borderColor = '#e97c1a';
                    parentOption.style.background = 'rgba(233, 124, 26, 0.15)';
                    parentOption.style.transform = 'scale(1.02)';
                    parentOption.style.boxShadow = '0 4px 12px rgba(233, 124, 26, 0.3)';
                } else {
                    parentOption.classList.remove('selected');
                    parentOption.style.borderColor = '#dee2e6';
                    parentOption.style.background = '#f8f9fa';
                    parentOption.style.transform = 'none';
                    parentOption.style.boxShadow = 'none';
                }
            }
            
            // Verificar si hay alguna selección para habilitar continuar
            verificarSeleccionesWizardMovil(stepIndex);
        }
        
        console.log('Opción seleccionada correctamente');
    }

    function verificarSeleccionesWizardMovil(stepIndex) {
        const step = document.getElementById(`wizard-step-${stepIndex}`);
        const inputs = step.querySelectorAll('.wizard-input');
        const haySeleccion = Array.from(inputs).some(input => input.checked);
        
        const esObligatorio = step.getAttribute('data-obligatorio') === 'true';
        
        if (haySeleccion || !esObligatorio) {
            habilitarContinuarWizard(stepIndex);
        } else {
            deshabilitarContinuarWizard(stepIndex);
        }
    }

    function habilitarContinuarWizard(stepIndex) {
        // Habilitar el botón principal del footer
        const mainContinueBtn = document.getElementById('main-continue-btn');
        if (mainContinueBtn) {
            mainContinueBtn.disabled = false;
            mainContinueBtn.style.opacity = '1';
            console.log('Botón principal habilitado para paso:', stepIndex);
        }
    }

    function deshabilitarContinuarWizard(stepIndex) {
        // Deshabilitar el botón principal del footer
        const mainContinueBtn = document.getElementById('main-continue-btn');
        if (mainContinueBtn) {
            mainContinueBtn.disabled = true;
            mainContinueBtn.style.opacity = '0.6';
            console.log('Botón principal deshabilitado para paso:', stepIndex);
        }
    }

    function siguientePreguntaWizard(stepIndex) {
        console.log('Avanzando desde paso wizard', stepIndex, 'al paso', stepIndex + 1);
        
        // Actualizar progreso visual
        actualizarProgresoMovil(stepIndex + 1);
        
        if (stepIndex + 1 < window.wizardTotalSteps) {
            // Ir al siguiente paso
            mostrarPasoWizardMovil(stepIndex + 1);
        } else {
            // Último paso - finalizar wizard
            console.log('Último paso alcanzado, finalizando wizard');
            finalizarWizardMovil();
        }
    }

    function omitirPreguntaWizard(stepIndex) {
        console.log('Omitiendo paso wizard', stepIndex);
        
        // Limpiar selecciones del paso actual
        const step = document.getElementById(`wizard-step-${stepIndex}`);
        const inputs = step.querySelectorAll('.wizard-input');
        inputs.forEach(input => {
            input.checked = false;
            // Limpiar estilos visuales
            const parentOption = input.closest('.wizard-option');
            if (parentOption) {
                parentOption.classList.remove('selected');
                parentOption.style.borderColor = '#dee2e6';
                parentOption.style.background = '#f8f9fa';
                parentOption.style.transform = 'none';
                parentOption.style.boxShadow = 'none';
            }
        });
        
        // Avanzar al siguiente paso
        siguientePreguntaWizard(stepIndex);
    }

    function finalizarWizardMovil() {
        console.log('Finalizando wizard móvil');
        
        // Agregar al carrito
        agregarAlCarritoMovil();
    }

    // Función principal que decide qué modal mostrar
    function mostrarModal(id) {
        console.log('=== MOSTRAR MODAL INICIADO ===');
        console.log('ID del producto:', id);
        console.log('Tipo de ID:', typeof id);
        console.log('opcionesPorProducto disponibles:', Object.keys(opcionesPorProducto));
        
        // Verificar si el producto existe
        if (!opcionesPorProducto[id]) {
            console.error('❌ ERROR: Producto no encontrado para ID:', id);
            console.log('Productos disponibles:', opcionesPorProducto);
            alert('Error: Producto no encontrado. Revisa la consola para más detalles.');
            return;
        }
        
        // DETECTAR SI ES MÓVIL
        var esMobil = window.innerWidth <= 768;
        console.log('Detectado dispositivo - Es móvil:', esMobil, 'Ancho:', window.innerWidth);
        
        if (esMobil) {
            console.log('Usando sistema MÓVIL');
            mostrarModalMovil(id);
        } else {
            console.log('Usando sistema DESKTOP');
            mostrarModalDesktop(id);
        }
    }

    // ===== FUNCIONES PARA GESTIÓN DE ESTABLECIMIENTOS CON HORARIOS =====
    
    function seleccionarSucursal(sucursalId) {
        const establecimientoCard = document.querySelector(`[data-sucursal-id="${sucursalId}"]`);
        
        // Verificar si el establecimiento está disponible
        if (establecimientoCard && establecimientoCard.classList.contains('disabled')) {
            mostrarNotificacion('Este establecimiento no está disponible en este momento. Por favor elige otro establecimiento.', 'warning');
            return;
        }
        
        // Limpiar selección anterior
        document.querySelectorAll('.establecimiento-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        // Seleccionar nueva opción
        if (establecimientoCard && !establecimientoCard.classList.contains('disabled')) {
            establecimientoCard.classList.add('selected');
            
            // Marcar el radio button
            const radioButton = sucursalCard.querySelector('input[type="radio"]');
            if (radioButton && !radioButton.disabled) {
                radioButton.checked = true;
            }
        }
    }
    
    function mostrarNotificacion(mensaje, tipo = 'info') {
        // Crear elemento de notificación
        const notificacion = document.createElement('div');
        notificacion.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
        notificacion.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-radius: 10px;
        `;
        notificacion.innerHTML = `
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notificacion);
        
        // Auto-eliminar después de 3 segundos
        setTimeout(() => {
            if (notificacion && notificacion.parentNode) {
                notificacion.remove();
            }
        }, 3000);
    }
    
    function actualizarHoraActual() {
        // Función para mostrar la hora actual de México City en el modal
        const ahora = new Date();
        const opciones = {
            timeZone: 'America/Mexico_City',
            weekday: 'short',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true
        };
        
        const horaFormateada = ahora.toLocaleDateString('es-MX', opciones);
        
        // Buscar elementos donde mostrar la hora (si existen)
        const elementosHora = document.querySelectorAll('.hora-actual');
        elementosHora.forEach(elemento => {
            elemento.textContent = horaFormateada;
        });
    }
    
    // Actualizar hora cada minuto
    setInterval(actualizarHoraActual, 60000);
    actualizarHoraActual(); // Ejecutar inmediatamente
    
    // Función para mejorar la accesibilidad del modal de establecimientos
    function mejorarAccesibilidadModal() {
        const modal = document.getElementById('modalSucursal');
        if (modal) {
            modal.addEventListener('shown.bs.modal', function() {
                // Enfocar el primer radio button
                const primerRadio = modal.querySelector('input[type="radio"]');
                if (primerRadio) {
                    primerRadio.focus();
                }
            });
            
            // Navegación con teclado
            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    const sucursalSeleccionada = modal.querySelector('input[name="sucursal_radio"]:checked');
                    if (sucursalSeleccionada) {
                        document.getElementById('btnElegirSucursal').click();
                    }
                }
            });
        }
    }
    
    // Inicializar mejoras de accesibilidad
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🔧 Inicializando aplicación...');
        console.log('📊 Datos de establecimientos disponibles:', window.establecimientosData);
        
        mejorarAccesibilidadModal();
        
        // FORZAR validación inmediata con datos del servidor
        setTimeout(() => {
            console.log('⚡ Forzando actualización de badges...');
            validarSucursalesDisponibles();
        }, 100);
        
        inicializarHorarios();
        
        // Forzar validación inmediata con datos del servidor
        validarSucursalesDisponibles();
        
        // Añadir indicadores de estado a las tarjetas de establecimiento
        document.querySelectorAll('.establecimiento-option').forEach(card => {
            const badge = card.querySelector('.badge');
            if (badge) {
                if (badge.classList.contains('bg-success')) {
                    card.setAttribute('data-estado', 'abierta');
                } else if (badge.classList.contains('bg-warning')) {
                    card.setAttribute('data-estado', 'cerrada');
                } else if (badge.classList.contains('bg-danger')) {
                    card.setAttribute('data-estado', 'fuera-servicio');
                    card.classList.add('disabled');
                }
            }
        });
        
        console.log('✅ Inicialización completada');
    });
    
    // ===== FUNCIONES PARA MANEJO DE HORARIOS =====
    
    function inicializarHorarios() {
        actualizarHorariosHoy();
        marcarDiaActual();
        validarSucursalesDisponibles();
        
        // Actualizar cada minuto
        setInterval(() => {
            actualizarHorariosHoy();
            validarSucursalesDisponibles();
        }, 60000);
    }
    
    function actualizarHorariosHoy() {
        const ahora = new Date();
        const diaActual = ahora.getDay(); // 0=Domingo, 1=Lunes, etc.
        const diaIndex = diaActual === 0 ? 6 : diaActual - 1; // Convertir a 0=Lunes, 6=Domingo
        
        document.querySelectorAll('[id^="horario-hoy-"]').forEach(elemento => {
            const sucursalId = elemento.id.split('-')[2];
            const sucursalCard = document.querySelector(`[data-sucursal-id="${sucursalId}"]`);
            
            if (sucursalCard) {
                // Buscar el horario de hoy en la tabla
                const filaDiaActual = sucursalCard.querySelector(`[data-dia="${diaIndex}"]`);
                
                if (filaDiaActual) {
                    const horarioTexto = filaDiaActual.querySelector('td:last-child').textContent.trim();
                    const esCerrado = horarioTexto.includes('Cerrado');
                    
                    if (esCerrado) {
                        elemento.innerHTML = '<span class="text-danger">Cerrado</span>';
                    } else {
                        const horarioLimpio = horarioTexto.replace(/[🕐⏰]/g, '').trim();
                        elemento.innerHTML = `<span class="text-success tiempo-real">${horarioLimpio}</span>`;
                    }
                } else {
                    elemento.innerHTML = '<span class="text-muted">Sin horario</span>';
                }
            }
        });
    }
    
    function marcarDiaActual() {
        const ahora = new Date();
        const diaActual = ahora.getDay();
        const diaIndex = diaActual === 0 ? 6 : diaActual - 1;
        
        document.querySelectorAll('.horario-fila').forEach(fila => {
            const diaFila = parseInt(fila.getAttribute('data-dia'));
            if (diaFila === diaIndex) {
                fila.setAttribute('data-dia-actual', 'true');
                fila.style.background = 'rgba(33, 150, 243, 0.1)';
                fila.style.borderLeft = '3px solid #2196f3';
            }
        });
    }
    
    function validarSucursalesDisponibles() {
        console.log('🔍 Validando sucursales disponibles...');
        
        document.querySelectorAll('.sucursal-option').forEach(card => {
            const sucursalId = card.querySelector('input[type="radio"]').value;
            const badge = card.querySelector('.badge');
            const restriccion = card.querySelector('.restriccion-horario');
            const radioButton = card.querySelector('input[type="radio"]');
            
            // Obtener estado REAL de los datos del servidor
            const sucursalData = window.sucursalesData && window.sucursalesData[sucursalId];
            
            console.log(`📊 Sucursal ${sucursalId}:`, sucursalData);
            
            let esAbierta = false;
            let esActiva = true;
            
            if (sucursalData) {
                esAbierta = sucursalData.abierta_ahora;
                esActiva = sucursalData.activa;
                console.log(`✅ Datos del servidor - Sucursal ${sucursalId}: Activa=${esActiva}, Abierta=${esAbierta}`);
            } else {
                console.log(`❌ No se encontraron datos para sucursal ${sucursalId}`);
            }
            
            // FORZAR actualización del badge con datos reales
            if (badge) {
                badge.className = 'badge'; // Limpiar clases
                if (!esActiva) {
                    badge.classList.add('bg-danger');
                    badge.innerHTML = '<i class="fas fa-times-circle me-1"></i>Fuera de servicio';
                    console.log(`🔴 Sucursal ${sucursalId}: Fuera de servicio`);
                } else if (esAbierta) {
                    badge.classList.add('bg-success');
                    badge.innerHTML = '<i class="fas fa-check-circle me-1"></i>Abierta ahora';
                    console.log(`🟢 Sucursal ${sucursalId}: Abierta`);
                } else {
                    badge.classList.add('bg-warning', 'text-dark');
                    badge.innerHTML = '<i class="fas fa-clock me-1"></i>Cerrada ahora';
                    console.log(`🟡 Sucursal ${sucursalId}: Cerrada`);
                }
            }
            
            // Aplicar restricciones de UI
            if (!esAbierta || !esActiva) {
                card.classList.add('disabled');
                card.setAttribute('data-estado', 'cerrada');
                if (radioButton) {
                    radioButton.disabled = true;
                }
                if (restriccion) {
                    restriccion.style.display = 'block';
                }
                console.log(`🚫 Sucursal ${sucursalId}: Deshabilitada`);
            } else {
                card.classList.remove('disabled');
                card.setAttribute('data-estado', 'abierta');
                if (radioButton) {
                    radioButton.disabled = false;
                }
                if (restriccion) {
                    restriccion.style.display = 'none';
                }
                console.log(`✅ Sucursal ${sucursalId}: Habilitada`);
            }
        });
        
        console.log('🏁 Validación de sucursales completada');
    }
    
    // Validación adicional al intentar continuar
    function validarSucursalSeleccionada() {
        const sucursalSeleccionada = document.querySelector('input[name="sucursal_radio"]:checked');
        
        if (!sucursalSeleccionada) {
            mostrarNotificacion('Por favor selecciona una sucursal', 'warning');
            return false;
        }
        
        const sucursalCard = sucursalSeleccionada.closest('.sucursal-option');
        if (sucursalCard && sucursalCard.classList.contains('disabled')) {
            mostrarNotificacion('La sucursal seleccionada no está disponible. Por favor elige otra.', 'error');
            return false;
        }
        
        return true;
    }
    
    // ===== FUNCIONES ADICIONALES PARA COMPLETAR LA FUNCIONALIDAD =====
    
    // Función para filtrar productos por categoría
    window.filtrarPorCategoria = function(categoriaId) {
        console.log('🔍 Filtrando por categoría:', categoriaId);
        
        const productos = document.querySelectorAll('.producto-item');
        const botonesCategorias = document.querySelectorAll('.category-btn');
        
        // Actualizar botones activos
        botonesCategorias.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.categoria === categoriaId) {
                btn.classList.add('active');
            }
        });
        
        // Filtrar productos
        productos.forEach(producto => {
            const categoriaProducto = producto.dataset.categoria;
            
            if (categoriaId === 'todos' || categoriaProducto === categoriaId) {
                producto.style.display = 'block';
            } else {
                producto.style.display = 'none';
            }
        });
    };
    
    // Función para inicializar la aplicación cuando la página se carga
    document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Inicializando aplicación del catálogo...');
        
        // Verificar si ya hay una sucursal seleccionada
        const sucursalGuardada = localStorage.getItem('sucursal_id');
        console.log('🏪 Sucursal guardada:', sucursalGuardada);
        
        if (!sucursalGuardada) {
            console.log('📍 No hay sucursal seleccionada, mostrando modal...');
            const modalSucursal = new bootstrap.Modal(document.getElementById('modalSucursal'));
            modalSucursal.show();
        } else {
            console.log('✅ Sucursal ya seleccionada, continuando...');
            filtrarProductosPorSucursal(sucursalGuardada);
        }
        
        // Configurar eventos del modal de sucursal
        const btnElegirSucursal = document.getElementById('btnElegirSucursal');
        if (btnElegirSucursal) {
            btnElegirSucursal.addEventListener('click', function() {
                const sucursalSeleccionada = document.querySelector('input[name="sucursal_radio"]:checked');
                
                if (!sucursalSeleccionada) {
                    alert('Por favor selecciona una sucursal');
                    return;
                }
                
                const sucursalId = sucursalSeleccionada.value;
                localStorage.setItem('sucursal_id', sucursalId);
                
                // Cerrar modal
                const modalSucursal = bootstrap.Modal.getInstance(document.getElementById('modalSucursal'));
                modalSucursal.hide();
                
                // Filtrar productos
                filtrarProductosPorSucursal(sucursalId);
                
                console.log('✅ Sucursal seleccionada:', sucursalId);
            });
        }
        
        // Inicializar horarios y validaciones
        inicializarHorarios();
        validarSucursalesDisponibles();
        mejorarAccesibilidadModal();
    });
    
    // Función para filtrar productos por sucursal
    function filtrarProductosPorSucursal(sucursalId) {
        console.log('🏪 Filtrando productos para sucursal:', sucursalId);
        
        const productos = document.querySelectorAll('.producto-item');
        productos.forEach(producto => {
            const sucursalesDisponibles = producto.dataset.sucursales.split(',');
            
            if (sucursalesDisponibles.includes(sucursalId)) {
                producto.style.display = 'block';
            } else {
                producto.style.display = 'none';
            }
        });
        
        // Actualizar contadores de categorías
        actualizarContadoresCategorias();
    }
    
    // Función para actualizar contadores de categorías
    function actualizarContadoresCategorias() {
        const categorias = document.querySelectorAll('.category-btn');
        
        categorias.forEach(categoria => {
            const categoriaId = categoria.dataset.categoria;
            let contador = 0;
            
            if (categoriaId === 'todos') {
                contador = document.querySelectorAll('.producto-item[style*="block"], .producto-item:not([style*="none"])').length;
            } else {
                contador = document.querySelectorAll(`.producto-item[data-categoria="${categoriaId}"][style*="block"], .producto-item[data-categoria="${categoriaId}"]:not([style*="none"])`).length;
            }
            
            const badge = categoria.querySelector('.category-count');
            if (badge) {
                badge.textContent = contador;
            }
        });
    }
    
    // Función para inicializar horarios
    function inicializarHorarios() {
        console.log('⏰ Inicializando sistema de horarios...');
        
        // Configurar datos de sucursales si no existen
        if (typeof window.sucursalesData === 'undefined') {
            window.sucursalesData = {};
            
            // Extraer datos del template
            {% if sucursales %}
            {% for s in sucursales %}
            window.sucursalesData[{{ s.id }}] = {
                id: {{ s.id }},
                nombre: "{{ s.nombre }}",
                activa: {{ s.activa|lower }},
                abierta_ahora: {{ s.abierta_ahora|lower }}
            };
            {% endfor %}
            {% endif %}
        }
        
        console.log('📊 Datos de sucursales configurados:', window.sucursalesData);
        
        // Actualizar horarios de hoy
        actualizarHorarioHoy();
        marcarDiaActual();
    }
    
    console.log('✅ Sistema de catálogo completamente inicializado');
</script>
{% endblock %}